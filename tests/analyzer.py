#!/usr/bin/env python3

import sys
import json
import os
import argparse
import imp
import base64

tabulate_s = base64.b64decode(b'IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiMgZG93bmxvYWRlZCBmcm9tIGh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9hc3RhbmluL3B5dGhvbi10YWJ1bGF0ZS9tYXN0ZXIvdGFidWxhdGUucHkKCiIiIlByZXR0eS1wcmludCB0YWJ1bGFyIGRhdGEuIiIiCgpmcm9tIF9fZnV0dXJlX18gaW1wb3J0IHByaW50X2Z1bmN0aW9uCmZyb20gX19mdXR1cmVfXyBpbXBvcnQgdW5pY29kZV9saXRlcmFscwpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBuYW1lZHR1cGxlCmltcG9ydCBzeXMKaW1wb3J0IHJlCmltcG9ydCBtYXRoCmltcG9ydCB0ZXh0d3JhcAoKCmlmIHN5cy52ZXJzaW9uX2luZm8gPj0gKDMsIDMpOgogICAgZnJvbSBjb2xsZWN0aW9ucy5hYmMgaW1wb3J0IEl0ZXJhYmxlCmVsc2U6CiAgICBmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBJdGVyYWJsZQoKaWYgc3lzLnZlcnNpb25faW5mb1swXSA8IDM6CiAgICBmcm9tIGl0ZXJ0b29scyBpbXBvcnQgaXppcF9sb25nZXN0CiAgICBmcm9tIGZ1bmN0b29scyBpbXBvcnQgcGFydGlhbAoKICAgIF9ub25lX3R5cGUgPSB0eXBlKE5vbmUpCiAgICBfYm9vbF90eXBlID0gYm9vbAogICAgX2ludF90eXBlID0gaW50CiAgICBfbG9uZ190eXBlID0gbG9uZyAgIyBub3FhCiAgICBfZmxvYXRfdHlwZSA9IGZsb2F0CiAgICBfdGV4dF90eXBlID0gdW5pY29kZSAgIyBub3FhCiAgICBfYmluYXJ5X3R5cGUgPSBzdHIKCiAgICBkZWYgX2lzX2ZpbGUoZik6CiAgICAgICAgcmV0dXJuIGhhc2F0dHIoZiwgInJlYWQiKQoKCmVsc2U6CiAgICBmcm9tIGl0ZXJ0b29scyBpbXBvcnQgemlwX2xvbmdlc3QgYXMgaXppcF9sb25nZXN0CiAgICBmcm9tIGZ1bmN0b29scyBpbXBvcnQgcmVkdWNlLCBwYXJ0aWFsCgogICAgX25vbmVfdHlwZSA9IHR5cGUoTm9uZSkKICAgIF9ib29sX3R5cGUgPSBib29sCiAgICBfaW50X3R5cGUgPSBpbnQKICAgIF9sb25nX3R5cGUgPSBpbnQKICAgIF9mbG9hdF90eXBlID0gZmxvYXQKICAgIF90ZXh0X3R5cGUgPSBzdHIKICAgIF9iaW5hcnlfdHlwZSA9IGJ5dGVzCiAgICBiYXNlc3RyaW5nID0gc3RyCgogICAgaW1wb3J0IGlvCgogICAgZGVmIF9pc19maWxlKGYpOgogICAgICAgIHJldHVybiBpc2luc3RhbmNlKGYsIGlvLklPQmFzZSkKCgp0cnk6CiAgICBpbXBvcnQgd2N3aWR0aCAgIyBvcHRpb25hbCB3aWRlLWNoYXJhY3RlciAoQ0pLKSBzdXBwb3J0CmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIHdjd2lkdGggPSBOb25lCgp0cnk6CiAgICBmcm9tIGh0bWwgaW1wb3J0IGVzY2FwZSBhcyBodG1sZXNjYXBlCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGZyb20gY2dpIGltcG9ydCBlc2NhcGUgYXMgaHRtbGVzY2FwZQoKCl9fYWxsX18gPSBbInRhYnVsYXRlIiwgInRhYnVsYXRlX2Zvcm1hdHMiLCAic2ltcGxlX3NlcGFyYXRlZF9mb3JtYXQiXQpfX3ZlcnNpb25fXyA9ICIwLjguMTAiCgoKIyBtaW5pbXVtIGV4dHJhIHNwYWNlIGluIGhlYWRlcnMKTUlOX1BBRERJTkcgPSAyCgojIFdoZXRoZXIgb3Igbm90IHRvIHByZXNlcnZlIGxlYWRpbmcvdHJhaWxpbmcgd2hpdGVzcGFjZSBpbiBkYXRhLgpQUkVTRVJWRV9XSElURVNQQUNFID0gRmFsc2UKCl9ERUZBVUxUX0ZMT0FURk1UID0gImciCl9ERUZBVUxUX01JU1NJTkdWQUwgPSAiIgojIGRlZmF1bHQgYWxpZ24gd2lsbCBiZSBvdmVyd3JpdHRlbiBieSAibGVmdCIsICJjZW50ZXIiIG9yICJkZWNpbWFsIgojIGRlcGVuZGluZyBvbiB0aGUgZm9ybWF0dGVyCl9ERUZBVUxUX0FMSUdOID0gImRlZmF1bHQiCgoKIyBpZiBUcnVlLCBlbmFibGUgd2lkZS1jaGFyYWN0ZXIgKENKSykgc3VwcG9ydApXSURFX0NIQVJTX01PREUgPSB3Y3dpZHRoIGlzIG5vdCBOb25lCgoKTGluZSA9IG5hbWVkdHVwbGUoIkxpbmUiLCBbImJlZ2luIiwgImhsaW5lIiwgInNlcCIsICJlbmQiXSkKCgpEYXRhUm93ID0gbmFtZWR0dXBsZSgiRGF0YVJvdyIsIFsiYmVnaW4iLCAic2VwIiwgImVuZCJdKQoKCiMgQSB0YWJsZSBzdHJ1Y3R1cmUgaXMgc3VwcHBvc2VkIHRvIGJlOgojCiMgICAgIC0tLSBsaW5lYWJvdmUgLS0tLS0tLS0tCiMgICAgICAgICBoZWFkZXJyb3cKIyAgICAgLS0tIGxpbmViZWxvd2hlYWRlciAtLS0KIyAgICAgICAgIGRhdGFyb3cKIyAgICAgLS0tIGxpbmViZXR3ZWVucm93cyAtLS0KIyAgICAgLi4uIChtb3JlIGRhdGFyb3dzKSAuLi4KIyAgICAgLS0tIGxpbmViZXR3ZWVucm93cyAtLS0KIyAgICAgICAgIGxhc3QgZGF0YXJvdwojICAgICAtLS0gbGluZWJlbG93IC0tLS0tLS0tLQojCiMgVGFibGVGb3JtYXQncyBsaW5lKiBlbGVtZW50cyBjYW4gYmUKIwojICAgLSBlaXRoZXIgTm9uZSwgaWYgdGhlIGVsZW1lbnQgaXMgbm90IHVzZWQsCiMgICAtIG9yIGEgTGluZSB0dXBsZSwKIyAgIC0gb3IgYSBmdW5jdGlvbjogW2NvbF93aWR0aHNdLCBbY29sX2FsaWdubWVudHNdIC0+IHN0cmluZy4KIwojIFRhYmxlRm9ybWF0J3MgKnJvdyBlbGVtZW50cyBjYW4gYmUKIwojICAgLSBlaXRoZXIgTm9uZSwgaWYgdGhlIGVsZW1lbnQgaXMgbm90IHVzZWQsCiMgICAtIG9yIGEgRGF0YVJvdyB0dXBsZSwKIyAgIC0gb3IgYSBmdW5jdGlvbjogW2NlbGxfdmFsdWVzXSwgW2NvbF93aWR0aHNdLCBbY29sX2FsaWdubWVudHNdIC0+IHN0cmluZy4KIwojIHBhZGRpbmcgKGFuIGludGVnZXIpIGlzIHRoZSBhbW91bnQgb2Ygd2hpdGUgc3BhY2UgYXJvdW5kIGRhdGEgdmFsdWVzLgojCiMgd2l0aF9oZWFkZXJfaGlkZToKIwojICAgLSBlaXRoZXIgTm9uZSwgdG8gZGlzcGxheSBhbGwgdGFibGUgZWxlbWVudHMgdW5jb25kaXRpb25hbGx5LAojICAgLSBvciBhIGxpc3Qgb2YgZWxlbWVudHMgbm90IHRvIGJlIGRpc3BsYXllZCBpZiB0aGUgdGFibGUgaGFzIGNvbHVtbiBoZWFkZXJzLgojClRhYmxlRm9ybWF0ID0gbmFtZWR0dXBsZSgKICAgICJUYWJsZUZvcm1hdCIsCiAgICBbCiAgICAgICAgImxpbmVhYm92ZSIsCiAgICAgICAgImxpbmViZWxvd2hlYWRlciIsCiAgICAgICAgImxpbmViZXR3ZWVucm93cyIsCiAgICAgICAgImxpbmViZWxvdyIsCiAgICAgICAgImhlYWRlcnJvdyIsCiAgICAgICAgImRhdGFyb3ciLAogICAgICAgICJwYWRkaW5nIiwKICAgICAgICAid2l0aF9oZWFkZXJfaGlkZSIsCiAgICBdLAopCgoKZGVmIF9waXBlX3NlZ21lbnRfd2l0aF9jb2xvbnMoYWxpZ24sIGNvbHdpZHRoKToKICAgICIiIlJldHVybiBhIHNlZ21lbnQgb2YgYSBob3Jpem9udGFsIGxpbmUgd2l0aCBvcHRpb25hbCBjb2xvbnMgd2hpY2gKICAgIGluZGljYXRlIGNvbHVtbidzIGFsaWdubWVudCAoYXMgaW4gYHBpcGVgIG91dHB1dCBmb3JtYXQpLiIiIgogICAgdyA9IGNvbHdpZHRoCiAgICBpZiBhbGlnbiBpbiBbInJpZ2h0IiwgImRlY2ltYWwiXToKICAgICAgICByZXR1cm4gKCItIiAqICh3IC0gMSkpICsgIjoiCiAgICBlbGlmIGFsaWduID09ICJjZW50ZXIiOgogICAgICAgIHJldHVybiAiOiIgKyAoIi0iICogKHcgLSAyKSkgKyAiOiIKICAgIGVsaWYgYWxpZ24gPT0gImxlZnQiOgogICAgICAgIHJldHVybiAiOiIgKyAoIi0iICogKHcgLSAxKSkKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuICItIiAqIHcKCgpkZWYgX3BpcGVfbGluZV93aXRoX2NvbG9ucyhjb2x3aWR0aHMsIGNvbGFsaWducyk6CiAgICAiIiJSZXR1cm4gYSBob3Jpem9udGFsIGxpbmUgd2l0aCBvcHRpb25hbCBjb2xvbnMgdG8gaW5kaWNhdGUgY29sdW1uJ3MKICAgIGFsaWdubWVudCAoYXMgaW4gYHBpcGVgIG91dHB1dCBmb3JtYXQpLiIiIgogICAgaWYgbm90IGNvbGFsaWduczogICMgZS5nLiBwcmludGluZyBhbiBlbXB0eSBkYXRhIGZyYW1lIChnaXRodWIgaXNzdWUgIzE1KQogICAgICAgIGNvbGFsaWducyA9IFsiIl0gKiBsZW4oY29sd2lkdGhzKQogICAgc2VnbWVudHMgPSBbX3BpcGVfc2VnbWVudF93aXRoX2NvbG9ucyhhLCB3KSBmb3IgYSwgdyBpbiB6aXAoY29sYWxpZ25zLCBjb2x3aWR0aHMpXQogICAgcmV0dXJuICJ8IiArICJ8Ii5qb2luKHNlZ21lbnRzKSArICJ8IgoKCmRlZiBfbWVkaWF3aWtpX3Jvd193aXRoX2F0dHJzKHNlcGFyYXRvciwgY2VsbF92YWx1ZXMsIGNvbHdpZHRocywgY29sYWxpZ25zKToKICAgIGFsaWdubWVudCA9IHsKICAgICAgICAibGVmdCI6ICIiLAogICAgICAgICJyaWdodCI6ICdhbGlnbj0icmlnaHQifCAnLAogICAgICAgICJjZW50ZXIiOiAnYWxpZ249ImNlbnRlciJ8ICcsCiAgICAgICAgImRlY2ltYWwiOiAnYWxpZ249InJpZ2h0InwgJywKICAgIH0KICAgICMgaGFyZC1jb2RlZCBwYWRkaW5nIF9hcm91bmRfIGFsaWduIGF0dHJpYnV0ZSBhbmQgdmFsdWUgdG9nZXRoZXIKICAgICMgcmF0aGVyIHRoYW4gcGFkZGluZyBwYXJhbWV0ZXIgd2hpY2ggYWZmZWN0cyBvbmx5IHRoZSB2YWx1ZQogICAgdmFsdWVzX3dpdGhfYXR0cnMgPSBbCiAgICAgICAgIiAiICsgYWxpZ25tZW50LmdldChhLCAiIikgKyBjICsgIiAiIGZvciBjLCBhIGluIHppcChjZWxsX3ZhbHVlcywgY29sYWxpZ25zKQogICAgXQogICAgY29sc2VwID0gc2VwYXJhdG9yICogMgogICAgcmV0dXJuIChzZXBhcmF0b3IgKyBjb2xzZXAuam9pbih2YWx1ZXNfd2l0aF9hdHRycykpLnJzdHJpcCgpCgoKZGVmIF90ZXh0aWxlX3Jvd193aXRoX2F0dHJzKGNlbGxfdmFsdWVzLCBjb2x3aWR0aHMsIGNvbGFsaWducyk6CiAgICBjZWxsX3ZhbHVlc1swXSArPSAiICIKICAgIGFsaWdubWVudCA9IHsibGVmdCI6ICI8LiIsICJyaWdodCI6ICI+LiIsICJjZW50ZXIiOiAiPS4iLCAiZGVjaW1hbCI6ICI+LiJ9CiAgICB2YWx1ZXMgPSAoYWxpZ25tZW50LmdldChhLCAiIikgKyB2IGZvciBhLCB2IGluIHppcChjb2xhbGlnbnMsIGNlbGxfdmFsdWVzKSkKICAgIHJldHVybiAifCIgKyAifCIuam9pbih2YWx1ZXMpICsgInwiCgoKZGVmIF9odG1sX2JlZ2luX3RhYmxlX3dpdGhvdXRfaGVhZGVyKGNvbHdpZHRoc19pZ25vcmUsIGNvbGFsaWduc19pZ25vcmUpOgogICAgIyB0aGlzIHRhYmxlIGhlYWRlciB3aWxsIGJlIHN1cHByZXNzZWQgaWYgdGhlcmUgaXMgYSBoZWFkZXIgcm93CiAgICByZXR1cm4gIjx0YWJsZT5cbjx0Ym9keT4iCgoKZGVmIF9odG1sX3Jvd193aXRoX2F0dHJzKGNlbGx0YWcsIHVuc2FmZSwgY2VsbF92YWx1ZXMsIGNvbHdpZHRocywgY29sYWxpZ25zKToKICAgIGFsaWdubWVudCA9IHsKICAgICAgICAibGVmdCI6ICIiLAogICAgICAgICJyaWdodCI6ICcgc3R5bGU9InRleHQtYWxpZ246IHJpZ2h0OyInLAogICAgICAgICJjZW50ZXIiOiAnIHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IicsCiAgICAgICAgImRlY2ltYWwiOiAnIHN0eWxlPSJ0ZXh0LWFsaWduOiByaWdodDsiJywKICAgIH0KICAgIGlmIHVuc2FmZToKICAgICAgICB2YWx1ZXNfd2l0aF9hdHRycyA9IFsKICAgICAgICAgICAgIjx7MH17MX0+ezJ9PC97MH0+Ii5mb3JtYXQoY2VsbHRhZywgYWxpZ25tZW50LmdldChhLCAiIiksIGMpCiAgICAgICAgICAgIGZvciBjLCBhIGluIHppcChjZWxsX3ZhbHVlcywgY29sYWxpZ25zKQogICAgICAgIF0KICAgIGVsc2U6CiAgICAgICAgdmFsdWVzX3dpdGhfYXR0cnMgPSBbCiAgICAgICAgICAgICI8ezB9ezF9PnsyfTwvezB9PiIuZm9ybWF0KGNlbGx0YWcsIGFsaWdubWVudC5nZXQoYSwgIiIpLCBodG1sZXNjYXBlKGMpKQogICAgICAgICAgICBmb3IgYywgYSBpbiB6aXAoY2VsbF92YWx1ZXMsIGNvbGFsaWducykKICAgICAgICBdCiAgICByb3dodG1sID0gIjx0cj57fTwvdHI+Ii5mb3JtYXQoIiIuam9pbih2YWx1ZXNfd2l0aF9hdHRycykucnN0cmlwKCkpCiAgICBpZiBjZWxsdGFnID09ICJ0aCI6ICAjIGl0J3MgYSBoZWFkZXIgcm93LCBjcmVhdGUgYSBuZXcgdGFibGUgaGVhZGVyCiAgICAgICAgcm93aHRtbCA9ICI8dGFibGU+XG48dGhlYWQ+XG57fVxuPC90aGVhZD5cbjx0Ym9keT4iLmZvcm1hdChyb3dodG1sKQogICAgcmV0dXJuIHJvd2h0bWwKCgpkZWYgX21vaW5fcm93X3dpdGhfYXR0cnMoY2VsbHRhZywgY2VsbF92YWx1ZXMsIGNvbHdpZHRocywgY29sYWxpZ25zLCBoZWFkZXI9IiIpOgogICAgYWxpZ25tZW50ID0gewogICAgICAgICJsZWZ0IjogIiIsCiAgICAgICAgInJpZ2h0IjogJzxzdHlsZT0idGV4dC1hbGlnbjogcmlnaHQ7Ij4nLAogICAgICAgICJjZW50ZXIiOiAnPHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7Ij4nLAogICAgICAgICJkZWNpbWFsIjogJzxzdHlsZT0idGV4dC1hbGlnbjogcmlnaHQ7Ij4nLAogICAgfQogICAgdmFsdWVzX3dpdGhfYXR0cnMgPSBbCiAgICAgICAgInswfXsxfSB7Mn0gIi5mb3JtYXQoY2VsbHRhZywgYWxpZ25tZW50LmdldChhLCAiIiksIGhlYWRlciArIGMgKyBoZWFkZXIpCiAgICAgICAgZm9yIGMsIGEgaW4gemlwKGNlbGxfdmFsdWVzLCBjb2xhbGlnbnMpCiAgICBdCiAgICByZXR1cm4gIiIuam9pbih2YWx1ZXNfd2l0aF9hdHRycykgKyAifHwiCgoKZGVmIF9sYXRleF9saW5lX2JlZ2luX3RhYnVsYXIoY29sd2lkdGhzLCBjb2xhbGlnbnMsIGJvb2t0YWJzPUZhbHNlLCBsb25ndGFibGU9RmFsc2UpOgogICAgYWxpZ25tZW50ID0geyJsZWZ0IjogImwiLCAicmlnaHQiOiAiciIsICJjZW50ZXIiOiAiYyIsICJkZWNpbWFsIjogInIifQogICAgdGFidWxhcl9jb2x1bW5zX2ZtdCA9ICIiLmpvaW4oW2FsaWdubWVudC5nZXQoYSwgImwiKSBmb3IgYSBpbiBjb2xhbGlnbnNdKQogICAgcmV0dXJuICJcbiIuam9pbigKICAgICAgICBbCiAgICAgICAgICAgICgiXFxiZWdpbnt0YWJ1bGFyfXsiIGlmIG5vdCBsb25ndGFibGUgZWxzZSAiXFxiZWdpbntsb25ndGFibGV9eyIpCiAgICAgICAgICAgICsgdGFidWxhcl9jb2x1bW5zX2ZtdAogICAgICAgICAgICArICJ9IiwKICAgICAgICAgICAgIlxcdG9wcnVsZSIgaWYgYm9va3RhYnMgZWxzZSAiXFxobGluZSIsCiAgICAgICAgXQogICAgKQoKCkxBVEVYX0VTQ0FQRV9SVUxFUyA9IHsKICAgIHIiJiI6IHIiXCYiLAogICAgciIlIjogciJcJSIsCiAgICByIiQiOiByIlwkIiwKICAgIHIiIyI6IHIiXCMiLAogICAgciJfIjogciJcXyIsCiAgICByIl4iOiByIlxee30iLAogICAgciJ7IjogciJceyIsCiAgICByIn0iOiByIlx9IiwKICAgIHIifiI6IHIiXHRleHRhc2NpaXRpbGRle30iLAogICAgIlxcIjogciJcdGV4dGJhY2tzbGFzaHt9IiwKICAgIHIiPCI6IHIiXGVuc3VyZW1hdGh7PH0iLAogICAgciI+IjogciJcZW5zdXJlbWF0aHs+fSIsCn0KCgpkZWYgX2xhdGV4X3JvdyhjZWxsX3ZhbHVlcywgY29sd2lkdGhzLCBjb2xhbGlnbnMsIGVzY3J1bGVzPUxBVEVYX0VTQ0FQRV9SVUxFUyk6CiAgICBkZWYgZXNjYXBlX2NoYXIoYyk6CiAgICAgICAgcmV0dXJuIGVzY3J1bGVzLmdldChjLCBjKQoKICAgIGVzY2FwZWRfdmFsdWVzID0gWyIiLmpvaW4obWFwKGVzY2FwZV9jaGFyLCBjZWxsKSkgZm9yIGNlbGwgaW4gY2VsbF92YWx1ZXNdCiAgICByb3dmbXQgPSBEYXRhUm93KCIiLCAiJiIsICJcXFxcIikKICAgIHJldHVybiBfYnVpbGRfc2ltcGxlX3Jvdyhlc2NhcGVkX3ZhbHVlcywgcm93Zm10KQoKCmRlZiBfcnN0X2VzY2FwZV9maXJzdF9jb2x1bW4ocm93cywgaGVhZGVycyk6CiAgICBkZWYgZXNjYXBlX2VtcHR5KHZhbCk6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWwsIChfdGV4dF90eXBlLCBfYmluYXJ5X3R5cGUpKSBhbmQgbm90IHZhbC5zdHJpcCgpOgogICAgICAgICAgICByZXR1cm4gIi4uIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiB2YWwKCiAgICBuZXdfaGVhZGVycyA9IGxpc3QoaGVhZGVycykKICAgIG5ld19yb3dzID0gW10KICAgIGlmIGhlYWRlcnM6CiAgICAgICAgbmV3X2hlYWRlcnNbMF0gPSBlc2NhcGVfZW1wdHkoaGVhZGVyc1swXSkKICAgIGZvciByb3cgaW4gcm93czoKICAgICAgICBuZXdfcm93ID0gbGlzdChyb3cpCiAgICAgICAgaWYgbmV3X3JvdzoKICAgICAgICAgICAgbmV3X3Jvd1swXSA9IGVzY2FwZV9lbXB0eShyb3dbMF0pCiAgICAgICAgbmV3X3Jvd3MuYXBwZW5kKG5ld19yb3cpCiAgICByZXR1cm4gbmV3X3Jvd3MsIG5ld19oZWFkZXJzCgoKX3RhYmxlX2Zvcm1hdHMgPSB7CiAgICAic2ltcGxlIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPUxpbmUoIiIsICItIiwgIiAgIiwgIiIpLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj1MaW5lKCIiLCAiLSIsICIgICIsICIiKSwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9Tm9uZSwKICAgICAgICBsaW5lYmVsb3c9TGluZSgiIiwgIi0iLCAiICAiLCAiIiksCiAgICAgICAgaGVhZGVycm93PURhdGFSb3coIiIsICIgICIsICIiKSwKICAgICAgICBkYXRhcm93PURhdGFSb3coIiIsICIgICIsICIiKSwKICAgICAgICBwYWRkaW5nPTAsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1bImxpbmVhYm92ZSIsICJsaW5lYmVsb3ciXSwKICAgICksCiAgICAicGxhaW4iOiBUYWJsZUZvcm1hdCgKICAgICAgICBsaW5lYWJvdmU9Tm9uZSwKICAgICAgICBsaW5lYmVsb3doZWFkZXI9Tm9uZSwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9Tm9uZSwKICAgICAgICBsaW5lYmVsb3c9Tm9uZSwKICAgICAgICBoZWFkZXJyb3c9RGF0YVJvdygiIiwgIiAgIiwgIiIpLAogICAgICAgIGRhdGFyb3c9RGF0YVJvdygiIiwgIiAgIiwgIiIpLAogICAgICAgIHBhZGRpbmc9MCwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAogICAgImdyaWQiOiBUYWJsZUZvcm1hdCgKICAgICAgICBsaW5lYWJvdmU9TGluZSgiKyIsICItIiwgIisiLCAiKyIpLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj1MaW5lKCIrIiwgIj0iLCAiKyIsICIrIiksCiAgICAgICAgbGluZWJldHdlZW5yb3dzPUxpbmUoIisiLCAiLSIsICIrIiwgIisiKSwKICAgICAgICBsaW5lYmVsb3c9TGluZSgiKyIsICItIiwgIisiLCAiKyIpLAogICAgICAgIGhlYWRlcnJvdz1EYXRhUm93KCJ8IiwgInwiLCAifCIpLAogICAgICAgIGRhdGFyb3c9RGF0YVJvdygifCIsICJ8IiwgInwiKSwKICAgICAgICBwYWRkaW5nPTEsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKSwKICAgICJmYW5jeV9ncmlkIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPUxpbmUoIuKVkiIsICLilZAiLCAi4pWkIiwgIuKVlSIpLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj1MaW5lKCLilZ4iLCAi4pWQIiwgIuKVqiIsICLilaEiKSwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9TGluZSgi4pScIiwgIuKUgCIsICLilLwiLCAi4pSkIiksCiAgICAgICAgbGluZWJlbG93PUxpbmUoIuKVmCIsICLilZAiLCAi4pWnIiwgIuKVmyIpLAogICAgICAgIGhlYWRlcnJvdz1EYXRhUm93KCLilIIiLCAi4pSCIiwgIuKUgiIpLAogICAgICAgIGRhdGFyb3c9RGF0YVJvdygi4pSCIiwgIuKUgiIsICLilIIiKSwKICAgICAgICBwYWRkaW5nPTEsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKSwKICAgICJmYW5jeV9vdXRsaW5lIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPUxpbmUoIuKVkiIsICLilZAiLCAi4pWkIiwgIuKVlSIpLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj1MaW5lKCLilZ4iLCAi4pWQIiwgIuKVqiIsICLilaEiKSwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9Tm9uZSwKICAgICAgICBsaW5lYmVsb3c9TGluZSgi4pWYIiwgIuKVkCIsICLilaciLCAi4pWbIiksCiAgICAgICAgaGVhZGVycm93PURhdGFSb3coIuKUgiIsICLilIIiLCAi4pSCIiksCiAgICAgICAgZGF0YXJvdz1EYXRhUm93KCLilIIiLCAi4pSCIiwgIuKUgiIpLAogICAgICAgIHBhZGRpbmc9MSwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAogICAgImdpdGh1YiI6IFRhYmxlRm9ybWF0KAogICAgICAgIGxpbmVhYm92ZT1MaW5lKCJ8IiwgIi0iLCAifCIsICJ8IiksCiAgICAgICAgbGluZWJlbG93aGVhZGVyPUxpbmUoInwiLCAiLSIsICJ8IiwgInwiKSwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9Tm9uZSwKICAgICAgICBsaW5lYmVsb3c9Tm9uZSwKICAgICAgICBoZWFkZXJyb3c9RGF0YVJvdygifCIsICJ8IiwgInwiKSwKICAgICAgICBkYXRhcm93PURhdGFSb3coInwiLCAifCIsICJ8IiksCiAgICAgICAgcGFkZGluZz0xLAogICAgICAgIHdpdGhfaGVhZGVyX2hpZGU9WyJsaW5lYWJvdmUiXSwKICAgICksCiAgICAicGlwZSI6IFRhYmxlRm9ybWF0KAogICAgICAgIGxpbmVhYm92ZT1fcGlwZV9saW5lX3dpdGhfY29sb25zLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj1fcGlwZV9saW5lX3dpdGhfY29sb25zLAogICAgICAgIGxpbmViZXR3ZWVucm93cz1Ob25lLAogICAgICAgIGxpbmViZWxvdz1Ob25lLAogICAgICAgIGhlYWRlcnJvdz1EYXRhUm93KCJ8IiwgInwiLCAifCIpLAogICAgICAgIGRhdGFyb3c9RGF0YVJvdygifCIsICJ8IiwgInwiKSwKICAgICAgICBwYWRkaW5nPTEsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1bImxpbmVhYm92ZSJdLAogICAgKSwKICAgICJvcmd0YmwiOiBUYWJsZUZvcm1hdCgKICAgICAgICBsaW5lYWJvdmU9Tm9uZSwKICAgICAgICBsaW5lYmVsb3doZWFkZXI9TGluZSgifCIsICItIiwgIisiLCAifCIpLAogICAgICAgIGxpbmViZXR3ZWVucm93cz1Ob25lLAogICAgICAgIGxpbmViZWxvdz1Ob25lLAogICAgICAgIGhlYWRlcnJvdz1EYXRhUm93KCJ8IiwgInwiLCAifCIpLAogICAgICAgIGRhdGFyb3c9RGF0YVJvdygifCIsICJ8IiwgInwiKSwKICAgICAgICBwYWRkaW5nPTEsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKSwKICAgICJqaXJhIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPU5vbmUsCiAgICAgICAgbGluZWJlbG93aGVhZGVyPU5vbmUsCiAgICAgICAgbGluZWJldHdlZW5yb3dzPU5vbmUsCiAgICAgICAgbGluZWJlbG93PU5vbmUsCiAgICAgICAgaGVhZGVycm93PURhdGFSb3coInx8IiwgInx8IiwgInx8IiksCiAgICAgICAgZGF0YXJvdz1EYXRhUm93KCJ8IiwgInwiLCAifCIpLAogICAgICAgIHBhZGRpbmc9MSwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAogICAgInByZXN0byI6IFRhYmxlRm9ybWF0KAogICAgICAgIGxpbmVhYm92ZT1Ob25lLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj1MaW5lKCIiLCAiLSIsICIrIiwgIiIpLAogICAgICAgIGxpbmViZXR3ZWVucm93cz1Ob25lLAogICAgICAgIGxpbmViZWxvdz1Ob25lLAogICAgICAgIGhlYWRlcnJvdz1EYXRhUm93KCIiLCAifCIsICIiKSwKICAgICAgICBkYXRhcm93PURhdGFSb3coIiIsICJ8IiwgIiIpLAogICAgICAgIHBhZGRpbmc9MSwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAogICAgInByZXR0eSI6IFRhYmxlRm9ybWF0KAogICAgICAgIGxpbmVhYm92ZT1MaW5lKCIrIiwgIi0iLCAiKyIsICIrIiksCiAgICAgICAgbGluZWJlbG93aGVhZGVyPUxpbmUoIisiLCAiLSIsICIrIiwgIisiKSwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9Tm9uZSwKICAgICAgICBsaW5lYmVsb3c9TGluZSgiKyIsICItIiwgIisiLCAiKyIpLAogICAgICAgIGhlYWRlcnJvdz1EYXRhUm93KCJ8IiwgInwiLCAifCIpLAogICAgICAgIGRhdGFyb3c9RGF0YVJvdygifCIsICJ8IiwgInwiKSwKICAgICAgICBwYWRkaW5nPTEsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKSwKICAgICJwc3FsIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPUxpbmUoIisiLCAiLSIsICIrIiwgIisiKSwKICAgICAgICBsaW5lYmVsb3doZWFkZXI9TGluZSgifCIsICItIiwgIisiLCAifCIpLAogICAgICAgIGxpbmViZXR3ZWVucm93cz1Ob25lLAogICAgICAgIGxpbmViZWxvdz1MaW5lKCIrIiwgIi0iLCAiKyIsICIrIiksCiAgICAgICAgaGVhZGVycm93PURhdGFSb3coInwiLCAifCIsICJ8IiksCiAgICAgICAgZGF0YXJvdz1EYXRhUm93KCJ8IiwgInwiLCAifCIpLAogICAgICAgIHBhZGRpbmc9MSwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAogICAgInJzdCI6IFRhYmxlRm9ybWF0KAogICAgICAgIGxpbmVhYm92ZT1MaW5lKCIiLCAiPSIsICIgICIsICIiKSwKICAgICAgICBsaW5lYmVsb3doZWFkZXI9TGluZSgiIiwgIj0iLCAiICAiLCAiIiksCiAgICAgICAgbGluZWJldHdlZW5yb3dzPU5vbmUsCiAgICAgICAgbGluZWJlbG93PUxpbmUoIiIsICI9IiwgIiAgIiwgIiIpLAogICAgICAgIGhlYWRlcnJvdz1EYXRhUm93KCIiLCAiICAiLCAiIiksCiAgICAgICAgZGF0YXJvdz1EYXRhUm93KCIiLCAiICAiLCAiIiksCiAgICAgICAgcGFkZGluZz0wLAogICAgICAgIHdpdGhfaGVhZGVyX2hpZGU9Tm9uZSwKICAgICksCiAgICAibWVkaWF3aWtpIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPUxpbmUoCiAgICAgICAgICAgICd7fCBjbGFzcz0id2lraXRhYmxlIiBzdHlsZT0idGV4dC1hbGlnbjogbGVmdDsiJywKICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICIiLAogICAgICAgICAgICAiXG58KyA8IS0tIGNhcHRpb24gLS0+XG58LSIsCiAgICAgICAgKSwKICAgICAgICBsaW5lYmVsb3doZWFkZXI9TGluZSgifC0iLCAiIiwgIiIsICIiKSwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9TGluZSgifC0iLCAiIiwgIiIsICIiKSwKICAgICAgICBsaW5lYmVsb3c9TGluZSgifH0iLCAiIiwgIiIsICIiKSwKICAgICAgICBoZWFkZXJyb3c9cGFydGlhbChfbWVkaWF3aWtpX3Jvd193aXRoX2F0dHJzLCAiISIpLAogICAgICAgIGRhdGFyb3c9cGFydGlhbChfbWVkaWF3aWtpX3Jvd193aXRoX2F0dHJzLCAifCIpLAogICAgICAgIHBhZGRpbmc9MCwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAogICAgIm1vaW5tb2luIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPU5vbmUsCiAgICAgICAgbGluZWJlbG93aGVhZGVyPU5vbmUsCiAgICAgICAgbGluZWJldHdlZW5yb3dzPU5vbmUsCiAgICAgICAgbGluZWJlbG93PU5vbmUsCiAgICAgICAgaGVhZGVycm93PXBhcnRpYWwoX21vaW5fcm93X3dpdGhfYXR0cnMsICJ8fCIsIGhlYWRlcj0iJycnIiksCiAgICAgICAgZGF0YXJvdz1wYXJ0aWFsKF9tb2luX3Jvd193aXRoX2F0dHJzLCAifHwiKSwKICAgICAgICBwYWRkaW5nPTEsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKSwKICAgICJ5b3V0cmFjayI6IFRhYmxlRm9ybWF0KAogICAgICAgIGxpbmVhYm92ZT1Ob25lLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj1Ob25lLAogICAgICAgIGxpbmViZXR3ZWVucm93cz1Ob25lLAogICAgICAgIGxpbmViZWxvdz1Ob25lLAogICAgICAgIGhlYWRlcnJvdz1EYXRhUm93KCJ8fCAiLCAiIHx8ICIsICIgfHwgIiksCiAgICAgICAgZGF0YXJvdz1EYXRhUm93KCJ8ICIsICIgfCAiLCAiIHwiKSwKICAgICAgICBwYWRkaW5nPTEsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKSwKICAgICJodG1sIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPV9odG1sX2JlZ2luX3RhYmxlX3dpdGhvdXRfaGVhZGVyLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj0iIiwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9Tm9uZSwKICAgICAgICBsaW5lYmVsb3c9TGluZSgiPC90Ym9keT5cbjwvdGFibGU+IiwgIiIsICIiLCAiIiksCiAgICAgICAgaGVhZGVycm93PXBhcnRpYWwoX2h0bWxfcm93X3dpdGhfYXR0cnMsICJ0aCIsIEZhbHNlKSwKICAgICAgICBkYXRhcm93PXBhcnRpYWwoX2h0bWxfcm93X3dpdGhfYXR0cnMsICJ0ZCIsIEZhbHNlKSwKICAgICAgICBwYWRkaW5nPTAsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1bImxpbmVhYm92ZSJdLAogICAgKSwKICAgICJ1bnNhZmVodG1sIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPV9odG1sX2JlZ2luX3RhYmxlX3dpdGhvdXRfaGVhZGVyLAogICAgICAgIGxpbmViZWxvd2hlYWRlcj0iIiwKICAgICAgICBsaW5lYmV0d2VlbnJvd3M9Tm9uZSwKICAgICAgICBsaW5lYmVsb3c9TGluZSgiPC90Ym9keT5cbjwvdGFibGU+IiwgIiIsICIiLCAiIiksCiAgICAgICAgaGVhZGVycm93PXBhcnRpYWwoX2h0bWxfcm93X3dpdGhfYXR0cnMsICJ0aCIsIFRydWUpLAogICAgICAgIGRhdGFyb3c9cGFydGlhbChfaHRtbF9yb3dfd2l0aF9hdHRycywgInRkIiwgVHJ1ZSksCiAgICAgICAgcGFkZGluZz0wLAogICAgICAgIHdpdGhfaGVhZGVyX2hpZGU9WyJsaW5lYWJvdmUiXSwKICAgICksCiAgICAibGF0ZXgiOiBUYWJsZUZvcm1hdCgKICAgICAgICBsaW5lYWJvdmU9X2xhdGV4X2xpbmVfYmVnaW5fdGFidWxhciwKICAgICAgICBsaW5lYmVsb3doZWFkZXI9TGluZSgiXFxobGluZSIsICIiLCAiIiwgIiIpLAogICAgICAgIGxpbmViZXR3ZWVucm93cz1Ob25lLAogICAgICAgIGxpbmViZWxvdz1MaW5lKCJcXGhsaW5lXG5cXGVuZHt0YWJ1bGFyfSIsICIiLCAiIiwgIiIpLAogICAgICAgIGhlYWRlcnJvdz1fbGF0ZXhfcm93LAogICAgICAgIGRhdGFyb3c9X2xhdGV4X3JvdywKICAgICAgICBwYWRkaW5nPTEsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKSwKICAgICJsYXRleF9yYXciOiBUYWJsZUZvcm1hdCgKICAgICAgICBsaW5lYWJvdmU9X2xhdGV4X2xpbmVfYmVnaW5fdGFidWxhciwKICAgICAgICBsaW5lYmVsb3doZWFkZXI9TGluZSgiXFxobGluZSIsICIiLCAiIiwgIiIpLAogICAgICAgIGxpbmViZXR3ZWVucm93cz1Ob25lLAogICAgICAgIGxpbmViZWxvdz1MaW5lKCJcXGhsaW5lXG5cXGVuZHt0YWJ1bGFyfSIsICIiLCAiIiwgIiIpLAogICAgICAgIGhlYWRlcnJvdz1wYXJ0aWFsKF9sYXRleF9yb3csIGVzY3J1bGVzPXt9KSwKICAgICAgICBkYXRhcm93PXBhcnRpYWwoX2xhdGV4X3JvdywgZXNjcnVsZXM9e30pLAogICAgICAgIHBhZGRpbmc9MSwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAogICAgImxhdGV4X2Jvb2t0YWJzIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPXBhcnRpYWwoX2xhdGV4X2xpbmVfYmVnaW5fdGFidWxhciwgYm9va3RhYnM9VHJ1ZSksCiAgICAgICAgbGluZWJlbG93aGVhZGVyPUxpbmUoIlxcbWlkcnVsZSIsICIiLCAiIiwgIiIpLAogICAgICAgIGxpbmViZXR3ZWVucm93cz1Ob25lLAogICAgICAgIGxpbmViZWxvdz1MaW5lKCJcXGJvdHRvbXJ1bGVcblxcZW5ke3RhYnVsYXJ9IiwgIiIsICIiLCAiIiksCiAgICAgICAgaGVhZGVycm93PV9sYXRleF9yb3csCiAgICAgICAgZGF0YXJvdz1fbGF0ZXhfcm93LAogICAgICAgIHBhZGRpbmc9MSwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAogICAgImxhdGV4X2xvbmd0YWJsZSI6IFRhYmxlRm9ybWF0KAogICAgICAgIGxpbmVhYm92ZT1wYXJ0aWFsKF9sYXRleF9saW5lX2JlZ2luX3RhYnVsYXIsIGxvbmd0YWJsZT1UcnVlKSwKICAgICAgICBsaW5lYmVsb3doZWFkZXI9TGluZSgiXFxobGluZVxuXFxlbmRoZWFkIiwgIiIsICIiLCAiIiksCiAgICAgICAgbGluZWJldHdlZW5yb3dzPU5vbmUsCiAgICAgICAgbGluZWJlbG93PUxpbmUoIlxcaGxpbmVcblxcZW5ke2xvbmd0YWJsZX0iLCAiIiwgIiIsICIiKSwKICAgICAgICBoZWFkZXJyb3c9X2xhdGV4X3JvdywKICAgICAgICBkYXRhcm93PV9sYXRleF9yb3csCiAgICAgICAgcGFkZGluZz0xLAogICAgICAgIHdpdGhfaGVhZGVyX2hpZGU9Tm9uZSwKICAgICksCiAgICAidHN2IjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPU5vbmUsCiAgICAgICAgbGluZWJlbG93aGVhZGVyPU5vbmUsCiAgICAgICAgbGluZWJldHdlZW5yb3dzPU5vbmUsCiAgICAgICAgbGluZWJlbG93PU5vbmUsCiAgICAgICAgaGVhZGVycm93PURhdGFSb3coIiIsICJcdCIsICIiKSwKICAgICAgICBkYXRhcm93PURhdGFSb3coIiIsICJcdCIsICIiKSwKICAgICAgICBwYWRkaW5nPTAsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKSwKICAgICJ0ZXh0aWxlIjogVGFibGVGb3JtYXQoCiAgICAgICAgbGluZWFib3ZlPU5vbmUsCiAgICAgICAgbGluZWJlbG93aGVhZGVyPU5vbmUsCiAgICAgICAgbGluZWJldHdlZW5yb3dzPU5vbmUsCiAgICAgICAgbGluZWJlbG93PU5vbmUsCiAgICAgICAgaGVhZGVycm93PURhdGFSb3coInxfLiAiLCAifF8uIiwgInwiKSwKICAgICAgICBkYXRhcm93PV90ZXh0aWxlX3Jvd193aXRoX2F0dHJzLAogICAgICAgIHBhZGRpbmc9MSwKICAgICAgICB3aXRoX2hlYWRlcl9oaWRlPU5vbmUsCiAgICApLAp9CgoKdGFidWxhdGVfZm9ybWF0cyA9IGxpc3Qoc29ydGVkKF90YWJsZV9mb3JtYXRzLmtleXMoKSkpCgojIFRoZSB0YWJsZSBmb3JtYXRzIGZvciB3aGljaCBtdWx0aWxpbmUgY2VsbHMgd2lsbCBiZSBmb2xkZWQgaW50byBzdWJzZXF1ZW50CiMgdGFibGUgcm93cy4gVGhlIGtleSBpcyB0aGUgb3JpZ2luYWwgZm9ybWF0IHNwZWNpZmllZCBhdCB0aGUgQVBJLiBUaGUgdmFsdWUgaXMKIyB0aGUgZm9ybWF0IHRoYXQgd2lsbCBiZSB1c2VkIHRvIHJlcHJlc2VudCB0aGUgb3JpZ2luYWwgZm9ybWF0LgptdWx0aWxpbmVfZm9ybWF0cyA9IHsKICAgICJwbGFpbiI6ICJwbGFpbiIsCiAgICAic2ltcGxlIjogInNpbXBsZSIsCiAgICAiZ3JpZCI6ICJncmlkIiwKICAgICJmYW5jeV9ncmlkIjogImZhbmN5X2dyaWQiLAogICAgInBpcGUiOiAicGlwZSIsCiAgICAib3JndGJsIjogIm9yZ3RibCIsCiAgICAiamlyYSI6ICJqaXJhIiwKICAgICJwcmVzdG8iOiAicHJlc3RvIiwKICAgICJwcmV0dHkiOiAicHJldHR5IiwKICAgICJwc3FsIjogInBzcWwiLAogICAgInJzdCI6ICJyc3QiLAp9CgojIFRPRE86IEFkZCBtdWx0aWxpbmUgc3VwcG9ydCBmb3IgdGhlIHJlbWFpbmluZyB0YWJsZSBmb3JtYXRzOgojICAgICAgIC0gbWVkaWF3aWtpOiBSZXBsYWNlIFxuIHdpdGggPGJyPgojICAgICAgIC0gbW9pbm1vaW46IFRCRAojICAgICAgIC0geW91dHJhY2s6IFRCRAojICAgICAgIC0gaHRtbDogUmVwbGFjZSBcbiB3aXRoIDxicj4KIyAgICAgICAtIGxhdGV4KjogVXNlICJtYWtlY2VsbCIgcGFja2FnZTogSW4gaGVhZGVyLCByZXBsYWNlIFhcblkgd2l0aAojICAgICAgICAgXHRoZWFke1hcXFl9IGFuZCBpbiBkYXRhIHJvdywgcmVwbGFjZSBYXG5ZIHdpdGggXG1ha2VjZWxse1hcXFl9CiMgICAgICAgLSB0c3Y6IFRCRAojICAgICAgIC0gdGV4dGlsZTogUmVwbGFjZSBcbiB3aXRoIDxici8+IChtdXN0IGJlIHdlbGwtZm9ybWVkIFhNTCkKCl9tdWx0aWxpbmVfY29kZXMgPSByZS5jb21waWxlKHIiXHJ8XG58XHJcbiIpCl9tdWx0aWxpbmVfY29kZXNfYnl0ZXMgPSByZS5jb21waWxlKGIiXHJ8XG58XHJcbiIpCl9pbnZpc2libGVfY29kZXMgPSByZS5jb21waWxlKAogICAgciJceDFiXFtcZCtbO1xkXSptfFx4MWJcW1xkKlw7XGQqXDtcZCptfFx4MWJcXTg7OyguKj8pXHgxYlxcIgopICAjIEFOU0kgY29sb3IgY29kZXMKX2ludmlzaWJsZV9jb2Rlc19ieXRlcyA9IHJlLmNvbXBpbGUoCiAgICBiIlx4MWJcXFtcXGQrXFxbO1xcZF0qbXxceDFiXFxbXFxkKjtcXGQqO1xcZCptfFxceDFiXFxdODs7KC4qPylcXHgxYlxcXFwiCikgICMgQU5TSSBjb2xvciBjb2RlcwpfaW52aXNpYmxlX2NvZGVzX2xpbmsgPSByZS5jb21waWxlKAogICAgciJceDFCXTg7W2EtekEtWjAtOTpdKjtbXlx4MUJdK1x4MUJcXChbXlx4MWJdKylceDFCXTg7O1x4MUJcXCIKKSAgIyBUZXJtaW5hbCBoeXBlcmxpbmtzCgpfYW5zaV9jb2xvcl9yZXNldF9jb2RlID0gIlwwMzNbMG0iCgoKZGVmIHNpbXBsZV9zZXBhcmF0ZWRfZm9ybWF0KHNlcGFyYXRvcik6CiAgICAiIiJDb25zdHJ1Y3QgYSBzaW1wbGUgVGFibGVGb3JtYXQgd2l0aCBjb2x1bW5zIHNlcGFyYXRlZCBieSBhIHNlcGFyYXRvci4KCiAgICA+Pj4gdHN2ID0gc2ltcGxlX3NlcGFyYXRlZF9mb3JtYXQoIlxcdCIpIDsgXAogICAgICAgIHRhYnVsYXRlKFtbImZvbyIsIDFdLCBbInNwYW0iLCAyM11dLCB0YWJsZWZtdD10c3YpID09ICdmb28gXFx0IDFcXG5zcGFtXFx0MjMnCiAgICBUcnVlCgogICAgIiIiCiAgICByZXR1cm4gVGFibGVGb3JtYXQoCiAgICAgICAgTm9uZSwKICAgICAgICBOb25lLAogICAgICAgIE5vbmUsCiAgICAgICAgTm9uZSwKICAgICAgICBoZWFkZXJyb3c9RGF0YVJvdygiIiwgc2VwYXJhdG9yLCAiIiksCiAgICAgICAgZGF0YXJvdz1EYXRhUm93KCIiLCBzZXBhcmF0b3IsICIiKSwKICAgICAgICBwYWRkaW5nPTAsCiAgICAgICAgd2l0aF9oZWFkZXJfaGlkZT1Ob25lLAogICAgKQoKCmRlZiBfaXNjb252ZXJ0aWJsZShjb252LCBzdHJpbmcpOgogICAgdHJ5OgogICAgICAgIGNvbnYoc3RyaW5nKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgKFZhbHVlRXJyb3IsIFR5cGVFcnJvcik6CiAgICAgICAgcmV0dXJuIEZhbHNlCgoKZGVmIF9pc251bWJlcihzdHJpbmcpOgogICAgIiIiCiAgICA+Pj4gX2lzbnVtYmVyKCIxMjMuNDUiKQogICAgVHJ1ZQogICAgPj4+IF9pc251bWJlcigiMTIzIikKICAgIFRydWUKICAgID4+PiBfaXNudW1iZXIoInNwYW0iKQogICAgRmFsc2UKICAgID4+PiBfaXNudW1iZXIoIjEyM2U0NTY3OCIpCiAgICBGYWxzZQogICAgPj4+IF9pc251bWJlcigiaW5mIikKICAgIFRydWUKICAgICIiIgogICAgaWYgbm90IF9pc2NvbnZlcnRpYmxlKGZsb2F0LCBzdHJpbmcpOgogICAgICAgIHJldHVybiBGYWxzZQogICAgZWxpZiBpc2luc3RhbmNlKHN0cmluZywgKF90ZXh0X3R5cGUsIF9iaW5hcnlfdHlwZSkpIGFuZCAoCiAgICAgICAgbWF0aC5pc2luZihmbG9hdChzdHJpbmcpKSBvciBtYXRoLmlzbmFuKGZsb2F0KHN0cmluZykpCiAgICApOgogICAgICAgIHJldHVybiBzdHJpbmcubG93ZXIoKSBpbiBbImluZiIsICItaW5mIiwgIm5hbiJdCiAgICByZXR1cm4gVHJ1ZQoKCmRlZiBfaXNpbnQoc3RyaW5nLCBpbnR0eXBlPWludCk6CiAgICAiIiIKICAgID4+PiBfaXNpbnQoIjEyMyIpCiAgICBUcnVlCiAgICA+Pj4gX2lzaW50KCIxMjMuNDUiKQogICAgRmFsc2UKICAgICIiIgogICAgcmV0dXJuICgKICAgICAgICB0eXBlKHN0cmluZykgaXMgaW50dHlwZQogICAgICAgIG9yIChpc2luc3RhbmNlKHN0cmluZywgX2JpbmFyeV90eXBlKSBvciBpc2luc3RhbmNlKHN0cmluZywgX3RleHRfdHlwZSkpCiAgICAgICAgYW5kIF9pc2NvbnZlcnRpYmxlKGludHR5cGUsIHN0cmluZykKICAgICkKCgpkZWYgX2lzYm9vbChzdHJpbmcpOgogICAgIiIiCiAgICA+Pj4gX2lzYm9vbChUcnVlKQogICAgVHJ1ZQogICAgPj4+IF9pc2Jvb2woIkZhbHNlIikKICAgIFRydWUKICAgID4+PiBfaXNib29sKDEpCiAgICBGYWxzZQogICAgIiIiCiAgICByZXR1cm4gdHlwZShzdHJpbmcpIGlzIF9ib29sX3R5cGUgb3IgKAogICAgICAgIGlzaW5zdGFuY2Uoc3RyaW5nLCAoX2JpbmFyeV90eXBlLCBfdGV4dF90eXBlKSkgYW5kIHN0cmluZyBpbiAoIlRydWUiLCAiRmFsc2UiKQogICAgKQoKCmRlZiBfdHlwZShzdHJpbmcsIGhhc19pbnZpc2libGU9VHJ1ZSwgbnVtcGFyc2U9VHJ1ZSk6CiAgICAiIiJUaGUgbGVhc3QgZ2VuZXJpYyB0eXBlICh0eXBlKE5vbmUpLCBpbnQsIGZsb2F0LCBzdHIsIHVuaWNvZGUpLgoKICAgID4+PiBfdHlwZShOb25lKSBpcyB0eXBlKE5vbmUpCiAgICBUcnVlCiAgICA+Pj4gX3R5cGUoImZvbyIpIGlzIHR5cGUoIiIpCiAgICBUcnVlCiAgICA+Pj4gX3R5cGUoIjEiKSBpcyB0eXBlKDEpCiAgICBUcnVlCiAgICA+Pj4gX3R5cGUoJ1x4MWJbMzFtNDJceDFiWzBtJykgaXMgdHlwZSg0MikKICAgIFRydWUKICAgID4+PiBfdHlwZSgnXHgxYlszMW00Mlx4MWJbMG0nKSBpcyB0eXBlKDQyKQogICAgVHJ1ZQoKICAgICIiIgoKICAgIGlmIGhhc19pbnZpc2libGUgYW5kICgKICAgICAgICBpc2luc3RhbmNlKHN0cmluZywgX3RleHRfdHlwZSkgb3IgaXNpbnN0YW5jZShzdHJpbmcsIF9iaW5hcnlfdHlwZSkKICAgICk6CiAgICAgICAgc3RyaW5nID0gX3N0cmlwX2ludmlzaWJsZShzdHJpbmcpCgogICAgaWYgc3RyaW5nIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuIF9ub25lX3R5cGUKICAgIGVsaWYgaGFzYXR0cihzdHJpbmcsICJpc29mb3JtYXQiKTogICMgZGF0ZXRpbWUuZGF0ZXRpbWUsIGRhdGUsIGFuZCB0aW1lCiAgICAgICAgcmV0dXJuIF90ZXh0X3R5cGUKICAgIGVsaWYgX2lzYm9vbChzdHJpbmcpOgogICAgICAgIHJldHVybiBfYm9vbF90eXBlCiAgICBlbGlmIF9pc2ludChzdHJpbmcpIGFuZCBudW1wYXJzZToKICAgICAgICByZXR1cm4gaW50CiAgICBlbGlmIF9pc2ludChzdHJpbmcsIF9sb25nX3R5cGUpIGFuZCBudW1wYXJzZToKICAgICAgICByZXR1cm4gaW50CiAgICBlbGlmIF9pc251bWJlcihzdHJpbmcpIGFuZCBudW1wYXJzZToKICAgICAgICByZXR1cm4gZmxvYXQKICAgIGVsaWYgaXNpbnN0YW5jZShzdHJpbmcsIF9iaW5hcnlfdHlwZSk6CiAgICAgICAgcmV0dXJuIF9iaW5hcnlfdHlwZQogICAgZWxzZToKICAgICAgICByZXR1cm4gX3RleHRfdHlwZQoKCmRlZiBfYWZ0ZXJwb2ludChzdHJpbmcpOgogICAgIiIiU3ltYm9scyBhZnRlciBhIGRlY2ltYWwgcG9pbnQsIC0xIGlmIHRoZSBzdHJpbmcgbGFja3MgdGhlIGRlY2ltYWwgcG9pbnQuCgogICAgPj4+IF9hZnRlcnBvaW50KCIxMjMuNDUiKQogICAgMgogICAgPj4+IF9hZnRlcnBvaW50KCIxMDAxIikKICAgIC0xCiAgICA+Pj4gX2FmdGVycG9pbnQoImVnZ3MiKQogICAgLTEKICAgID4+PiBfYWZ0ZXJwb2ludCgiMTIzZTQ1IikKICAgIDIKCiAgICAiIiIKICAgIGlmIF9pc251bWJlcihzdHJpbmcpOgogICAgICAgIGlmIF9pc2ludChzdHJpbmcpOgogICAgICAgICAgICByZXR1cm4gLTEKICAgICAgICBlbHNlOgogICAgICAgICAgICBwb3MgPSBzdHJpbmcucmZpbmQoIi4iKQogICAgICAgICAgICBwb3MgPSBzdHJpbmcubG93ZXIoKS5yZmluZCgiZSIpIGlmIHBvcyA8IDAgZWxzZSBwb3MKICAgICAgICAgICAgaWYgcG9zID49IDA6CiAgICAgICAgICAgICAgICByZXR1cm4gbGVuKHN0cmluZykgLSBwb3MgLSAxCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gLTEgICMgbm8gcG9pbnQKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIC0xICAjIG5vdCBhIG51bWJlcgoKCmRlZiBfcGFkbGVmdCh3aWR0aCwgcyk6CiAgICAiIiJGbHVzaCByaWdodC4KCiAgICA+Pj4gX3BhZGxlZnQoNiwgJ1x1MDQ0Zlx1MDQzOVx1MDQ0Nlx1MDQzMCcpID09ICcgIFx1MDQ0Zlx1MDQzOVx1MDQ0Nlx1MDQzMCcKICAgIFRydWUKCiAgICAiIiIKICAgIGZtdCA9ICJ7MDo+JWRzfSIgJSB3aWR0aAogICAgcmV0dXJuIGZtdC5mb3JtYXQocykKCgpkZWYgX3BhZHJpZ2h0KHdpZHRoLCBzKToKICAgICIiIkZsdXNoIGxlZnQuCgogICAgPj4+IF9wYWRyaWdodCg2LCAnXHUwNDRmXHUwNDM5XHUwNDQ2XHUwNDMwJykgPT0gJ1x1MDQ0Zlx1MDQzOVx1MDQ0Nlx1MDQzMCAgJwogICAgVHJ1ZQoKICAgICIiIgogICAgZm10ID0gInswOjwlZHN9IiAlIHdpZHRoCiAgICByZXR1cm4gZm10LmZvcm1hdChzKQoKCmRlZiBfcGFkYm90aCh3aWR0aCwgcyk6CiAgICAiIiJDZW50ZXIgc3RyaW5nLgoKICAgID4+PiBfcGFkYm90aCg2LCAnXHUwNDRmXHUwNDM5XHUwNDQ2XHUwNDMwJykgPT0gJyBcdTA0NGZcdTA0MzlcdTA0NDZcdTA0MzAgJwogICAgVHJ1ZQoKICAgICIiIgogICAgZm10ID0gInswOl4lZHN9IiAlIHdpZHRoCiAgICByZXR1cm4gZm10LmZvcm1hdChzKQoKCmRlZiBfcGFkbm9uZShpZ25vcmVfd2lkdGgsIHMpOgogICAgcmV0dXJuIHMKCgpkZWYgX3N0cmlwX2ludmlzaWJsZShzKToKICAgIHIiIiJSZW1vdmUgaW52aXNpYmxlIEFOU0kgY29sb3IgY29kZXMuCgogICAgPj4+IHN0cihfc3RyaXBfaW52aXNpYmxlKCdceDFCXTg7O2h0dHBzOi8vZXhhbXBsZS5jb21ceDFCXFxUaGlzIGlzIGEgbGlua1x4MUJdODs7XHgxQlxcJykpCiAgICAnVGhpcyBpcyBhIGxpbmsnCgogICAgIiIiCiAgICBpZiBpc2luc3RhbmNlKHMsIF90ZXh0X3R5cGUpOgogICAgICAgIGxpbmtzX3JlbW92ZWQgPSByZS5zdWIoX2ludmlzaWJsZV9jb2Rlc19saW5rLCAiXFwxIiwgcykKICAgICAgICByZXR1cm4gcmUuc3ViKF9pbnZpc2libGVfY29kZXMsICIiLCBsaW5rc19yZW1vdmVkKQogICAgZWxzZTogICMgYSBieXRlc3RyaW5nCiAgICAgICAgcmV0dXJuIHJlLnN1YihfaW52aXNpYmxlX2NvZGVzX2J5dGVzLCAiIiwgcykKCgpkZWYgX3Zpc2libGVfd2lkdGgocyk6CiAgICAiIiJWaXNpYmxlIHdpZHRoIG9mIGEgcHJpbnRlZCBzdHJpbmcuIEFOU0kgY29sb3IgY29kZXMgYXJlIHJlbW92ZWQuCgogICAgPj4+IF92aXNpYmxlX3dpZHRoKCdceDFiWzMxbWhlbGxvXHgxYlswbScpLCBfdmlzaWJsZV93aWR0aCgid29ybGQiKQogICAgKDUsIDUpCgogICAgIiIiCiAgICAjIG9wdGlvbmFsIHdpZGUtY2hhcmFjdGVyIHN1cHBvcnQKICAgIGlmIHdjd2lkdGggaXMgbm90IE5vbmUgYW5kIFdJREVfQ0hBUlNfTU9ERToKICAgICAgICBsZW5fZm4gPSB3Y3dpZHRoLndjc3dpZHRoCiAgICBlbHNlOgogICAgICAgIGxlbl9mbiA9IGxlbgogICAgaWYgaXNpbnN0YW5jZShzLCBfdGV4dF90eXBlKSBvciBpc2luc3RhbmNlKHMsIF9iaW5hcnlfdHlwZSk6CiAgICAgICAgcmV0dXJuIGxlbl9mbihfc3RyaXBfaW52aXNpYmxlKHMpKQogICAgZWxzZToKICAgICAgICByZXR1cm4gbGVuX2ZuKF90ZXh0X3R5cGUocykpCgoKZGVmIF9pc19tdWx0aWxpbmUocyk6CiAgICBpZiBpc2luc3RhbmNlKHMsIF90ZXh0X3R5cGUpOgogICAgICAgIHJldHVybiBib29sKHJlLnNlYXJjaChfbXVsdGlsaW5lX2NvZGVzLCBzKSkKICAgIGVsc2U6ICAjIGEgYnl0ZXN0cmluZwogICAgICAgIHJldHVybiBib29sKHJlLnNlYXJjaChfbXVsdGlsaW5lX2NvZGVzX2J5dGVzLCBzKSkKCgpkZWYgX211bHRpbGluZV93aWR0aChtdWx0aWxpbmVfcywgbGluZV93aWR0aF9mbj1sZW4pOgogICAgIiIiVmlzaWJsZSB3aWR0aCBvZiBhIHBvdGVudGlhbGx5IG11bHRpbGluZSBjb250ZW50LiIiIgogICAgcmV0dXJuIG1heChtYXAobGluZV93aWR0aF9mbiwgcmUuc3BsaXQoIltcclxuXSIsIG11bHRpbGluZV9zKSkpCgoKZGVmIF9jaG9vc2Vfd2lkdGhfZm4oaGFzX2ludmlzaWJsZSwgZW5hYmxlX3dpZGVjaGFycywgaXNfbXVsdGlsaW5lKToKICAgICIiIlJldHVybiBhIGZ1bmN0aW9uIHRvIGNhbGN1bGF0ZSB2aXNpYmxlIGNlbGwgd2lkdGguIiIiCiAgICBpZiBoYXNfaW52aXNpYmxlOgogICAgICAgIGxpbmVfd2lkdGhfZm4gPSBfdmlzaWJsZV93aWR0aAogICAgZWxpZiBlbmFibGVfd2lkZWNoYXJzOiAgIyBvcHRpb25hbCB3aWRlLWNoYXJhY3RlciBzdXBwb3J0IGlmIGF2YWlsYWJsZQogICAgICAgIGxpbmVfd2lkdGhfZm4gPSB3Y3dpZHRoLndjc3dpZHRoCiAgICBlbHNlOgogICAgICAgIGxpbmVfd2lkdGhfZm4gPSBsZW4KICAgIGlmIGlzX211bHRpbGluZToKICAgICAgICB3aWR0aF9mbiA9IGxhbWJkYSBzOiBfbXVsdGlsaW5lX3dpZHRoKHMsIGxpbmVfd2lkdGhfZm4pICAjIG5vcWEKICAgIGVsc2U6CiAgICAgICAgd2lkdGhfZm4gPSBsaW5lX3dpZHRoX2ZuCiAgICByZXR1cm4gd2lkdGhfZm4KCgpkZWYgX2FsaWduX2NvbHVtbl9jaG9vc2VfcGFkZm4oc3RyaW5ncywgYWxpZ25tZW50LCBoYXNfaW52aXNpYmxlKToKICAgIGlmIGFsaWdubWVudCA9PSAicmlnaHQiOgogICAgICAgIGlmIG5vdCBQUkVTRVJWRV9XSElURVNQQUNFOgogICAgICAgICAgICBzdHJpbmdzID0gW3Muc3RyaXAoKSBmb3IgcyBpbiBzdHJpbmdzXQogICAgICAgIHBhZGZuID0gX3BhZGxlZnQKICAgIGVsaWYgYWxpZ25tZW50ID09ICJjZW50ZXIiOgogICAgICAgIGlmIG5vdCBQUkVTRVJWRV9XSElURVNQQUNFOgogICAgICAgICAgICBzdHJpbmdzID0gW3Muc3RyaXAoKSBmb3IgcyBpbiBzdHJpbmdzXQogICAgICAgIHBhZGZuID0gX3BhZGJvdGgKICAgIGVsaWYgYWxpZ25tZW50ID09ICJkZWNpbWFsIjoKICAgICAgICBpZiBoYXNfaW52aXNpYmxlOgogICAgICAgICAgICBkZWNpbWFscyA9IFtfYWZ0ZXJwb2ludChfc3RyaXBfaW52aXNpYmxlKHMpKSBmb3IgcyBpbiBzdHJpbmdzXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGRlY2ltYWxzID0gW19hZnRlcnBvaW50KHMpIGZvciBzIGluIHN0cmluZ3NdCiAgICAgICAgbWF4ZGVjaW1hbHMgPSBtYXgoZGVjaW1hbHMpCiAgICAgICAgc3RyaW5ncyA9IFtzICsgKG1heGRlY2ltYWxzIC0gZGVjcykgKiAiICIgZm9yIHMsIGRlY3MgaW4gemlwKHN0cmluZ3MsIGRlY2ltYWxzKV0KICAgICAgICBwYWRmbiA9IF9wYWRsZWZ0CiAgICBlbGlmIG5vdCBhbGlnbm1lbnQ6CiAgICAgICAgcGFkZm4gPSBfcGFkbm9uZQogICAgZWxzZToKICAgICAgICBpZiBub3QgUFJFU0VSVkVfV0hJVEVTUEFDRToKICAgICAgICAgICAgc3RyaW5ncyA9IFtzLnN0cmlwKCkgZm9yIHMgaW4gc3RyaW5nc10KICAgICAgICBwYWRmbiA9IF9wYWRyaWdodAogICAgcmV0dXJuIHN0cmluZ3MsIHBhZGZuCgoKZGVmIF9hbGlnbl9jb2x1bW5fY2hvb3NlX3dpZHRoX2ZuKGhhc19pbnZpc2libGUsIGVuYWJsZV93aWRlY2hhcnMsIGlzX211bHRpbGluZSk6CiAgICBpZiBoYXNfaW52aXNpYmxlOgogICAgICAgIGxpbmVfd2lkdGhfZm4gPSBfdmlzaWJsZV93aWR0aAogICAgZWxpZiBlbmFibGVfd2lkZWNoYXJzOiAgIyBvcHRpb25hbCB3aWRlLWNoYXJhY3RlciBzdXBwb3J0IGlmIGF2YWlsYWJsZQogICAgICAgIGxpbmVfd2lkdGhfZm4gPSB3Y3dpZHRoLndjc3dpZHRoCiAgICBlbHNlOgogICAgICAgIGxpbmVfd2lkdGhfZm4gPSBsZW4KICAgIGlmIGlzX211bHRpbGluZToKICAgICAgICB3aWR0aF9mbiA9IGxhbWJkYSBzOiBfYWxpZ25fY29sdW1uX211bHRpbGluZV93aWR0aChzLCBsaW5lX3dpZHRoX2ZuKSAgIyBub3FhCiAgICBlbHNlOgogICAgICAgIHdpZHRoX2ZuID0gbGluZV93aWR0aF9mbgogICAgcmV0dXJuIHdpZHRoX2ZuCgoKZGVmIF9hbGlnbl9jb2x1bW5fbXVsdGlsaW5lX3dpZHRoKG11bHRpbGluZV9zLCBsaW5lX3dpZHRoX2ZuPWxlbik6CiAgICAiIiJWaXNpYmxlIHdpZHRoIG9mIGEgcG90ZW50aWFsbHkgbXVsdGlsaW5lIGNvbnRlbnQuIiIiCiAgICByZXR1cm4gbGlzdChtYXAobGluZV93aWR0aF9mbiwgcmUuc3BsaXQoIltcclxuXSIsIG11bHRpbGluZV9zKSkpCgoKZGVmIF9mbGF0X2xpc3QobmVzdGVkX2xpc3QpOgogICAgcmV0ID0gW10KICAgIGZvciBpdGVtIGluIG5lc3RlZF9saXN0OgogICAgICAgIGlmIGlzaW5zdGFuY2UoaXRlbSwgbGlzdCk6CiAgICAgICAgICAgIGZvciBzdWJpdGVtIGluIGl0ZW06CiAgICAgICAgICAgICAgICByZXQuYXBwZW5kKHN1Yml0ZW0pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0LmFwcGVuZChpdGVtKQogICAgcmV0dXJuIHJldAoKCmRlZiBfYWxpZ25fY29sdW1uKAogICAgc3RyaW5ncywKICAgIGFsaWdubWVudCwKICAgIG1pbndpZHRoPTAsCiAgICBoYXNfaW52aXNpYmxlPVRydWUsCiAgICBlbmFibGVfd2lkZWNoYXJzPUZhbHNlLAogICAgaXNfbXVsdGlsaW5lPUZhbHNlLAopOgogICAgIiIiW3N0cmluZ10gLT4gW3BhZGRlZF9zdHJpbmddIiIiCiAgICBzdHJpbmdzLCBwYWRmbiA9IF9hbGlnbl9jb2x1bW5fY2hvb3NlX3BhZGZuKHN0cmluZ3MsIGFsaWdubWVudCwgaGFzX2ludmlzaWJsZSkKICAgIHdpZHRoX2ZuID0gX2FsaWduX2NvbHVtbl9jaG9vc2Vfd2lkdGhfZm4oCiAgICAgICAgaGFzX2ludmlzaWJsZSwgZW5hYmxlX3dpZGVjaGFycywgaXNfbXVsdGlsaW5lCiAgICApCgogICAgc193aWR0aHMgPSBsaXN0KG1hcCh3aWR0aF9mbiwgc3RyaW5ncykpCiAgICBtYXh3aWR0aCA9IG1heChtYXgoX2ZsYXRfbGlzdChzX3dpZHRocykpLCBtaW53aWR0aCkKICAgICMgVE9ETzogcmVmYWN0b3IgY29sdW1uIGFsaWdubWVudCBpbiBzaW5nbGUtbGluZSBhbmQgbXVsdGlsaW5lIG1vZGVzCiAgICBpZiBpc19tdWx0aWxpbmU6CiAgICAgICAgaWYgbm90IGVuYWJsZV93aWRlY2hhcnMgYW5kIG5vdCBoYXNfaW52aXNpYmxlOgogICAgICAgICAgICBwYWRkZWRfc3RyaW5ncyA9IFsKICAgICAgICAgICAgICAgICJcbiIuam9pbihbcGFkZm4obWF4d2lkdGgsIHMpIGZvciBzIGluIG1zLnNwbGl0bGluZXMoKV0pCiAgICAgICAgICAgICAgICBmb3IgbXMgaW4gc3RyaW5ncwogICAgICAgICAgICBdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBlbmFibGUgd2lkZS1jaGFyYWN0ZXIgd2lkdGggY29ycmVjdGlvbnMKICAgICAgICAgICAgc19sZW5zID0gW1tsZW4ocykgZm9yIHMgaW4gcmUuc3BsaXQoIltcclxuXSIsIG1zKV0gZm9yIG1zIGluIHN0cmluZ3NdCiAgICAgICAgICAgIHZpc2libGVfd2lkdGhzID0gWwogICAgICAgICAgICAgICAgW21heHdpZHRoIC0gKHcgLSBsKSBmb3IgdywgbCBpbiB6aXAobXcsIG1sKV0KICAgICAgICAgICAgICAgIGZvciBtdywgbWwgaW4gemlwKHNfd2lkdGhzLCBzX2xlbnMpCiAgICAgICAgICAgIF0KICAgICAgICAgICAgIyB3Y3N3aWR0aCBhbmQgX3Zpc2libGVfd2lkdGggZG9uJ3QgY291bnQgaW52aXNpYmxlIGNoYXJhY3RlcnM7CiAgICAgICAgICAgICMgcGFkZm4gZG9lc24ndCBuZWVkIHRvIGFwcGx5IGFub3RoZXIgY29ycmVjdGlvbgogICAgICAgICAgICBwYWRkZWRfc3RyaW5ncyA9IFsKICAgICAgICAgICAgICAgICJcbiIuam9pbihbcGFkZm4odywgcykgZm9yIHMsIHcgaW4gemlwKChtcy5zcGxpdGxpbmVzKCkgb3IgbXMpLCBtdyldKQogICAgICAgICAgICAgICAgZm9yIG1zLCBtdyBpbiB6aXAoc3RyaW5ncywgdmlzaWJsZV93aWR0aHMpCiAgICAgICAgICAgIF0KICAgIGVsc2U6ICAjIHNpbmdsZS1saW5lIGNlbGwgdmFsdWVzCiAgICAgICAgaWYgbm90IGVuYWJsZV93aWRlY2hhcnMgYW5kIG5vdCBoYXNfaW52aXNpYmxlOgogICAgICAgICAgICBwYWRkZWRfc3RyaW5ncyA9IFtwYWRmbihtYXh3aWR0aCwgcykgZm9yIHMgaW4gc3RyaW5nc10KICAgICAgICBlbHNlOgogICAgICAgICAgICAjIGVuYWJsZSB3aWRlLWNoYXJhY3RlciB3aWR0aCBjb3JyZWN0aW9ucwogICAgICAgICAgICBzX2xlbnMgPSBsaXN0KG1hcChsZW4sIHN0cmluZ3MpKQogICAgICAgICAgICB2aXNpYmxlX3dpZHRocyA9IFttYXh3aWR0aCAtICh3IC0gbCkgZm9yIHcsIGwgaW4gemlwKHNfd2lkdGhzLCBzX2xlbnMpXQogICAgICAgICAgICAjIHdjc3dpZHRoIGFuZCBfdmlzaWJsZV93aWR0aCBkb24ndCBjb3VudCBpbnZpc2libGUgY2hhcmFjdGVyczsKICAgICAgICAgICAgIyBwYWRmbiBkb2Vzbid0IG5lZWQgdG8gYXBwbHkgYW5vdGhlciBjb3JyZWN0aW9uCiAgICAgICAgICAgIHBhZGRlZF9zdHJpbmdzID0gW3BhZGZuKHcsIHMpIGZvciBzLCB3IGluIHppcChzdHJpbmdzLCB2aXNpYmxlX3dpZHRocyldCiAgICByZXR1cm4gcGFkZGVkX3N0cmluZ3MKCgpkZWYgX21vcmVfZ2VuZXJpYyh0eXBlMSwgdHlwZTIpOgogICAgdHlwZXMgPSB7CiAgICAgICAgX25vbmVfdHlwZTogMCwKICAgICAgICBfYm9vbF90eXBlOiAxLAogICAgICAgIGludDogMiwKICAgICAgICBmbG9hdDogMywKICAgICAgICBfYmluYXJ5X3R5cGU6IDQsCiAgICAgICAgX3RleHRfdHlwZTogNSwKICAgIH0KICAgIGludnR5cGVzID0gewogICAgICAgIDU6IF90ZXh0X3R5cGUsCiAgICAgICAgNDogX2JpbmFyeV90eXBlLAogICAgICAgIDM6IGZsb2F0LAogICAgICAgIDI6IGludCwKICAgICAgICAxOiBfYm9vbF90eXBlLAogICAgICAgIDA6IF9ub25lX3R5cGUsCiAgICB9CiAgICBtb3JlZ2VuZXJpYyA9IG1heCh0eXBlcy5nZXQodHlwZTEsIDUpLCB0eXBlcy5nZXQodHlwZTIsIDUpKQogICAgcmV0dXJuIGludnR5cGVzW21vcmVnZW5lcmljXQoKCmRlZiBfY29sdW1uX3R5cGUoc3RyaW5ncywgaGFzX2ludmlzaWJsZT1UcnVlLCBudW1wYXJzZT1UcnVlKToKICAgICIiIlRoZSBsZWFzdCBnZW5lcmljIHR5cGUgYWxsIGNvbHVtbiB2YWx1ZXMgYXJlIGNvbnZlcnRpYmxlIHRvLgoKICAgID4+PiBfY29sdW1uX3R5cGUoW1RydWUsIEZhbHNlXSkgaXMgX2Jvb2xfdHlwZQogICAgVHJ1ZQogICAgPj4+IF9jb2x1bW5fdHlwZShbIjEiLCAiMiJdKSBpcyBfaW50X3R5cGUKICAgIFRydWUKICAgID4+PiBfY29sdW1uX3R5cGUoWyIxIiwgIjIuMyJdKSBpcyBfZmxvYXRfdHlwZQogICAgVHJ1ZQogICAgPj4+IF9jb2x1bW5fdHlwZShbIjEiLCAiMi4zIiwgImZvdXIiXSkgaXMgX3RleHRfdHlwZQogICAgVHJ1ZQogICAgPj4+IF9jb2x1bW5fdHlwZShbImZvdXIiLCAnXHUwNDNmXHUwNDRmXHUwNDQyXHUwNDRjJ10pIGlzIF90ZXh0X3R5cGUKICAgIFRydWUKICAgID4+PiBfY29sdW1uX3R5cGUoW05vbmUsICJicnV4Il0pIGlzIF90ZXh0X3R5cGUKICAgIFRydWUKICAgID4+PiBfY29sdW1uX3R5cGUoWzEsIDIsIE5vbmVdKSBpcyBfaW50X3R5cGUKICAgIFRydWUKICAgID4+PiBpbXBvcnQgZGF0ZXRpbWUgYXMgZHQKICAgID4+PiBfY29sdW1uX3R5cGUoW2R0LmRhdGV0aW1lKDE5OTEsMiwxOSksIGR0LnRpbWUoMTcsMzUpXSkgaXMgX3RleHRfdHlwZQogICAgVHJ1ZQoKICAgICIiIgogICAgdHlwZXMgPSBbX3R5cGUocywgaGFzX2ludmlzaWJsZSwgbnVtcGFyc2UpIGZvciBzIGluIHN0cmluZ3NdCiAgICByZXR1cm4gcmVkdWNlKF9tb3JlX2dlbmVyaWMsIHR5cGVzLCBfYm9vbF90eXBlKQoKCmRlZiBfZm9ybWF0KHZhbCwgdmFsdHlwZSwgZmxvYXRmbXQsIG1pc3Npbmd2YWw9IiIsIGhhc19pbnZpc2libGU9VHJ1ZSk6CiAgICAiIiJGb3JtYXQgYSB2YWx1ZSBhY2NvcmRpbmcgdG8gaXRzIHR5cGUuCgogICAgVW5pY29kZSBpcyBzdXBwb3J0ZWQ6CgogICAgPj4+IGhyb3cgPSBbJ1x1MDQzMVx1MDQ0M1x1MDQzYVx1MDQzMlx1MDQzMCcsICdcdTA0NDZcdTA0MzhcdTA0NDRcdTA0NDBcdTA0MzAnXSA7IFwKICAgICAgICB0YmwgPSBbWydcdTA0MzBcdTA0MzcnLCAyXSwgWydcdTA0MzFcdTA0NDNcdTA0M2FcdTA0MzgnLCA0XV0gOyBcCiAgICAgICAgZ29vZF9yZXN1bHQgPSAnXFx1MDQzMVxcdTA0NDNcXHUwNDNhXFx1MDQzMlxcdTA0MzAgICAgICBcXHUwNDQ2XFx1MDQzOFxcdTA0NDRcXHUwNDQwXFx1MDQzMFxcbi0tLS0tLS0gIC0tLS0tLS1cXG5cXHUwNDMwXFx1MDQzNyAgICAgICAgICAgICAyXFxuXFx1MDQzMVxcdTA0NDNcXHUwNDNhXFx1MDQzOCAgICAgICAgICAgNCcgOyBcCiAgICAgICAgdGFidWxhdGUodGJsLCBoZWFkZXJzPWhyb3cpID09IGdvb2RfcmVzdWx0CiAgICBUcnVlCgogICAgIiIiICAjIG5vcWEKICAgIGlmIHZhbCBpcyBOb25lOgogICAgICAgIHJldHVybiBtaXNzaW5ndmFsCgogICAgaWYgdmFsdHlwZSBpbiBbaW50LCBfdGV4dF90eXBlXToKICAgICAgICByZXR1cm4gInswfSIuZm9ybWF0KHZhbCkKICAgIGVsaWYgdmFsdHlwZSBpcyBfYmluYXJ5X3R5cGU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gX3RleHRfdHlwZSh2YWwsICJhc2NpaSIpCiAgICAgICAgZXhjZXB0IFR5cGVFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIF90ZXh0X3R5cGUodmFsKQogICAgZWxpZiB2YWx0eXBlIGlzIGZsb2F0OgogICAgICAgIGlzX2FfY29sb3JlZF9udW1iZXIgPSBoYXNfaW52aXNpYmxlIGFuZCBpc2luc3RhbmNlKAogICAgICAgICAgICB2YWwsIChfdGV4dF90eXBlLCBfYmluYXJ5X3R5cGUpCiAgICAgICAgKQogICAgICAgIGlmIGlzX2FfY29sb3JlZF9udW1iZXI6CiAgICAgICAgICAgIHJhd192YWwgPSBfc3RyaXBfaW52aXNpYmxlKHZhbCkKICAgICAgICAgICAgZm9ybWF0dGVkX3ZhbCA9IGZvcm1hdChmbG9hdChyYXdfdmFsKSwgZmxvYXRmbXQpCiAgICAgICAgICAgIHJldHVybiB2YWwucmVwbGFjZShyYXdfdmFsLCBmb3JtYXR0ZWRfdmFsKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBmb3JtYXQoZmxvYXQodmFsKSwgZmxvYXRmbXQpCiAgICBlbHNlOgogICAgICAgIHJldHVybiAiezB9Ii5mb3JtYXQodmFsKQoKCmRlZiBfYWxpZ25faGVhZGVyKAogICAgaGVhZGVyLCBhbGlnbm1lbnQsIHdpZHRoLCB2aXNpYmxlX3dpZHRoLCBpc19tdWx0aWxpbmU9RmFsc2UsIHdpZHRoX2ZuPU5vbmUKKToKICAgICJQYWQgc3RyaW5nIGhlYWRlciB0byB3aWR0aCBjaGFycyBnaXZlbiBrbm93biB2aXNpYmxlX3dpZHRoIG9mIHRoZSBoZWFkZXIuIgogICAgaWYgaXNfbXVsdGlsaW5lOgogICAgICAgIGhlYWRlcl9saW5lcyA9IHJlLnNwbGl0KF9tdWx0aWxpbmVfY29kZXMsIGhlYWRlcikKICAgICAgICBwYWRkZWRfbGluZXMgPSBbCiAgICAgICAgICAgIF9hbGlnbl9oZWFkZXIoaCwgYWxpZ25tZW50LCB3aWR0aCwgd2lkdGhfZm4oaCkpIGZvciBoIGluIGhlYWRlcl9saW5lcwogICAgICAgIF0KICAgICAgICByZXR1cm4gIlxuIi5qb2luKHBhZGRlZF9saW5lcykKICAgICMgZWxzZTogbm90IG11bHRpbGluZQogICAgbmludmlzaWJsZSA9IGxlbihoZWFkZXIpIC0gdmlzaWJsZV93aWR0aAogICAgd2lkdGggKz0gbmludmlzaWJsZQogICAgaWYgYWxpZ25tZW50ID09ICJsZWZ0IjoKICAgICAgICByZXR1cm4gX3BhZHJpZ2h0KHdpZHRoLCBoZWFkZXIpCiAgICBlbGlmIGFsaWdubWVudCA9PSAiY2VudGVyIjoKICAgICAgICByZXR1cm4gX3BhZGJvdGgod2lkdGgsIGhlYWRlcikKICAgIGVsaWYgbm90IGFsaWdubWVudDoKICAgICAgICByZXR1cm4gInswfSIuZm9ybWF0KGhlYWRlcikKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIF9wYWRsZWZ0KHdpZHRoLCBoZWFkZXIpCgoKZGVmIF9wcmVwZW5kX3Jvd19pbmRleChyb3dzLCBpbmRleCk6CiAgICAiIiJBZGQgYSBsZWZ0LW1vc3QgaW5kZXggY29sdW1uLiIiIgogICAgaWYgaW5kZXggaXMgTm9uZSBvciBpbmRleCBpcyBGYWxzZToKICAgICAgICByZXR1cm4gcm93cwogICAgaWYgbGVuKGluZGV4KSAhPSBsZW4ocm93cyk6CiAgICAgICAgcHJpbnQoImluZGV4PSIsIGluZGV4KQogICAgICAgIHByaW50KCJyb3dzPSIsIHJvd3MpCiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaW5kZXggbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBudW1iZXIgb2YgZGF0YSByb3dzIikKICAgIHJvd3MgPSBbW3ZdICsgbGlzdChyb3cpIGZvciB2LCByb3cgaW4gemlwKGluZGV4LCByb3dzKV0KICAgIHJldHVybiByb3dzCgoKZGVmIF9ib29sKHZhbCk6CiAgICAiQSB3cmFwcGVyIGFyb3VuZCBzdGFuZGFyZCBib29sKCkgd2hpY2ggZG9lc24ndCB0aHJvdyBvbiBOdW1QeSBhcnJheXMiCiAgICB0cnk6CiAgICAgICAgcmV0dXJuIGJvb2wodmFsKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6ICAjIHZhbCBpcyBsaWtlbHkgdG8gYmUgYSBudW1weSBhcnJheSB3aXRoIG1hbnkgZWxlbWVudHMKICAgICAgICByZXR1cm4gRmFsc2UKCgpkZWYgX25vcm1hbGl6ZV90YWJ1bGFyX2RhdGEodGFidWxhcl9kYXRhLCBoZWFkZXJzLCBzaG93aW5kZXg9ImRlZmF1bHQiKToKICAgICIiIlRyYW5zZm9ybSBhIHN1cHBvcnRlZCBkYXRhIHR5cGUgdG8gYSBsaXN0IG9mIGxpc3RzLCBhbmQgYSBsaXN0IG9mIGhlYWRlcnMuCgogICAgU3VwcG9ydGVkIHRhYnVsYXIgZGF0YSB0eXBlczoKCiAgICAqIGxpc3Qtb2YtbGlzdHMgb3IgYW5vdGhlciBpdGVyYWJsZSBvZiBpdGVyYWJsZXMKCiAgICAqIGxpc3Qgb2YgbmFtZWQgdHVwbGVzICh1c3VhbGx5IHVzZWQgd2l0aCBoZWFkZXJzPSJrZXlzIikKCiAgICAqIGxpc3Qgb2YgZGljdHMgKHVzdWFsbHkgdXNlZCB3aXRoIGhlYWRlcnM9ImtleXMiKQoKICAgICogbGlzdCBvZiBPcmRlcmVkRGljdHMgKHVzdWFsbHkgdXNlZCB3aXRoIGhlYWRlcnM9ImtleXMiKQoKICAgICogMkQgTnVtUHkgYXJyYXlzCgogICAgKiBOdW1QeSByZWNvcmQgYXJyYXlzICh1c3VhbGx5IHVzZWQgd2l0aCBoZWFkZXJzPSJrZXlzIikKCiAgICAqIGRpY3Qgb2YgaXRlcmFibGVzICh1c3VhbGx5IHVzZWQgd2l0aCBoZWFkZXJzPSJrZXlzIikKCiAgICAqIHBhbmRhcy5EYXRhRnJhbWUgKHVzdWFsbHkgdXNlZCB3aXRoIGhlYWRlcnM9ImtleXMiKQoKICAgIFRoZSBmaXJzdCByb3cgY2FuIGJlIHVzZWQgYXMgaGVhZGVycyBpZiBoZWFkZXJzPSJmaXJzdHJvdyIsCiAgICBjb2x1bW4gaW5kaWNlcyBjYW4gYmUgdXNlZCBhcyBoZWFkZXJzIGlmIGhlYWRlcnM9ImtleXMiLgoKICAgIElmIHNob3dpbmRleD0iZGVmYXVsdCIsIHNob3cgcm93IGluZGljZXMgb2YgdGhlIHBhbmRhcy5EYXRhRnJhbWUuCiAgICBJZiBzaG93aW5kZXg9ImFsd2F5cyIsIHNob3cgcm93IGluZGljZXMgZm9yIGFsbCB0eXBlcyBvZiBkYXRhLgogICAgSWYgc2hvd2luZGV4PSJuZXZlciIsIGRvbid0IHNob3cgcm93IGluZGljZXMgZm9yIGFsbCB0eXBlcyBvZiBkYXRhLgogICAgSWYgc2hvd2luZGV4IGlzIGFuIGl0ZXJhYmxlLCBzaG93IGl0cyB2YWx1ZXMgYXMgcm93IGluZGljZXMuCgogICAgIiIiCgogICAgdHJ5OgogICAgICAgIGJvb2woaGVhZGVycykKICAgICAgICBpc19oZWFkZXJzMmJvb2xfYnJva2VuID0gRmFsc2UgICMgbm9xYQogICAgZXhjZXB0IFZhbHVlRXJyb3I6ICAjIG51bXB5Lm5kYXJyYXksIHBhbmRhcy5jb3JlLmluZGV4LkluZGV4LCAuLi4KICAgICAgICBpc19oZWFkZXJzMmJvb2xfYnJva2VuID0gVHJ1ZSAgIyBub3FhCiAgICAgICAgaGVhZGVycyA9IGxpc3QoaGVhZGVycykKCiAgICBpbmRleCA9IE5vbmUKICAgIGlmIGhhc2F0dHIodGFidWxhcl9kYXRhLCAia2V5cyIpIGFuZCBoYXNhdHRyKHRhYnVsYXJfZGF0YSwgInZhbHVlcyIpOgogICAgICAgICMgZGljdC1saWtlIGFuZCBwYW5kYXMuRGF0YUZyYW1lPwogICAgICAgIGlmIGhhc2F0dHIodGFidWxhcl9kYXRhLnZhbHVlcywgIl9fY2FsbF9fIik6CiAgICAgICAgICAgICMgbGlrZWx5IGEgY29udmVudGlvbmFsIGRpY3QKICAgICAgICAgICAga2V5cyA9IHRhYnVsYXJfZGF0YS5rZXlzKCkKICAgICAgICAgICAgcm93cyA9IGxpc3QoCiAgICAgICAgICAgICAgICBpemlwX2xvbmdlc3QoKnRhYnVsYXJfZGF0YS52YWx1ZXMoKSkKICAgICAgICAgICAgKSAgIyBjb2x1bW5zIGhhdmUgdG8gYmUgdHJhbnNwb3NlZAogICAgICAgIGVsaWYgaGFzYXR0cih0YWJ1bGFyX2RhdGEsICJpbmRleCIpOgogICAgICAgICAgICAjIHZhbHVlcyBpcyBhIHByb3BlcnR5LCBoYXMgLmluZGV4ID0+IGl0J3MgbGlrZWx5IGEgcGFuZGFzLkRhdGFGcmFtZSAocGFuZGFzIDAuMTEuMCkKICAgICAgICAgICAga2V5cyA9IGxpc3QodGFidWxhcl9kYXRhKQogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICBzaG93aW5kZXggaW4gWyJkZWZhdWx0IiwgImFsd2F5cyIsIFRydWVdCiAgICAgICAgICAgICAgICBhbmQgdGFidWxhcl9kYXRhLmluZGV4Lm5hbWUgaXMgbm90IE5vbmUKICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodGFidWxhcl9kYXRhLmluZGV4Lm5hbWUsIGxpc3QpOgogICAgICAgICAgICAgICAgICAgIGtleXNbOjBdID0gdGFidWxhcl9kYXRhLmluZGV4Lm5hbWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAga2V5c1s6MF0gPSBbdGFidWxhcl9kYXRhLmluZGV4Lm5hbWVdCiAgICAgICAgICAgIHZhbHMgPSB0YWJ1bGFyX2RhdGEudmFsdWVzICAjIHZhbHVlcyBtYXRyaXggZG9lc24ndCBuZWVkIHRvIGJlIHRyYW5zcG9zZWQKICAgICAgICAgICAgIyBmb3IgRGF0YUZyYW1lcyBhZGQgYW4gaW5kZXggcGVyIGRlZmF1bHQKICAgICAgICAgICAgaW5kZXggPSBsaXN0KHRhYnVsYXJfZGF0YS5pbmRleCkKICAgICAgICAgICAgcm93cyA9IFtsaXN0KHJvdykgZm9yIHJvdyBpbiB2YWxzXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoInRhYnVsYXIgZGF0YSBkb2Vzbid0IGFwcGVhciB0byBiZSBhIGRpY3Qgb3IgYSBEYXRhRnJhbWUiKQoKICAgICAgICBpZiBoZWFkZXJzID09ICJrZXlzIjoKICAgICAgICAgICAgaGVhZGVycyA9IGxpc3QobWFwKF90ZXh0X3R5cGUsIGtleXMpKSAgIyBoZWFkZXJzIHNob3VsZCBiZSBzdHJpbmdzCgogICAgZWxzZTogICMgaXQncyBhIHVzdWFsIGFuIGl0ZXJhYmxlIG9mIGl0ZXJhYmxlcywgb3IgYSBOdW1QeSBhcnJheQogICAgICAgIHJvd3MgPSBsaXN0KHRhYnVsYXJfZGF0YSkKCiAgICAgICAgaWYgaGVhZGVycyA9PSAia2V5cyIgYW5kIG5vdCByb3dzOgogICAgICAgICAgICAjIGFuIGVtcHR5IHRhYmxlIChpc3N1ZSAjODEpCiAgICAgICAgICAgIGhlYWRlcnMgPSBbXQogICAgICAgIGVsaWYgKAogICAgICAgICAgICBoZWFkZXJzID09ICJrZXlzIgogICAgICAgICAgICBhbmQgaGFzYXR0cih0YWJ1bGFyX2RhdGEsICJkdHlwZSIpCiAgICAgICAgICAgIGFuZCBnZXRhdHRyKHRhYnVsYXJfZGF0YS5kdHlwZSwgIm5hbWVzIikKICAgICAgICApOgogICAgICAgICAgICAjIG51bXB5IHJlY29yZCBhcnJheQogICAgICAgICAgICBoZWFkZXJzID0gdGFidWxhcl9kYXRhLmR0eXBlLm5hbWVzCiAgICAgICAgZWxpZiAoCiAgICAgICAgICAgIGhlYWRlcnMgPT0gImtleXMiCiAgICAgICAgICAgIGFuZCBsZW4ocm93cykgPiAwCiAgICAgICAgICAgIGFuZCBpc2luc3RhbmNlKHJvd3NbMF0sIHR1cGxlKQogICAgICAgICAgICBhbmQgaGFzYXR0cihyb3dzWzBdLCAiX2ZpZWxkcyIpCiAgICAgICAgKToKICAgICAgICAgICAgIyBuYW1lZHR1cGxlCiAgICAgICAgICAgIGhlYWRlcnMgPSBsaXN0KG1hcChfdGV4dF90eXBlLCByb3dzWzBdLl9maWVsZHMpKQogICAgICAgIGVsaWYgbGVuKHJvd3MpID4gMCBhbmQgaGFzYXR0cihyb3dzWzBdLCAia2V5cyIpIGFuZCBoYXNhdHRyKHJvd3NbMF0sICJ2YWx1ZXMiKToKICAgICAgICAgICAgIyBkaWN0LWxpa2Ugb2JqZWN0CiAgICAgICAgICAgIHVuaXFfa2V5cyA9IHNldCgpICAjIGltcGxlbWVudHMgaGFzaGVkIGxvb2t1cAogICAgICAgICAgICBrZXlzID0gW10gICMgc3RvcmFnZSBmb3Igc2V0CiAgICAgICAgICAgIGlmIGhlYWRlcnMgPT0gImZpcnN0cm93IjoKICAgICAgICAgICAgICAgIGZpcnN0ZGljdCA9IHJvd3NbMF0gaWYgbGVuKHJvd3MpID4gMCBlbHNlIHt9CiAgICAgICAgICAgICAgICBrZXlzLmV4dGVuZChmaXJzdGRpY3Qua2V5cygpKQogICAgICAgICAgICAgICAgdW5pcV9rZXlzLnVwZGF0ZShrZXlzKQogICAgICAgICAgICAgICAgcm93cyA9IHJvd3NbMTpdCiAgICAgICAgICAgIGZvciByb3cgaW4gcm93czoKICAgICAgICAgICAgICAgIGZvciBrIGluIHJvdy5rZXlzKCk6CiAgICAgICAgICAgICAgICAgICAgIyBTYXZlIHVuaXF1ZSBpdGVtcyBpbiBpbnB1dCBvcmRlcgogICAgICAgICAgICAgICAgICAgIGlmIGsgbm90IGluIHVuaXFfa2V5czoKICAgICAgICAgICAgICAgICAgICAgICAga2V5cy5hcHBlbmQoaykKICAgICAgICAgICAgICAgICAgICAgICAgdW5pcV9rZXlzLmFkZChrKQogICAgICAgICAgICBpZiBoZWFkZXJzID09ICJrZXlzIjoKICAgICAgICAgICAgICAgIGhlYWRlcnMgPSBrZXlzCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShoZWFkZXJzLCBkaWN0KToKICAgICAgICAgICAgICAgICMgYSBkaWN0IG9mIGhlYWRlcnMgZm9yIGEgbGlzdCBvZiBkaWN0cwogICAgICAgICAgICAgICAgaGVhZGVycyA9IFtoZWFkZXJzLmdldChrLCBrKSBmb3IgayBpbiBrZXlzXQogICAgICAgICAgICAgICAgaGVhZGVycyA9IGxpc3QobWFwKF90ZXh0X3R5cGUsIGhlYWRlcnMpKQogICAgICAgICAgICBlbGlmIGhlYWRlcnMgPT0gImZpcnN0cm93IjoKICAgICAgICAgICAgICAgIGlmIGxlbihyb3dzKSA+IDA6CiAgICAgICAgICAgICAgICAgICAgaGVhZGVycyA9IFtmaXJzdGRpY3QuZ2V0KGssIGspIGZvciBrIGluIGtleXNdCiAgICAgICAgICAgICAgICAgICAgaGVhZGVycyA9IGxpc3QobWFwKF90ZXh0X3R5cGUsIGhlYWRlcnMpKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzID0gW10KICAgICAgICAgICAgZWxpZiBoZWFkZXJzOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgICAgICAgICAiaGVhZGVycyBmb3IgYSBsaXN0IG9mIGRpY3RzIGlzIG5vdCBhIGRpY3Qgb3IgYSBrZXl3b3JkIgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICByb3dzID0gW1tyb3cuZ2V0KGspIGZvciBrIGluIGtleXNdIGZvciByb3cgaW4gcm93c10KCiAgICAgICAgZWxpZiAoCiAgICAgICAgICAgIGhlYWRlcnMgPT0gImtleXMiCiAgICAgICAgICAgIGFuZCBoYXNhdHRyKHRhYnVsYXJfZGF0YSwgImRlc2NyaXB0aW9uIikKICAgICAgICAgICAgYW5kIGhhc2F0dHIodGFidWxhcl9kYXRhLCAiZmV0Y2hvbmUiKQogICAgICAgICAgICBhbmQgaGFzYXR0cih0YWJ1bGFyX2RhdGEsICJyb3djb3VudCIpCiAgICAgICAgKToKICAgICAgICAgICAgIyBQeXRob24gRGF0YWJhc2UgQVBJIGN1cnNvciBvYmplY3QgKFBFUCAwMjQ5KQogICAgICAgICAgICAjIHByaW50IHRhYnVsYXRlKGN1cnNvciwgaGVhZGVycz0na2V5cycpCiAgICAgICAgICAgIGhlYWRlcnMgPSBbY29sdW1uWzBdIGZvciBjb2x1bW4gaW4gdGFidWxhcl9kYXRhLmRlc2NyaXB0aW9uXQoKICAgICAgICBlbGlmIGhlYWRlcnMgPT0gImtleXMiIGFuZCBsZW4ocm93cykgPiAwOgogICAgICAgICAgICAjIGtleXMgYXJlIGNvbHVtbiBpbmRpY2VzCiAgICAgICAgICAgIGhlYWRlcnMgPSBsaXN0KG1hcChfdGV4dF90eXBlLCByYW5nZShsZW4ocm93c1swXSkpKSkKCiAgICAjIHRha2UgaGVhZGVycyBmcm9tIHRoZSBmaXJzdCByb3cgaWYgbmVjZXNzYXJ5CiAgICBpZiBoZWFkZXJzID09ICJmaXJzdHJvdyIgYW5kIGxlbihyb3dzKSA+IDA6CiAgICAgICAgaWYgaW5kZXggaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGhlYWRlcnMgPSBbaW5kZXhbMF1dICsgbGlzdChyb3dzWzBdKQogICAgICAgICAgICBpbmRleCA9IGluZGV4WzE6XQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGhlYWRlcnMgPSByb3dzWzBdCiAgICAgICAgaGVhZGVycyA9IGxpc3QobWFwKF90ZXh0X3R5cGUsIGhlYWRlcnMpKSAgIyBoZWFkZXJzIHNob3VsZCBiZSBzdHJpbmdzCiAgICAgICAgcm93cyA9IHJvd3NbMTpdCgogICAgaGVhZGVycyA9IGxpc3QobWFwKF90ZXh0X3R5cGUsIGhlYWRlcnMpKQogICAgcm93cyA9IGxpc3QobWFwKGxpc3QsIHJvd3MpKQoKICAgICMgYWRkIG9yIHJlbW92ZSBhbiBpbmRleCBjb2x1bW4KICAgIHNob3dpbmRleF9pc19hX3N0ciA9IHR5cGUoc2hvd2luZGV4KSBpbiBbX3RleHRfdHlwZSwgX2JpbmFyeV90eXBlXQogICAgaWYgc2hvd2luZGV4ID09ICJkZWZhdWx0IiBhbmQgaW5kZXggaXMgbm90IE5vbmU6CiAgICAgICAgcm93cyA9IF9wcmVwZW5kX3Jvd19pbmRleChyb3dzLCBpbmRleCkKICAgIGVsaWYgaXNpbnN0YW5jZShzaG93aW5kZXgsIEl0ZXJhYmxlKSBhbmQgbm90IHNob3dpbmRleF9pc19hX3N0cjoKICAgICAgICByb3dzID0gX3ByZXBlbmRfcm93X2luZGV4KHJvd3MsIGxpc3Qoc2hvd2luZGV4KSkKICAgIGVsaWYgc2hvd2luZGV4ID09ICJhbHdheXMiIG9yIChfYm9vbChzaG93aW5kZXgpIGFuZCBub3Qgc2hvd2luZGV4X2lzX2Ffc3RyKToKICAgICAgICBpZiBpbmRleCBpcyBOb25lOgogICAgICAgICAgICBpbmRleCA9IGxpc3QocmFuZ2UobGVuKHJvd3MpKSkKICAgICAgICByb3dzID0gX3ByZXBlbmRfcm93X2luZGV4KHJvd3MsIGluZGV4KQogICAgZWxpZiBzaG93aW5kZXggPT0gIm5ldmVyIiBvciAobm90IF9ib29sKHNob3dpbmRleCkgYW5kIG5vdCBzaG93aW5kZXhfaXNfYV9zdHIpOgogICAgICAgIHBhc3MKCiAgICAjIHBhZCB3aXRoIGVtcHR5IGhlYWRlcnMgZm9yIGluaXRpYWwgY29sdW1ucyBpZiBuZWNlc3NhcnkKICAgIGlmIGhlYWRlcnMgYW5kIGxlbihyb3dzKSA+IDA6CiAgICAgICAgbmhzID0gbGVuKGhlYWRlcnMpCiAgICAgICAgbmNvbHMgPSBsZW4ocm93c1swXSkKICAgICAgICBpZiBuaHMgPCBuY29sczoKICAgICAgICAgICAgaGVhZGVycyA9IFsiIl0gKiAobmNvbHMgLSBuaHMpICsgaGVhZGVycwoKICAgIHJldHVybiByb3dzLCBoZWFkZXJzCgoKZGVmIF93cmFwX3RleHRfdG9fY29sd2lkdGhzKGxpc3Rfb2ZfbGlzdHMsIGNvbHdpZHRocywgbnVtcGFyc2VzPVRydWUpOgogICAgbnVtcGFyc2VzID0gX2V4cGFuZF9pdGVyYWJsZShudW1wYXJzZXMsIGxlbihsaXN0X29mX2xpc3RzWzBdKSwgVHJ1ZSkKCiAgICByZXN1bHQgPSBbXQoKICAgIGZvciByb3cgaW4gbGlzdF9vZl9saXN0czoKICAgICAgICBuZXdfcm93ID0gW10KICAgICAgICBmb3IgY2VsbCwgd2lkdGgsIG51bXBhcnNlIGluIHppcChyb3csIGNvbHdpZHRocywgbnVtcGFyc2VzKToKICAgICAgICAgICAgaWYgX2lzbnVtYmVyKGNlbGwpIGFuZCBudW1wYXJzZToKICAgICAgICAgICAgICAgIG5ld19yb3cuYXBwZW5kKGNlbGwpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgaWYgd2lkdGggaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB3cmFwcGVyID0gX0N1c3RvbVRleHRXcmFwKHdpZHRoPXdpZHRoKQogICAgICAgICAgICAgICAgd3JhcHBlZCA9IHdyYXBwZXIud3JhcChjZWxsKQogICAgICAgICAgICAgICAgbmV3X3Jvdy5hcHBlbmQoIlxuIi5qb2luKHdyYXBwZWQpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbmV3X3Jvdy5hcHBlbmQoY2VsbCkKICAgICAgICByZXN1bHQuYXBwZW5kKG5ld19yb3cpCgogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiB0YWJ1bGF0ZSgKICAgIHRhYnVsYXJfZGF0YSwKICAgIGhlYWRlcnM9KCksCiAgICB0YWJsZWZtdD0ic2ltcGxlIiwKICAgIGZsb2F0Zm10PV9ERUZBVUxUX0ZMT0FURk1ULAogICAgbnVtYWxpZ249X0RFRkFVTFRfQUxJR04sCiAgICBzdHJhbGlnbj1fREVGQVVMVF9BTElHTiwKICAgIG1pc3Npbmd2YWw9X0RFRkFVTFRfTUlTU0lOR1ZBTCwKICAgIHNob3dpbmRleD0iZGVmYXVsdCIsCiAgICBkaXNhYmxlX251bXBhcnNlPUZhbHNlLAogICAgY29sYWxpZ249Tm9uZSwKICAgIG1heGNvbHdpZHRocz1Ob25lLAopOgogICAgIiIiRm9ybWF0IGEgZml4ZWQgd2lkdGggdGFibGUgZm9yIHByZXR0eSBwcmludGluZy4KCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoW1sxLCAyLjM0XSwgWy01NiwgIjguOTk5Il0sIFsiMiIsICIxMDAwMSJdXSkpCiAgICAtLS0gIC0tLS0tLS0tLQogICAgICAxICAgICAgMi4zNAogICAgLTU2ICAgICAgOC45OTkKICAgICAgMiAgMTAwMDEKICAgIC0tLSAgLS0tLS0tLS0tCgogICAgVGhlIGZpcnN0IHJlcXVpcmVkIGFyZ3VtZW50IChgdGFidWxhcl9kYXRhYCkgY2FuIGJlIGEKICAgIGxpc3Qtb2YtbGlzdHMgKG9yIGFub3RoZXIgaXRlcmFibGUgb2YgaXRlcmFibGVzKSwgYSBsaXN0IG9mIG5hbWVkCiAgICB0dXBsZXMsIGEgZGljdGlvbmFyeSBvZiBpdGVyYWJsZXMsIGFuIGl0ZXJhYmxlIG9mIGRpY3Rpb25hcmllcywKICAgIGEgdHdvLWRpbWVuc2lvbmFsIE51bVB5IGFycmF5LCBOdW1QeSByZWNvcmQgYXJyYXksIG9yIGEgUGFuZGFzJwogICAgZGF0YWZyYW1lLgoKCiAgICBUYWJsZSBoZWFkZXJzCiAgICAtLS0tLS0tLS0tLS0tCgogICAgVG8gcHJpbnQgbmljZSBjb2x1bW4gaGVhZGVycywgc3VwcGx5IHRoZSBzZWNvbmQgYXJndW1lbnQgKGBoZWFkZXJzYCk6CgogICAgICAtIGBoZWFkZXJzYCBjYW4gYmUgYW4gZXhwbGljaXQgbGlzdCBvZiBjb2x1bW4gaGVhZGVycwogICAgICAtIGlmIGBoZWFkZXJzPSJmaXJzdHJvdyJgLCB0aGVuIHRoZSBmaXJzdCByb3cgb2YgZGF0YSBpcyB1c2VkCiAgICAgIC0gaWYgYGhlYWRlcnM9ImtleXMiYCwgdGhlbiBkaWN0aW9uYXJ5IGtleXMgb3IgY29sdW1uIGluZGljZXMgYXJlIHVzZWQKCiAgICBPdGhlcndpc2UgYSBoZWFkZXJsZXNzIHRhYmxlIGlzIHByb2R1Y2VkLgoKICAgIElmIHRoZSBudW1iZXIgb2YgaGVhZGVycyBpcyBsZXNzIHRoYW4gdGhlIG51bWJlciBvZiBjb2x1bW5zLCB0aGV5CiAgICBhcmUgc3VwcG9zZWQgdG8gYmUgbmFtZXMgb2YgdGhlIGxhc3QgY29sdW1ucy4gVGhpcyBpcyBjb25zaXN0ZW50CiAgICB3aXRoIHRoZSBwbGFpbi10ZXh0IGZvcm1hdCBvZiBSIGFuZCBQYW5kYXMnIGRhdGFmcmFtZXMuCgogICAgPj4+IHByaW50KHRhYnVsYXRlKFtbInNleCIsImFnZSJdLFsiQWxpY2UiLCJGIiwyNF0sWyJCb2IiLCJNIiwxOV1dLAogICAgLi4uICAgICAgIGhlYWRlcnM9ImZpcnN0cm93IikpCiAgICAgICAgICAgc2V4ICAgICAgYWdlCiAgICAtLS0tLSAgLS0tLS0gIC0tLS0tCiAgICBBbGljZSAgRiAgICAgICAgIDI0CiAgICBCb2IgICAgTSAgICAgICAgIDE5CgogICAgQnkgZGVmYXVsdCwgcGFuZGFzLkRhdGFGcmFtZSBkYXRhIGhhdmUgYW4gYWRkaXRpb25hbCBjb2x1bW4gY2FsbGVkCiAgICByb3cgaW5kZXguIFRvIGFkZCBhIHNpbWlsYXIgY29sdW1uIHRvIGFsbCBvdGhlciB0eXBlcyBvZiBkYXRhLAogICAgdXNlIGBzaG93aW5kZXg9ImFsd2F5cyJgIG9yIGBzaG93aW5kZXg9VHJ1ZWAuIFRvIHN1cHByZXNzIHJvdyBpbmRpY2VzCiAgICBmb3IgYWxsIHR5cGVzIG9mIGRhdGEsIHBhc3MgYHNob3dpbmRleD0ibmV2ZXIiIG9yIGBzaG93aW5kZXg9RmFsc2VgLgogICAgVG8gYWRkIGEgY3VzdG9tIHJvdyBpbmRleCBjb2x1bW4sIHBhc3MgYHNob3dpbmRleD1zb21lX2l0ZXJhYmxlYC4KCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoW1siRiIsMjRdLFsiTSIsMTldXSwgc2hvd2luZGV4PSJhbHdheXMiKSkKICAgIC0gIC0gIC0tCiAgICAwICBGICAyNAogICAgMSAgTSAgMTkKICAgIC0gIC0gIC0tCgoKICAgIENvbHVtbiBhbGlnbm1lbnQKICAgIC0tLS0tLS0tLS0tLS0tLS0KCiAgICBgdGFidWxhdGVgIHRyaWVzIHRvIGRldGVjdCBjb2x1bW4gdHlwZXMgYXV0b21hdGljYWxseSwgYW5kIGFsaWducwogICAgdGhlIHZhbHVlcyBwcm9wZXJseS4gQnkgZGVmYXVsdCBpdCBhbGlnbnMgZGVjaW1hbCBwb2ludHMgb2YgdGhlCiAgICBudW1iZXJzIChvciBmbHVzaGVzIGludGVnZXIgbnVtYmVycyB0byB0aGUgcmlnaHQpLCBhbmQgZmx1c2hlcwogICAgZXZlcnl0aGluZyBlbHNlIHRvIHRoZSBsZWZ0LiBQb3NzaWJsZSBjb2x1bW4gYWxpZ25tZW50cwogICAgKGBudW1hbGlnbmAsIGBzdHJhbGlnbmApIGFyZTogInJpZ2h0IiwgImNlbnRlciIsICJsZWZ0IiwgImRlY2ltYWwiCiAgICAob25seSBmb3IgYG51bWFsaWduYCksIGFuZCBOb25lICh0byBkaXNhYmxlIGFsaWdubWVudCkuCgoKICAgIFRhYmxlIGZvcm1hdHMKICAgIC0tLS0tLS0tLS0tLS0KCiAgICBgZmxvYXRmbXRgIGlzIGEgZm9ybWF0IHNwZWNpZmljYXRpb24gdXNlZCBmb3IgY29sdW1ucyB3aGljaAogICAgY29udGFpbiBudW1lcmljIGRhdGEgd2l0aCBhIGRlY2ltYWwgcG9pbnQuIFRoaXMgY2FuIGFsc28gYmUKICAgIGEgbGlzdCBvciB0dXBsZSBvZiBmb3JtYXQgc3RyaW5ncywgb25lIHBlciBjb2x1bW4uCgogICAgYE5vbmVgIHZhbHVlcyBhcmUgcmVwbGFjZWQgd2l0aCBhIGBtaXNzaW5ndmFsYCBzdHJpbmcgKGxpa2UKICAgIGBmbG9hdGZtdGAsIHRoaXMgY2FuIGFsc28gYmUgYSBsaXN0IG9mIHZhbHVlcyBmb3IgZGlmZmVyZW50CiAgICBjb2x1bW5zKToKCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoW1sic3BhbSIsIDEsIE5vbmVdLAogICAgLi4uICAgICAgICAgICAgICAgICBbImVnZ3MiLCA0MiwgMy4xNF0sCiAgICAuLi4gICAgICAgICAgICAgICAgIFsib3RoZXIiLCBOb25lLCAyLjddXSwgbWlzc2luZ3ZhbD0iPyIpKQogICAgLS0tLS0gIC0tICAtLS0tCiAgICBzcGFtICAgIDEgID8KICAgIGVnZ3MgICA0MiAgMy4xNAogICAgb3RoZXIgICA/ICAyLjcKICAgIC0tLS0tICAtLSAgLS0tLQoKICAgIFZhcmlvdXMgcGxhaW4tdGV4dCB0YWJsZSBmb3JtYXRzIChgdGFibGVmbXRgKSBhcmUgc3VwcG9ydGVkOgogICAgJ3BsYWluJywgJ3NpbXBsZScsICdncmlkJywgJ3BpcGUnLCAnb3JndGJsJywgJ3JzdCcsICdtZWRpYXdpa2knLAogICAgJ2xhdGV4JywgJ2xhdGV4X3JhdycsICdsYXRleF9ib29rdGFicycsICdsYXRleF9sb25ndGFibGUnIGFuZCB0c3YuCiAgICBWYXJpYWJsZSBgdGFidWxhdGVfZm9ybWF0c2Bjb250YWlucyB0aGUgbGlzdCBvZiBjdXJyZW50bHkgc3VwcG9ydGVkIGZvcm1hdHMuCgogICAgInBsYWluIiBmb3JtYXQgZG9lc24ndCB1c2UgYW55IHBzZXVkb2dyYXBoaWNzIHRvIGRyYXcgdGFibGVzLAogICAgaXQgc2VwYXJhdGVzIGNvbHVtbnMgd2l0aCBhIGRvdWJsZSBzcGFjZToKCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoW1sic3BhbSIsIDQxLjk5OTldLCBbImVnZ3MiLCAiNDUxLjAiXV0sCiAgICAuLi4gICAgICAgICAgICAgICAgIFsic3RyaW5ncyIsICJudW1iZXJzIl0sICJwbGFpbiIpKQogICAgc3RyaW5ncyAgICAgIG51bWJlcnMKICAgIHNwYW0gICAgICAgICA0MS45OTk5CiAgICBlZ2dzICAgICAgICA0NTEKCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoW1sic3BhbSIsIDQxLjk5OTldLCBbImVnZ3MiLCAiNDUxLjAiXV0sIHRhYmxlZm10PSJwbGFpbiIpKQogICAgc3BhbSAgIDQxLjk5OTkKICAgIGVnZ3MgIDQ1MQoKICAgICJzaW1wbGUiIGZvcm1hdCBpcyBsaWtlIFBhbmRvYyBzaW1wbGVfdGFibGVzOgoKICAgID4+PiBwcmludCh0YWJ1bGF0ZShbWyJzcGFtIiwgNDEuOTk5OV0sIFsiZWdncyIsICI0NTEuMCJdXSwKICAgIC4uLiAgICAgICAgICAgICAgICAgWyJzdHJpbmdzIiwgIm51bWJlcnMiXSwgInNpbXBsZSIpKQogICAgc3RyaW5ncyAgICAgIG51bWJlcnMKICAgIC0tLS0tLS0tLSAgLS0tLS0tLS0tCiAgICBzcGFtICAgICAgICAgNDEuOTk5OQogICAgZWdncyAgICAgICAgNDUxCgogICAgPj4+IHByaW50KHRhYnVsYXRlKFtbInNwYW0iLCA0MS45OTk5XSwgWyJlZ2dzIiwgIjQ1MS4wIl1dLCB0YWJsZWZtdD0ic2ltcGxlIikpCiAgICAtLS0tICAtLS0tLS0tLQogICAgc3BhbSAgIDQxLjk5OTkKICAgIGVnZ3MgIDQ1MQogICAgLS0tLSAgLS0tLS0tLS0KCiAgICAiZ3JpZCIgaXMgc2ltaWxhciB0byB0YWJsZXMgcHJvZHVjZWQgYnkgRW1hY3MgdGFibGUuZWwgcGFja2FnZSBvcgogICAgUGFuZG9jIGdyaWRfdGFibGVzOgoKICAgID4+PiBwcmludCh0YWJ1bGF0ZShbWyJzcGFtIiwgNDEuOTk5OV0sIFsiZWdncyIsICI0NTEuMCJdXSwKICAgIC4uLiAgICAgICAgICAgICAgICBbInN0cmluZ3MiLCAibnVtYmVycyJdLCAiZ3JpZCIpKQogICAgKy0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tKwogICAgfCBzdHJpbmdzICAgfCAgIG51bWJlcnMgfAogICAgKz09PT09PT09PT09Kz09PT09PT09PT09KwogICAgfCBzcGFtICAgICAgfCAgIDQxLjk5OTkgfAogICAgKy0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tKwogICAgfCBlZ2dzICAgICAgfCAgNDUxICAgICAgfAogICAgKy0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tKwoKICAgID4+PiBwcmludCh0YWJ1bGF0ZShbWyJzcGFtIiwgNDEuOTk5OV0sIFsiZWdncyIsICI0NTEuMCJdXSwgdGFibGVmbXQ9ImdyaWQiKSkKICAgICstLS0tLS0rLS0tLS0tLS0tLSsKICAgIHwgc3BhbSB8ICA0MS45OTk5IHwKICAgICstLS0tLS0rLS0tLS0tLS0tLSsKICAgIHwgZWdncyB8IDQ1MSAgICAgIHwKICAgICstLS0tLS0rLS0tLS0tLS0tLSsKCiAgICAiZmFuY3lfZ3JpZCIgZHJhd3MgYSBncmlkIHVzaW5nIGJveC1kcmF3aW5nIGNoYXJhY3RlcnM6CgogICAgPj4+IHByaW50KHRhYnVsYXRlKFtbInNwYW0iLCA0MS45OTk5XSwgWyJlZ2dzIiwgIjQ1MS4wIl1dLAogICAgLi4uICAgICAgICAgICAgICAgIFsic3RyaW5ncyIsICJudW1iZXJzIl0sICJmYW5jeV9ncmlkIikpCiAgICDilZLilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilaTilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZUKICAgIOKUgiBzdHJpbmdzICAg4pSCICAgbnVtYmVycyDilIIKICAgIOKVnuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVquKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVoQogICAg4pSCIHNwYW0gICAgICDilIIgICA0MS45OTk5IOKUggogICAg4pSc4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pS84pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSkCiAgICDilIIgZWdncyAgICAgIOKUgiAgNDUxICAgICAg4pSCCiAgICDilZjilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilafilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZsKCiAgICAicGlwZSIgaXMgbGlrZSB0YWJsZXMgaW4gUEhQIE1hcmtkb3duIEV4dHJhIGV4dGVuc2lvbiBvciBQYW5kb2MKICAgIHBpcGVfdGFibGVzOgoKICAgID4+PiBwcmludCh0YWJ1bGF0ZShbWyJzcGFtIiwgNDEuOTk5OV0sIFsiZWdncyIsICI0NTEuMCJdXSwKICAgIC4uLiAgICAgICAgICAgICAgICBbInN0cmluZ3MiLCAibnVtYmVycyJdLCAicGlwZSIpKQogICAgfCBzdHJpbmdzICAgfCAgIG51bWJlcnMgfAogICAgfDotLS0tLS0tLS0tfC0tLS0tLS0tLS06fAogICAgfCBzcGFtICAgICAgfCAgIDQxLjk5OTkgfAogICAgfCBlZ2dzICAgICAgfCAgNDUxICAgICAgfAoKICAgICJwcmVzdG8iIGlzIGxpa2UgdGFibGVzIHByb2R1Y2UgYnkgdGhlIFByZXN0byBDTEk6CgogICAgPj4+IHByaW50KHRhYnVsYXRlKFtbInNwYW0iLCA0MS45OTk5XSwgWyJlZ2dzIiwgIjQ1MS4wIl1dLAogICAgLi4uICAgICAgICAgICAgICAgIFsic3RyaW5ncyIsICJudW1iZXJzIl0sICJwcmVzdG8iKSkKICAgICBzdHJpbmdzICAgfCAgIG51bWJlcnMKICAgIC0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tCiAgICAgc3BhbSAgICAgIHwgICA0MS45OTk5CiAgICAgZWdncyAgICAgIHwgIDQ1MQoKICAgID4+PiBwcmludCh0YWJ1bGF0ZShbWyJzcGFtIiwgNDEuOTk5OV0sIFsiZWdncyIsICI0NTEuMCJdXSwgdGFibGVmbXQ9InBpcGUiKSkKICAgIHw6LS0tLS18LS0tLS0tLS0tOnwKICAgIHwgc3BhbSB8ICA0MS45OTk5IHwKICAgIHwgZWdncyB8IDQ1MSAgICAgIHwKCiAgICAib3JndGJsIiBpcyBsaWtlIHRhYmxlcyBpbiBFbWFjcyBvcmctbW9kZSBhbmQgb3JndGJsLW1vZGUuIFRoZXkKICAgIGFyZSBzbGlnaHRseSBkaWZmZXJlbnQgZnJvbSAicGlwZSIgZm9ybWF0IGJ5IG5vdCB1c2luZyBjb2xvbnMgdG8KICAgIGRlZmluZSBjb2x1bW4gYWxpZ25tZW50LCBhbmQgdXNpbmcgYSAiKyIgc2lnbiB0byBpbmRpY2F0ZSBsaW5lCiAgICBpbnRlcnNlY3Rpb25zOgoKICAgID4+PiBwcmludCh0YWJ1bGF0ZShbWyJzcGFtIiwgNDEuOTk5OV0sIFsiZWdncyIsICI0NTEuMCJdXSwKICAgIC4uLiAgICAgICAgICAgICAgICBbInN0cmluZ3MiLCAibnVtYmVycyJdLCAib3JndGJsIikpCiAgICB8IHN0cmluZ3MgICB8ICAgbnVtYmVycyB8CiAgICB8LS0tLS0tLS0tLS0rLS0tLS0tLS0tLS18CiAgICB8IHNwYW0gICAgICB8ICAgNDEuOTk5OSB8CiAgICB8IGVnZ3MgICAgICB8ICA0NTEgICAgICB8CgoKICAgID4+PiBwcmludCh0YWJ1bGF0ZShbWyJzcGFtIiwgNDEuOTk5OV0sIFsiZWdncyIsICI0NTEuMCJdXSwgdGFibGVmbXQ9Im9yZ3RibCIpKQogICAgfCBzcGFtIHwgIDQxLjk5OTkgfAogICAgfCBlZ2dzIHwgNDUxICAgICAgfAoKICAgICJyc3QiIGlzIGxpa2UgYSBzaW1wbGUgdGFibGUgZm9ybWF0IGZyb20gcmVTdHJ1Y3R1cmVkVGV4dDsgcGxlYXNlCiAgICBub3RlIHRoYXQgcmVTdHJ1Y3R1cmVkVGV4dCBhY2NlcHRzIGFsc28gImdyaWQiIHRhYmxlczoKCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoW1sic3BhbSIsIDQxLjk5OTldLCBbImVnZ3MiLCAiNDUxLjAiXV0sCiAgICAuLi4gICAgICAgICAgICAgICAgWyJzdHJpbmdzIiwgIm51bWJlcnMiXSwgInJzdCIpKQogICAgPT09PT09PT09ICA9PT09PT09PT0KICAgIHN0cmluZ3MgICAgICBudW1iZXJzCiAgICA9PT09PT09PT0gID09PT09PT09PQogICAgc3BhbSAgICAgICAgIDQxLjk5OTkKICAgIGVnZ3MgICAgICAgIDQ1MQogICAgPT09PT09PT09ICA9PT09PT09PT0KCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoW1sic3BhbSIsIDQxLjk5OTldLCBbImVnZ3MiLCAiNDUxLjAiXV0sIHRhYmxlZm10PSJyc3QiKSkKICAgID09PT0gID09PT09PT09CiAgICBzcGFtICAgNDEuOTk5OQogICAgZWdncyAgNDUxCiAgICA9PT09ICA9PT09PT09PQoKICAgICJtZWRpYXdpa2kiIHByb2R1Y2VzIGEgdGFibGUgbWFya3VwIHVzZWQgaW4gV2lraXBlZGlhIGFuZCBvbiBvdGhlcgogICAgTWVkaWFXaWtpLWJhc2VkIHNpdGVzOgoKICAgID4+PiBwcmludCh0YWJ1bGF0ZShbWyJzdHJpbmdzIiwgIm51bWJlcnMiXSwgWyJzcGFtIiwgNDEuOTk5OV0sIFsiZWdncyIsICI0NTEuMCJdXSwKICAgIC4uLiAgICAgICAgICAgICAgICBoZWFkZXJzPSJmaXJzdHJvdyIsIHRhYmxlZm10PSJtZWRpYXdpa2kiKSkKICAgIHt8IGNsYXNzPSJ3aWtpdGFibGUiIHN0eWxlPSJ0ZXh0LWFsaWduOiBsZWZ0OyIKICAgIHwrIDwhLS0gY2FwdGlvbiAtLT4KICAgIHwtCiAgICAhIHN0cmluZ3MgICAhISBhbGlnbj0icmlnaHQifCAgIG51bWJlcnMKICAgIHwtCiAgICB8IHNwYW0gICAgICB8fCBhbGlnbj0icmlnaHQifCAgIDQxLjk5OTkKICAgIHwtCiAgICB8IGVnZ3MgICAgICB8fCBhbGlnbj0icmlnaHQifCAgNDUxCiAgICB8fQoKICAgICJodG1sIiBwcm9kdWNlcyBIVE1MIG1hcmt1cCBhcyBhbiBodG1sLmVzY2FwZSdkIHN0cgogICAgd2l0aCBhIC5fcmVwcl9odG1sXyBtZXRob2Qgc28gdGhhdCBKdXB5dGVyIExhYiBhbmQgTm90ZWJvb2sgZGlzcGxheSB0aGUgSFRNTAogICAgYW5kIGEgLnN0ciBwcm9wZXJ0eSBzbyB0aGF0IHRoZSByYXcgSFRNTCByZW1haW5zIGFjY2Vzc2libGUKICAgIHRoZSB1bnNhZmVodG1sIHRhYmxlIGZvcm1hdCBjYW4gYmUgdXNlZCBpZiBhbiB1bmVzY2FwZWQgSFRNTCBmb3JtYXQgaXMgcmVxdWlyZWQ6CgogICAgPj4+IHByaW50KHRhYnVsYXRlKFtbInN0cmluZ3MiLCAibnVtYmVycyJdLCBbInNwYW0iLCA0MS45OTk5XSwgWyJlZ2dzIiwgIjQ1MS4wIl1dLAogICAgLi4uICAgICAgICAgICAgICAgIGhlYWRlcnM9ImZpcnN0cm93IiwgdGFibGVmbXQ9Imh0bWwiKSkKICAgIDx0YWJsZT4KICAgIDx0aGVhZD4KICAgIDx0cj48dGg+c3RyaW5ncyAgPC90aD48dGggc3R5bGU9InRleHQtYWxpZ246IHJpZ2h0OyI+ICBudW1iZXJzPC90aD48L3RyPgogICAgPC90aGVhZD4KICAgIDx0Ym9keT4KICAgIDx0cj48dGQ+c3BhbSAgICAgPC90ZD48dGQgc3R5bGU9InRleHQtYWxpZ246IHJpZ2h0OyI+ICA0MS45OTk5PC90ZD48L3RyPgogICAgPHRyPjx0ZD5lZ2dzICAgICA8L3RkPjx0ZCBzdHlsZT0idGV4dC1hbGlnbjogcmlnaHQ7Ij4gNDUxICAgICA8L3RkPjwvdHI+CiAgICA8L3Rib2R5PgogICAgPC90YWJsZT4KCiAgICAibGF0ZXgiIHByb2R1Y2VzIGEgdGFidWxhciBlbnZpcm9ubWVudCBvZiBMYVRlWCBkb2N1bWVudCBtYXJrdXA6CgogICAgPj4+IHByaW50KHRhYnVsYXRlKFtbInNwYW0iLCA0MS45OTk5XSwgWyJlZ2dzIiwgIjQ1MS4wIl1dLCB0YWJsZWZtdD0ibGF0ZXgiKSkKICAgIFxcYmVnaW57dGFidWxhcn17bHJ9CiAgICBcXGhsaW5lCiAgICAgc3BhbSAmICA0MS45OTk5IFxcXFwKICAgICBlZ2dzICYgNDUxICAgICAgXFxcXAogICAgXFxobGluZQogICAgXFxlbmR7dGFidWxhcn0KCiAgICAibGF0ZXhfcmF3IiBpcyBzaW1pbGFyIHRvICJsYXRleCIsIGJ1dCBkb2Vzbid0IGVzY2FwZSBzcGVjaWFsIGNoYXJhY3RlcnMsCiAgICBzdWNoIGFzIGJhY2tzbGFzaCBhbmQgdW5kZXJzY29yZSwgc28gTGFUZVggY29tbWFuZHMgbWF5IGVtYmVkZGVkIGludG8KICAgIGNlbGxzJyB2YWx1ZXM6CgogICAgPj4+IHByaW50KHRhYnVsYXRlKFtbInNwYW0kXzkkIiwgNDEuOTk5OV0sIFsiXFxcXGVtcGh7ZWdnc30iLCAiNDUxLjAiXV0sIHRhYmxlZm10PSJsYXRleF9yYXciKSkKICAgIFxcYmVnaW57dGFidWxhcn17bHJ9CiAgICBcXGhsaW5lCiAgICAgc3BhbSRfOSQgICAgJiAgNDEuOTk5OSBcXFxcCiAgICAgXFxlbXBoe2VnZ3N9ICYgNDUxICAgICAgXFxcXAogICAgXFxobGluZQogICAgXFxlbmR7dGFidWxhcn0KCiAgICAibGF0ZXhfYm9va3RhYnMiIHByb2R1Y2VzIGEgdGFidWxhciBlbnZpcm9ubWVudCBvZiBMYVRlWCBkb2N1bWVudCBtYXJrdXAKICAgIHVzaW5nIHRoZSBib29rdGFicy5zdHkgcGFja2FnZToKCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoW1sic3BhbSIsIDQxLjk5OTldLCBbImVnZ3MiLCAiNDUxLjAiXV0sIHRhYmxlZm10PSJsYXRleF9ib29rdGFicyIpKQogICAgXFxiZWdpbnt0YWJ1bGFyfXtscn0KICAgIFxcdG9wcnVsZQogICAgIHNwYW0gJiAgNDEuOTk5OSBcXFxcCiAgICAgZWdncyAmIDQ1MSAgICAgIFxcXFwKICAgIFxcYm90dG9tcnVsZQogICAgXFxlbmR7dGFidWxhcn0KCiAgICAibGF0ZXhfbG9uZ3RhYmxlIiBwcm9kdWNlcyBhIHRhYnVsYXIgZW52aXJvbm1lbnQgdGhhdCBjYW4gc3RyZXRjaCBhbG9uZwogICAgbXVsdGlwbGUgcGFnZXMsIHVzaW5nIHRoZSBsb25ndGFibGUgcGFja2FnZSBmb3IgTGFUZVguCgogICAgPj4+IHByaW50KHRhYnVsYXRlKFtbInNwYW0iLCA0MS45OTk5XSwgWyJlZ2dzIiwgIjQ1MS4wIl1dLCB0YWJsZWZtdD0ibGF0ZXhfbG9uZ3RhYmxlIikpCiAgICBcXGJlZ2lue2xvbmd0YWJsZX17bHJ9CiAgICBcXGhsaW5lCiAgICAgc3BhbSAmICA0MS45OTk5IFxcXFwKICAgICBlZ2dzICYgNDUxICAgICAgXFxcXAogICAgXFxobGluZQogICAgXFxlbmR7bG9uZ3RhYmxlfQoKCiAgICBOdW1iZXIgcGFyc2luZwogICAgLS0tLS0tLS0tLS0tLS0KICAgIEJ5IGRlZmF1bHQsIGFueXRoaW5nIHdoaWNoIGNhbiBiZSBwYXJzZWQgYXMgYSBudW1iZXIgaXMgYSBudW1iZXIuCiAgICBUaGlzIGVuc3VyZXMgbnVtYmVycyByZXByZXNlbnRlZCBhcyBzdHJpbmdzIGFyZSBhbGlnbmVkIHByb3Blcmx5LgogICAgVGhpcyBjYW4gbGVhZCB0byB3ZWlyZCByZXN1bHRzIGZvciBwYXJ0aWN1bGFyIHN0cmluZ3Mgc3VjaCBhcwogICAgc3BlY2lmaWMgZ2l0IFNIQXMgZS5nLiAiNDI5OTJlMSIgd2lsbCBiZSBwYXJzZWQgaW50byB0aGUgbnVtYmVyCiAgICA0Mjk5MjAgYW5kIGFsaWduZWQgYXMgc3VjaC4KCiAgICBUbyBjb21wbGV0ZWx5IGRpc2FibGUgbnVtYmVyIHBhcnNpbmcgKGFuZCBhbGlnbm1lbnQpLCB1c2UKICAgIGBkaXNhYmxlX251bXBhcnNlPVRydWVgLiBGb3IgbW9yZSBmaW5lIGdyYWluZWQgY29udHJvbCwgYSBsaXN0IGNvbHVtbgogICAgaW5kaWNlcyBpcyB1c2VkIHRvIGRpc2FibGUgbnVtYmVyIHBhcnNpbmcgb25seSBvbiB0aG9zZSBjb2x1bW5zCiAgICBlLmcuIGBkaXNhYmxlX251bXBhcnNlPVswLCAyXWAgd291bGQgZGlzYWJsZSBudW1iZXIgcGFyc2luZyBvbmx5IG9uIHRoZQogICAgZmlyc3QgYW5kIHRoaXJkIGNvbHVtbnMuCgogICAgQ29sdW1uIFdpZHRocyBhbmQgQXV0byBMaW5lIFdyYXBwaW5nCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIFRhYnVsYXRlIHdpbGwsIGJ5IGRlZmF1bHQsIHNldCB0aGUgd2lkdGggb2YgZWFjaCBjb2x1bW4gdG8gdGhlIGxlbmd0aCBvZiB0aGUKICAgIGxvbmdlc3QgZWxlbWVudCBpbiB0aGF0IGNvbHVtbi4gSG93ZXZlciwgaW4gc2l0dWF0aW9ucyB3aGVyZSBmaWVsZHMgYXJlIGV4cGVjdGVkCiAgICB0byByZWFzb25hYmx5IGJlIHRvbyBsb25nIHRvIGxvb2sgZ29vZCBhcyBhIHNpbmdsZSBsaW5lLCB0YWJ1bGF0ZSBjYW4gaGVscCBhdXRvbWF0ZQogICAgd29yZCB3cmFwcGluZyBsb25nIGZpZWxkcyBmb3IgeW91LiBVc2UgdGhlIHBhcmFtZXRlciBgbWF4Y29sd2lkdGhgIHRvIHByb3ZpZGUgYQogICAgbGlzdCBvZiBtYXhpbWFsIGNvbHVtbiB3aWR0aHMKCiAgICA+Pj4gcHJpbnQodGFidWxhdGUoIFwKICAgICAgICAgIFsoJzEnLCAnSm9obiBTbWl0aCcsIFwKICAgICAgICAgICAgJ1RoaXMgaXMgYSByYXRoZXIgbG9uZyBkZXNjcmlwdGlvbiB0aGF0IG1pZ2h0IGxvb2sgYmV0dGVyIGlmIGl0IGlzIHdyYXBwZWQgYSBiaXQnKV0sIFwKICAgICAgICAgIGhlYWRlcnM9KCJJc3N1ZSBJZCIsICJBdXRob3IiLCAiRGVzY3JpcHRpb24iKSwgXAogICAgICAgICAgbWF4Y29sd2lkdGhzPVtOb25lLCBOb25lLCAzMF0sIFwKICAgICAgICAgIHRhYmxlZm10PSJncmlkIiAgXAogICAgICAgICkpCiAgICArLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKwogICAgfCAgIElzc3VlIElkIHwgQXV0aG9yICAgICB8IERlc2NyaXB0aW9uICAgICAgICAgICAgICAgICAgIHwKICAgICs9PT09PT09PT09PT0rPT09PT09PT09PT09Kz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0rCiAgICB8ICAgICAgICAgIDEgfCBKb2huIFNtaXRoIHwgVGhpcyBpcyBhIHJhdGhlciBsb25nICAgICAgICAgfAogICAgfCAgICAgICAgICAgIHwgICAgICAgICAgICB8IGRlc2NyaXB0aW9uIHRoYXQgbWlnaHQgbG9vayAgIHwKICAgIHwgICAgICAgICAgICB8ICAgICAgICAgICAgfCBiZXR0ZXIgaWYgaXQgaXMgd3JhcHBlZCBhIGJpdCB8CiAgICArLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKwoKCiAgICAiIiIKCiAgICBpZiB0YWJ1bGFyX2RhdGEgaXMgTm9uZToKICAgICAgICB0YWJ1bGFyX2RhdGEgPSBbXQogICAgbGlzdF9vZl9saXN0cywgaGVhZGVycyA9IF9ub3JtYWxpemVfdGFidWxhcl9kYXRhKAogICAgICAgIHRhYnVsYXJfZGF0YSwgaGVhZGVycywgc2hvd2luZGV4PXNob3dpbmRleAogICAgKQoKICAgIGlmIG1heGNvbHdpZHRocyBpcyBub3QgTm9uZToKICAgICAgICBudW1fY29scyA9IGxlbihsaXN0X29mX2xpc3RzWzBdKQogICAgICAgIGlmIGlzaW5zdGFuY2UobWF4Y29sd2lkdGhzLCBpbnQpOiAgIyBFeHBhbmQgc2NhbGFyIGZvciBhbGwgY29sdW1ucwogICAgICAgICAgICBtYXhjb2x3aWR0aHMgPSBfZXhwYW5kX2l0ZXJhYmxlKG1heGNvbHdpZHRocywgbnVtX2NvbHMsIG1heGNvbHdpZHRocykKICAgICAgICBlbHNlOiAgIyBJZ25vcmUgY29sIHdpZHRoIGZvciBhbnkgJ3RyYWlsaW5nJyBjb2x1bW5zCiAgICAgICAgICAgIG1heGNvbHdpZHRocyA9IF9leHBhbmRfaXRlcmFibGUobWF4Y29sd2lkdGhzLCBudW1fY29scywgTm9uZSkKCiAgICAgICAgbnVtcGFyc2VzID0gX2V4cGFuZF9udW1wYXJzZShkaXNhYmxlX251bXBhcnNlLCBudW1fY29scykKICAgICAgICBsaXN0X29mX2xpc3RzID0gX3dyYXBfdGV4dF90b19jb2x3aWR0aHMoCiAgICAgICAgICAgIGxpc3Rfb2ZfbGlzdHMsIG1heGNvbHdpZHRocywgbnVtcGFyc2VzPW51bXBhcnNlcwogICAgICAgICkKCiAgICAjIGVtcHR5IHZhbHVlcyBpbiB0aGUgZmlyc3QgY29sdW1uIG9mIFJTVCB0YWJsZXMgc2hvdWxkIGJlIGVzY2FwZWQgKGlzc3VlICM4MikKICAgICMgIiIgc2hvdWxkIGJlIGVzY2FwZWQgYXMgIlxcICIgb3IgIi4uIgogICAgaWYgdGFibGVmbXQgPT0gInJzdCI6CiAgICAgICAgbGlzdF9vZl9saXN0cywgaGVhZGVycyA9IF9yc3RfZXNjYXBlX2ZpcnN0X2NvbHVtbihsaXN0X29mX2xpc3RzLCBoZWFkZXJzKQoKICAgICMgUHJldHR5VGFibGUgZm9ybWF0dGluZyBkb2VzIG5vdCB1c2UgYW55IGV4dHJhIHBhZGRpbmcuCiAgICAjIE51bWJlcnMgYXJlIG5vdCBwYXJzZWQgYW5kIGFyZSB0cmVhdGVkIHRoZSBzYW1lIGFzIHN0cmluZ3MgZm9yIGFsaWdubWVudC4KICAgICMgQ2hlY2sgaWYgcHJldHR5IGlzIHRoZSBmb3JtYXQgYmVpbmcgdXNlZCBhbmQgb3ZlcnJpZGUgdGhlIGRlZmF1bHRzIHNvIGl0CiAgICAjIGRvZXMgbm90IGltcGFjdCBvdGhlciBmb3JtYXRzLgogICAgbWluX3BhZGRpbmcgPSBNSU5fUEFERElORwogICAgaWYgdGFibGVmbXQgPT0gInByZXR0eSI6CiAgICAgICAgbWluX3BhZGRpbmcgPSAwCiAgICAgICAgZGlzYWJsZV9udW1wYXJzZSA9IFRydWUKICAgICAgICBudW1hbGlnbiA9ICJjZW50ZXIiIGlmIG51bWFsaWduID09IF9ERUZBVUxUX0FMSUdOIGVsc2UgbnVtYWxpZ24KICAgICAgICBzdHJhbGlnbiA9ICJjZW50ZXIiIGlmIHN0cmFsaWduID09IF9ERUZBVUxUX0FMSUdOIGVsc2Ugc3RyYWxpZ24KICAgIGVsc2U6CiAgICAgICAgbnVtYWxpZ24gPSAiZGVjaW1hbCIgaWYgbnVtYWxpZ24gPT0gX0RFRkFVTFRfQUxJR04gZWxzZSBudW1hbGlnbgogICAgICAgIHN0cmFsaWduID0gImxlZnQiIGlmIHN0cmFsaWduID09IF9ERUZBVUxUX0FMSUdOIGVsc2Ugc3RyYWxpZ24KCiAgICAjIG9wdGltaXphdGlvbjogbG9vayBmb3IgQU5TSSBjb250cm9sIGNvZGVzIG9uY2UsCiAgICAjIGVuYWJsZSBzbWFydCB3aWR0aCBmdW5jdGlvbnMgb25seSBpZiBhIGNvbnRyb2wgY29kZSBpcyBmb3VuZAogICAgcGxhaW5fdGV4dCA9ICJcdCIuam9pbigKICAgICAgICBbIlx0Ii5qb2luKG1hcChfdGV4dF90eXBlLCBoZWFkZXJzKSldCiAgICAgICAgKyBbIlx0Ii5qb2luKG1hcChfdGV4dF90eXBlLCByb3cpKSBmb3Igcm93IGluIGxpc3Rfb2ZfbGlzdHNdCiAgICApCgogICAgaGFzX2ludmlzaWJsZSA9IHJlLnNlYXJjaChfaW52aXNpYmxlX2NvZGVzLCBwbGFpbl90ZXh0KQogICAgaWYgbm90IGhhc19pbnZpc2libGU6CiAgICAgICAgaGFzX2ludmlzaWJsZSA9IHJlLnNlYXJjaChfaW52aXNpYmxlX2NvZGVzX2xpbmssIHBsYWluX3RleHQpCiAgICBlbmFibGVfd2lkZWNoYXJzID0gd2N3aWR0aCBpcyBub3QgTm9uZSBhbmQgV0lERV9DSEFSU19NT0RFCiAgICBpZiAoCiAgICAgICAgbm90IGlzaW5zdGFuY2UodGFibGVmbXQsIFRhYmxlRm9ybWF0KQogICAgICAgIGFuZCB0YWJsZWZtdCBpbiBtdWx0aWxpbmVfZm9ybWF0cwogICAgICAgIGFuZCBfaXNfbXVsdGlsaW5lKHBsYWluX3RleHQpCiAgICApOgogICAgICAgIHRhYmxlZm10ID0gbXVsdGlsaW5lX2Zvcm1hdHMuZ2V0KHRhYmxlZm10LCB0YWJsZWZtdCkKICAgICAgICBpc19tdWx0aWxpbmUgPSBUcnVlCiAgICBlbHNlOgogICAgICAgIGlzX211bHRpbGluZSA9IEZhbHNlCiAgICB3aWR0aF9mbiA9IF9jaG9vc2Vfd2lkdGhfZm4oaGFzX2ludmlzaWJsZSwgZW5hYmxlX3dpZGVjaGFycywgaXNfbXVsdGlsaW5lKQoKICAgICMgZm9ybWF0IHJvd3MgYW5kIGNvbHVtbnMsIGNvbnZlcnQgbnVtZXJpYyB2YWx1ZXMgdG8gc3RyaW5ncwogICAgY29scyA9IGxpc3QoaXppcF9sb25nZXN0KCpsaXN0X29mX2xpc3RzKSkKICAgIG51bXBhcnNlcyA9IF9leHBhbmRfbnVtcGFyc2UoZGlzYWJsZV9udW1wYXJzZSwgbGVuKGNvbHMpKQogICAgY29sdHlwZXMgPSBbX2NvbHVtbl90eXBlKGNvbCwgbnVtcGFyc2U9bnApIGZvciBjb2wsIG5wIGluIHppcChjb2xzLCBudW1wYXJzZXMpXQogICAgaWYgaXNpbnN0YW5jZShmbG9hdGZtdCwgYmFzZXN0cmluZyk6ICAjIG9sZCB2ZXJzaW9uCiAgICAgICAgZmxvYXRfZm9ybWF0cyA9IGxlbihjb2xzKSAqIFsKICAgICAgICAgICAgZmxvYXRmbXQKICAgICAgICBdICAjIGp1c3QgZHVwbGljYXRlIHRoZSBzdHJpbmcgdG8gdXNlIGluIGVhY2ggY29sdW1uCiAgICBlbHNlOiAgIyBpZiBmbG9hdGZtdCBpcyBsaXN0LCB0dXBsZSBldGMgd2UgaGF2ZSBvbmUgcGVyIGNvbHVtbgogICAgICAgIGZsb2F0X2Zvcm1hdHMgPSBsaXN0KGZsb2F0Zm10KQogICAgICAgIGlmIGxlbihmbG9hdF9mb3JtYXRzKSA8IGxlbihjb2xzKToKICAgICAgICAgICAgZmxvYXRfZm9ybWF0cy5leHRlbmQoKGxlbihjb2xzKSAtIGxlbihmbG9hdF9mb3JtYXRzKSkgKiBbX0RFRkFVTFRfRkxPQVRGTVRdKQogICAgaWYgaXNpbnN0YW5jZShtaXNzaW5ndmFsLCBiYXNlc3RyaW5nKToKICAgICAgICBtaXNzaW5nX3ZhbHMgPSBsZW4oY29scykgKiBbbWlzc2luZ3ZhbF0KICAgIGVsc2U6CiAgICAgICAgbWlzc2luZ192YWxzID0gbGlzdChtaXNzaW5ndmFsKQogICAgICAgIGlmIGxlbihtaXNzaW5nX3ZhbHMpIDwgbGVuKGNvbHMpOgogICAgICAgICAgICBtaXNzaW5nX3ZhbHMuZXh0ZW5kKChsZW4oY29scykgLSBsZW4obWlzc2luZ192YWxzKSkgKiBbX0RFRkFVTFRfTUlTU0lOR1ZBTF0pCiAgICBjb2xzID0gWwogICAgICAgIFtfZm9ybWF0KHYsIGN0LCBmbF9mbXQsIG1pc3NfdiwgaGFzX2ludmlzaWJsZSkgZm9yIHYgaW4gY10KICAgICAgICBmb3IgYywgY3QsIGZsX2ZtdCwgbWlzc192IGluIHppcChjb2xzLCBjb2x0eXBlcywgZmxvYXRfZm9ybWF0cywgbWlzc2luZ192YWxzKQogICAgXQoKICAgICMgYWxpZ24gY29sdW1ucwogICAgYWxpZ25zID0gW251bWFsaWduIGlmIGN0IGluIFtpbnQsIGZsb2F0XSBlbHNlIHN0cmFsaWduIGZvciBjdCBpbiBjb2x0eXBlc10KICAgIGlmIGNvbGFsaWduIGlzIG5vdCBOb25lOgogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGNvbGFsaWduLCBJdGVyYWJsZSkKICAgICAgICBmb3IgaWR4LCBhbGlnbiBpbiBlbnVtZXJhdGUoY29sYWxpZ24pOgogICAgICAgICAgICBhbGlnbnNbaWR4XSA9IGFsaWduCiAgICBtaW53aWR0aHMgPSAoCiAgICAgICAgW3dpZHRoX2ZuKGgpICsgbWluX3BhZGRpbmcgZm9yIGggaW4gaGVhZGVyc10gaWYgaGVhZGVycyBlbHNlIFswXSAqIGxlbihjb2xzKQogICAgKQogICAgY29scyA9IFsKICAgICAgICBfYWxpZ25fY29sdW1uKGMsIGEsIG1pbncsIGhhc19pbnZpc2libGUsIGVuYWJsZV93aWRlY2hhcnMsIGlzX211bHRpbGluZSkKICAgICAgICBmb3IgYywgYSwgbWludyBpbiB6aXAoY29scywgYWxpZ25zLCBtaW53aWR0aHMpCiAgICBdCgogICAgaWYgaGVhZGVyczoKICAgICAgICAjIGFsaWduIGhlYWRlcnMgYW5kIGFkZCBoZWFkZXJzCiAgICAgICAgdF9jb2xzID0gY29scyBvciBbWyIiXV0gKiBsZW4oaGVhZGVycykKICAgICAgICB0X2FsaWducyA9IGFsaWducyBvciBbc3RyYWxpZ25dICogbGVuKGhlYWRlcnMpCiAgICAgICAgbWlud2lkdGhzID0gWwogICAgICAgICAgICBtYXgobWludywgbWF4KHdpZHRoX2ZuKGNsKSBmb3IgY2wgaW4gYykpCiAgICAgICAgICAgIGZvciBtaW53LCBjIGluIHppcChtaW53aWR0aHMsIHRfY29scykKICAgICAgICBdCiAgICAgICAgaGVhZGVycyA9IFsKICAgICAgICAgICAgX2FsaWduX2hlYWRlcihoLCBhLCBtaW53LCB3aWR0aF9mbihoKSwgaXNfbXVsdGlsaW5lLCB3aWR0aF9mbikKICAgICAgICAgICAgZm9yIGgsIGEsIG1pbncgaW4gemlwKGhlYWRlcnMsIHRfYWxpZ25zLCBtaW53aWR0aHMpCiAgICAgICAgXQogICAgICAgIHJvd3MgPSBsaXN0KHppcCgqY29scykpCiAgICBlbHNlOgogICAgICAgIG1pbndpZHRocyA9IFttYXgod2lkdGhfZm4oY2wpIGZvciBjbCBpbiBjKSBmb3IgYyBpbiBjb2xzXQogICAgICAgIHJvd3MgPSBsaXN0KHppcCgqY29scykpCgogICAgaWYgbm90IGlzaW5zdGFuY2UodGFibGVmbXQsIFRhYmxlRm9ybWF0KToKICAgICAgICB0YWJsZWZtdCA9IF90YWJsZV9mb3JtYXRzLmdldCh0YWJsZWZtdCwgX3RhYmxlX2Zvcm1hdHNbInNpbXBsZSJdKQoKICAgIHJldHVybiBfZm9ybWF0X3RhYmxlKHRhYmxlZm10LCBoZWFkZXJzLCByb3dzLCBtaW53aWR0aHMsIGFsaWducywgaXNfbXVsdGlsaW5lKQoKCmRlZiBfZXhwYW5kX251bXBhcnNlKGRpc2FibGVfbnVtcGFyc2UsIGNvbHVtbl9jb3VudCk6CiAgICAiIiIKICAgIFJldHVybiBhIGxpc3Qgb2YgYm9vbHMgb2YgbGVuZ3RoIGBjb2x1bW5fY291bnRgIHdoaWNoIGluZGljYXRlcyB3aGV0aGVyCiAgICBudW1iZXIgcGFyc2luZyBzaG91bGQgYmUgdXNlZCBvbiBlYWNoIGNvbHVtbi4KICAgIElmIGBkaXNhYmxlX251bXBhcnNlYCBpcyBhIGxpc3Qgb2YgaW5kaWNlcywgZWFjaCBvZiB0aG9zZSBpbmRpY2VzIGFyZSBGYWxzZSwKICAgIGFuZCBldmVyeXRoaW5nIGVsc2UgaXMgVHJ1ZS4KICAgIElmIGBkaXNhYmxlX251bXBhcnNlYCBpcyBhIGJvb2wsIHRoZW4gdGhlIHJldHVybmVkIGxpc3QgaXMgYWxsIHRoZSBzYW1lLgogICAgIiIiCiAgICBpZiBpc2luc3RhbmNlKGRpc2FibGVfbnVtcGFyc2UsIEl0ZXJhYmxlKToKICAgICAgICBudW1wYXJzZXMgPSBbVHJ1ZV0gKiBjb2x1bW5fY291bnQKICAgICAgICBmb3IgaW5kZXggaW4gZGlzYWJsZV9udW1wYXJzZToKICAgICAgICAgICAgbnVtcGFyc2VzW2luZGV4XSA9IEZhbHNlCiAgICAgICAgcmV0dXJuIG51bXBhcnNlcwogICAgZWxzZToKICAgICAgICByZXR1cm4gW25vdCBkaXNhYmxlX251bXBhcnNlXSAqIGNvbHVtbl9jb3VudAoKCmRlZiBfZXhwYW5kX2l0ZXJhYmxlKG9yaWdpbmFsLCBudW1fZGVzaXJlZCwgZGVmYXVsdCk6CiAgICAiIiIKICAgIEV4cGFuZHMgdGhlIGBvcmlnaW5hbGAgYXJndW1lbnQgdG8gcmV0dXJuIGEgcmV0dXJuIGEgbGlzdCBvZgogICAgbGVuZ3RoIGBudW1fZGVzaXJlZGAuIElmIGBvcmlnaW5hbGAgaXMgc2hvcnRlciB0aGFuIGBudW1fZGVzaXJlZGAsIGl0IHdpbGwKICAgIGJlIHBhZGRlZCB3aXRoIHRoZSB2YWx1ZSBpbiBgZGVmYXVsdGAuCiAgICBJZiBgb3JpZ2luYWxgIGlzIG5vdCBhIGxpc3QgdG8gYmVnaW4gd2l0aCAoaS5lLiBzY2FsYXIgdmFsdWUpIGEgbGlzdCBvZgogICAgbGVuZ3RoIGBudW1fZGVzaXJlZGAgY29tcGxldGVseSBwb3B1bGF0ZWQgd2l0aCBgZGVmYXVsdCB3aWxsIGJlIHJldHVybmVkCiAgICAiIiIKICAgIGlmIGlzaW5zdGFuY2Uob3JpZ2luYWwsIEl0ZXJhYmxlKToKICAgICAgICByZXR1cm4gb3JpZ2luYWwgKyBbZGVmYXVsdF0gKiAobnVtX2Rlc2lyZWQgLSBsZW4ob3JpZ2luYWwpKQogICAgZWxzZToKICAgICAgICByZXR1cm4gW2RlZmF1bHRdICogbnVtX2Rlc2lyZWQKCgpkZWYgX3BhZF9yb3coY2VsbHMsIHBhZGRpbmcpOgogICAgaWYgY2VsbHM6CiAgICAgICAgcGFkID0gIiAiICogcGFkZGluZwogICAgICAgIHBhZGRlZF9jZWxscyA9IFtwYWQgKyBjZWxsICsgcGFkIGZvciBjZWxsIGluIGNlbGxzXQogICAgICAgIHJldHVybiBwYWRkZWRfY2VsbHMKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGNlbGxzCgoKZGVmIF9idWlsZF9zaW1wbGVfcm93KHBhZGRlZF9jZWxscywgcm93Zm10KToKICAgICJGb3JtYXQgcm93IGFjY29yZGluZyB0byBEYXRhUm93IGZvcm1hdCB3aXRob3V0IHBhZGRpbmcuIgogICAgYmVnaW4sIHNlcCwgZW5kID0gcm93Zm10CiAgICByZXR1cm4gKGJlZ2luICsgc2VwLmpvaW4ocGFkZGVkX2NlbGxzKSArIGVuZCkucnN0cmlwKCkKCgpkZWYgX2J1aWxkX3JvdyhwYWRkZWRfY2VsbHMsIGNvbHdpZHRocywgY29sYWxpZ25zLCByb3dmbXQpOgogICAgIlJldHVybiBhIHN0cmluZyB3aGljaCByZXByZXNlbnRzIGEgcm93IG9mIGRhdGEgY2VsbHMuIgogICAgaWYgbm90IHJvd2ZtdDoKICAgICAgICByZXR1cm4gTm9uZQogICAgaWYgaGFzYXR0cihyb3dmbXQsICJfX2NhbGxfXyIpOgogICAgICAgIHJldHVybiByb3dmbXQocGFkZGVkX2NlbGxzLCBjb2x3aWR0aHMsIGNvbGFsaWducykKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIF9idWlsZF9zaW1wbGVfcm93KHBhZGRlZF9jZWxscywgcm93Zm10KQoKCmRlZiBfYXBwZW5kX2Jhc2ljX3JvdyhsaW5lcywgcGFkZGVkX2NlbGxzLCBjb2x3aWR0aHMsIGNvbGFsaWducywgcm93Zm10KToKICAgIGxpbmVzLmFwcGVuZChfYnVpbGRfcm93KHBhZGRlZF9jZWxscywgY29sd2lkdGhzLCBjb2xhbGlnbnMsIHJvd2ZtdCkpCiAgICByZXR1cm4gbGluZXMKCgpkZWYgX2FwcGVuZF9tdWx0aWxpbmVfcm93KAogICAgbGluZXMsIHBhZGRlZF9tdWx0aWxpbmVfY2VsbHMsIHBhZGRlZF93aWR0aHMsIGNvbGFsaWducywgcm93Zm10LCBwYWQKKToKICAgIGNvbHdpZHRocyA9IFt3IC0gMiAqIHBhZCBmb3IgdyBpbiBwYWRkZWRfd2lkdGhzXQogICAgY2VsbHNfbGluZXMgPSBbYy5zcGxpdGxpbmVzKCkgZm9yIGMgaW4gcGFkZGVkX211bHRpbGluZV9jZWxsc10KICAgIG5saW5lcyA9IG1heChtYXAobGVuLCBjZWxsc19saW5lcykpICAjIG51bWJlciBvZiBsaW5lcyBpbiB0aGUgcm93CiAgICAjIHZlcnRpY2FsbHkgcGFkIGNlbGxzIHdoZXJlIHNvbWUgbGluZXMgYXJlIG1pc3NpbmcKICAgIGNlbGxzX2xpbmVzID0gWwogICAgICAgIChjbCArIFsiICIgKiB3XSAqIChubGluZXMgLSBsZW4oY2wpKSkgZm9yIGNsLCB3IGluIHppcChjZWxsc19saW5lcywgY29sd2lkdGhzKQogICAgXQogICAgbGluZXNfY2VsbHMgPSBbW2NsW2ldIGZvciBjbCBpbiBjZWxsc19saW5lc10gZm9yIGkgaW4gcmFuZ2UobmxpbmVzKV0KICAgIGZvciBsbiBpbiBsaW5lc19jZWxsczoKICAgICAgICBwYWRkZWRfbG4gPSBfcGFkX3JvdyhsbiwgcGFkKQogICAgICAgIF9hcHBlbmRfYmFzaWNfcm93KGxpbmVzLCBwYWRkZWRfbG4sIGNvbHdpZHRocywgY29sYWxpZ25zLCByb3dmbXQpCiAgICByZXR1cm4gbGluZXMKCgpkZWYgX2J1aWxkX2xpbmUoY29sd2lkdGhzLCBjb2xhbGlnbnMsIGxpbmVmbXQpOgogICAgIlJldHVybiBhIHN0cmluZyB3aGljaCByZXByZXNlbnRzIGEgaG9yaXpvbnRhbCBsaW5lLiIKICAgIGlmIG5vdCBsaW5lZm10OgogICAgICAgIHJldHVybiBOb25lCiAgICBpZiBoYXNhdHRyKGxpbmVmbXQsICJfX2NhbGxfXyIpOgogICAgICAgIHJldHVybiBsaW5lZm10KGNvbHdpZHRocywgY29sYWxpZ25zKQogICAgZWxzZToKICAgICAgICBiZWdpbiwgZmlsbCwgc2VwLCBlbmQgPSBsaW5lZm10CiAgICAgICAgY2VsbHMgPSBbZmlsbCAqIHcgZm9yIHcgaW4gY29sd2lkdGhzXQogICAgICAgIHJldHVybiBfYnVpbGRfc2ltcGxlX3JvdyhjZWxscywgKGJlZ2luLCBzZXAsIGVuZCkpCgoKZGVmIF9hcHBlbmRfbGluZShsaW5lcywgY29sd2lkdGhzLCBjb2xhbGlnbnMsIGxpbmVmbXQpOgogICAgbGluZXMuYXBwZW5kKF9idWlsZF9saW5lKGNvbHdpZHRocywgY29sYWxpZ25zLCBsaW5lZm10KSkKICAgIHJldHVybiBsaW5lcwoKCmNsYXNzIEp1cHl0ZXJIVE1MU3RyKHN0cik6CiAgICAiIiJXcmFwIHRoZSBzdHJpbmcgd2l0aCBhIF9yZXByX2h0bWxfIG1ldGhvZCBzbyB0aGF0IEp1cHl0ZXIKICAgIGRpc3BsYXlzIHRoZSBIVE1MIHRhYmxlIiIiCgogICAgZGVmIF9yZXByX2h0bWxfKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmCgogICAgQHByb3BlcnR5CiAgICBkZWYgc3RyKHNlbGYpOgogICAgICAgICIiImFkZCBhIC5zdHIgcHJvcGVydHkgc28gdGhhdCB0aGUgcmF3IHN0cmluZyBpcyBzdGlsbCBhY2Nlc3NpYmxlIiIiCiAgICAgICAgcmV0dXJuIHNlbGYKCgpkZWYgX2Zvcm1hdF90YWJsZShmbXQsIGhlYWRlcnMsIHJvd3MsIGNvbHdpZHRocywgY29sYWxpZ25zLCBpc19tdWx0aWxpbmUpOgogICAgIiIiUHJvZHVjZSBhIHBsYWluLXRleHQgcmVwcmVzZW50YXRpb24gb2YgdGhlIHRhYmxlLiIiIgogICAgbGluZXMgPSBbXQogICAgaGlkZGVuID0gZm10LndpdGhfaGVhZGVyX2hpZGUgaWYgKGhlYWRlcnMgYW5kIGZtdC53aXRoX2hlYWRlcl9oaWRlKSBlbHNlIFtdCiAgICBwYWQgPSBmbXQucGFkZGluZwogICAgaGVhZGVycm93ID0gZm10LmhlYWRlcnJvdwoKICAgIHBhZGRlZF93aWR0aHMgPSBbKHcgKyAyICogcGFkKSBmb3IgdyBpbiBjb2x3aWR0aHNdCiAgICBpZiBpc19tdWx0aWxpbmU6CiAgICAgICAgcGFkX3JvdyA9IGxhbWJkYSByb3csIF86IHJvdyAgIyBub3FhIGRvIGl0IGxhdGVyLCBpbiBfYXBwZW5kX211bHRpbGluZV9yb3cKICAgICAgICBhcHBlbmRfcm93ID0gcGFydGlhbChfYXBwZW5kX211bHRpbGluZV9yb3csIHBhZD1wYWQpCiAgICBlbHNlOgogICAgICAgIHBhZF9yb3cgPSBfcGFkX3JvdwogICAgICAgIGFwcGVuZF9yb3cgPSBfYXBwZW5kX2Jhc2ljX3JvdwoKICAgIHBhZGRlZF9oZWFkZXJzID0gcGFkX3JvdyhoZWFkZXJzLCBwYWQpCiAgICBwYWRkZWRfcm93cyA9IFtwYWRfcm93KHJvdywgcGFkKSBmb3Igcm93IGluIHJvd3NdCgogICAgaWYgZm10LmxpbmVhYm92ZSBhbmQgImxpbmVhYm92ZSIgbm90IGluIGhpZGRlbjoKICAgICAgICBfYXBwZW5kX2xpbmUobGluZXMsIHBhZGRlZF93aWR0aHMsIGNvbGFsaWducywgZm10LmxpbmVhYm92ZSkKCiAgICBpZiBwYWRkZWRfaGVhZGVyczoKICAgICAgICBhcHBlbmRfcm93KGxpbmVzLCBwYWRkZWRfaGVhZGVycywgcGFkZGVkX3dpZHRocywgY29sYWxpZ25zLCBoZWFkZXJyb3cpCiAgICAgICAgaWYgZm10LmxpbmViZWxvd2hlYWRlciBhbmQgImxpbmViZWxvd2hlYWRlciIgbm90IGluIGhpZGRlbjoKICAgICAgICAgICAgX2FwcGVuZF9saW5lKGxpbmVzLCBwYWRkZWRfd2lkdGhzLCBjb2xhbGlnbnMsIGZtdC5saW5lYmVsb3doZWFkZXIpCgogICAgaWYgcGFkZGVkX3Jvd3MgYW5kIGZtdC5saW5lYmV0d2VlbnJvd3MgYW5kICJsaW5lYmV0d2VlbnJvd3MiIG5vdCBpbiBoaWRkZW46CiAgICAgICAgIyBpbml0aWFsIHJvd3Mgd2l0aCBhIGxpbmUgYmVsb3cKICAgICAgICBmb3Igcm93IGluIHBhZGRlZF9yb3dzWzotMV06CiAgICAgICAgICAgIGFwcGVuZF9yb3cobGluZXMsIHJvdywgcGFkZGVkX3dpZHRocywgY29sYWxpZ25zLCBmbXQuZGF0YXJvdykKICAgICAgICAgICAgX2FwcGVuZF9saW5lKGxpbmVzLCBwYWRkZWRfd2lkdGhzLCBjb2xhbGlnbnMsIGZtdC5saW5lYmV0d2VlbnJvd3MpCiAgICAgICAgIyB0aGUgbGFzdCByb3cgd2l0aG91dCBhIGxpbmUgYmVsb3cKICAgICAgICBhcHBlbmRfcm93KGxpbmVzLCBwYWRkZWRfcm93c1stMV0sIHBhZGRlZF93aWR0aHMsIGNvbGFsaWducywgZm10LmRhdGFyb3cpCiAgICBlbHNlOgogICAgICAgIGZvciByb3cgaW4gcGFkZGVkX3Jvd3M6CiAgICAgICAgICAgIGFwcGVuZF9yb3cobGluZXMsIHJvdywgcGFkZGVkX3dpZHRocywgY29sYWxpZ25zLCBmbXQuZGF0YXJvdykKCiAgICBpZiBmbXQubGluZWJlbG93IGFuZCAibGluZWJlbG93IiBub3QgaW4gaGlkZGVuOgogICAgICAgIF9hcHBlbmRfbGluZShsaW5lcywgcGFkZGVkX3dpZHRocywgY29sYWxpZ25zLCBmbXQubGluZWJlbG93KQoKICAgIGlmIGhlYWRlcnMgb3Igcm93czoKICAgICAgICBvdXRwdXQgPSAiXG4iLmpvaW4obGluZXMpCiAgICAgICAgaWYgZm10LmxpbmVhYm92ZSA9PSBfaHRtbF9iZWdpbl90YWJsZV93aXRob3V0X2hlYWRlcjoKICAgICAgICAgICAgcmV0dXJuIEp1cHl0ZXJIVE1MU3RyKG91dHB1dCkKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gb3V0cHV0CiAgICBlbHNlOiAgIyBhIGNvbXBsZXRlbHkgZW1wdHkgdGFibGUKICAgICAgICByZXR1cm4gIiIKCgpjbGFzcyBfQ3VzdG9tVGV4dFdyYXAodGV4dHdyYXAuVGV4dFdyYXBwZXIpOgogICAgIiIiQSBjdXN0b20gaW1wbGVtZW50YXRpb24gb2YgQ1B5dGhvbidzIHRleHR3cmFwLlRleHRXcmFwcGVyLiBUaGlzIHN1cHBvcnRzCiAgICBib3RoIHdpZGUgY2hhcmFjdGVycyAoS29yZWEsIEphcGFuZXNlLCBDaGluZXNlKSAgLSBpbmNsdWRpbmcgbWl4ZWQgc3RyaW5nLgogICAgRm9yIHRoZSBtb3N0IHBhcnQsIHRoZSBgX2hhbmRsZV9sb25nX3dvcmRgIGFuZCBgX3dyYXBfY2h1bmtzYCBmdW5jdGlvbnMgd2VyZQogICAgY29weSBwYXN0ZWQgb3V0IG9mIHRoZSBDUHl0aG9uIGJhc2VsaW5lLCBhbmQgdXBkYXRlZCB3aXRoIG91ciBjdXN0b20gbGVuZ3RoCiAgICBhbmQgbGluZSBhcHBlbmRpbmcgbG9naWMuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzZWxmLl9hY3RpdmVfY29kZXMgPSBbXQogICAgICAgIHNlbGYubWF4X2xpbmVzID0gTm9uZSAgIyBGb3IgcHl0aG9uMiBjb21wYXRpYmlsaXR5CiAgICAgICAgdGV4dHdyYXAuVGV4dFdyYXBwZXIuX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfbGVuKGl0ZW0pOgogICAgICAgICIiIkN1c3RvbSBsZW4gdGhhdCBnZXRzIGNvbnNvbGUgY29sdW1uIHdpZHRoIGZvciB3aWRlCiAgICAgICAgYW5kIG5vbi13aWRlIGNoYXJhY3RlcnMgYXMgd2VsbCBhcyBpZ25vcmVzIGNvbG9yIGNvZGVzIiIiCiAgICAgICAgc3RyaXBwZWQgPSBfc3RyaXBfaW52aXNpYmxlKGl0ZW0pCiAgICAgICAgaWYgd2N3aWR0aDoKICAgICAgICAgICAgcmV0dXJuIHdjd2lkdGgud2Nzd2lkdGgoc3RyaXBwZWQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIGxlbihzdHJpcHBlZCkKCiAgICBkZWYgX3VwZGF0ZV9saW5lcyhzZWxmLCBsaW5lcywgbmV3X2xpbmUpOgogICAgICAgICIiIkFkZHMgYSBuZXcgbGluZSB0byB0aGUgbGlzdCBvZiBsaW5lcyB0aGUgdGV4dCBpcyBiZWluZyB3cmFwcGVkIGludG8KICAgICAgICBUaGlzIGZ1bmN0aW9uIHdpbGwgYWxzbyB0cmFjayBhbnkgQU5TSSBjb2xvciBjb2RlcyBpbiB0aGlzIHN0cmluZyBhcyB3ZWxsCiAgICAgICAgYXMgYWRkIGFueSBjb2xvcnMgZnJvbSBwcmV2aW91cyBsaW5lcyBvcmRlciB0byBwcmVzZXJ2ZSB0aGUgc2FtZSBmb3JtYXR0aW5nCiAgICAgICAgYXMgYSBzaW5nbGUgdW53cmFwcGVkIHN0cmluZy4KICAgICAgICAiIiIKICAgICAgICBjb2RlX21hdGNoZXMgPSBbeCBmb3IgeCBpbiByZS5maW5kaXRlcihfaW52aXNpYmxlX2NvZGVzLCBuZXdfbGluZSldCiAgICAgICAgY29sb3JfY29kZXMgPSBbCiAgICAgICAgICAgIGNvZGUuc3RyaW5nW2NvZGUuc3BhbigpWzBdIDogY29kZS5zcGFuKClbMV1dIGZvciBjb2RlIGluIGNvZGVfbWF0Y2hlcwogICAgICAgIF0KCiAgICAgICAgIyBBZGQgY29sb3IgY29kZXMgZnJvbSBlYXJsaWVyIGluIHRoZSB1bndyYXBwZWQgbGluZSwgYW5kIHRoZW4gdHJhY2sgYW55IG5ldyBvbmVzIHdlIGFkZC4KICAgICAgICBuZXdfbGluZSA9ICIiLmpvaW4oc2VsZi5fYWN0aXZlX2NvZGVzKSArIG5ld19saW5lCgogICAgICAgIGZvciBjb2RlIGluIGNvbG9yX2NvZGVzOgogICAgICAgICAgICBpZiBjb2RlICE9IF9hbnNpX2NvbG9yX3Jlc2V0X2NvZGU6CiAgICAgICAgICAgICAgICBzZWxmLl9hY3RpdmVfY29kZXMuYXBwZW5kKGNvZGUpCiAgICAgICAgICAgIGVsc2U6ICAjIEEgc2luZ2xlIHJlc2V0IGNvZGUgcmVzZXRzIGV2ZXJ5dGhpbmcKICAgICAgICAgICAgICAgIHNlbGYuX2FjdGl2ZV9jb2RlcyA9IFtdCgogICAgICAgICMgQWx3YXlzIGVuc3VyZSBlYWNoIGxpbmUgaXMgY29sb3IgdGVybWludGVkIGlmIGFueSBjb2xvcnMgYXJlCiAgICAgICAgIyBzdGlsbCBhY3RpdmUsIG90aGVyd2lzZSBjb2xvcnMgd2lsbCBibGVlZCBpbnRvIG90aGVyIGNlbGxzIG9uIHRoZSBjb25zb2xlCiAgICAgICAgaWYgbGVuKHNlbGYuX2FjdGl2ZV9jb2RlcykgPiAwOgogICAgICAgICAgICBuZXdfbGluZSA9IG5ld19saW5lICsgX2Fuc2lfY29sb3JfcmVzZXRfY29kZQoKICAgICAgICBsaW5lcy5hcHBlbmQobmV3X2xpbmUpCgogICAgZGVmIF9oYW5kbGVfbG9uZ193b3JkKHNlbGYsIHJldmVyc2VkX2NodW5rcywgY3VyX2xpbmUsIGN1cl9sZW4sIHdpZHRoKToKICAgICAgICAiIiJfaGFuZGxlX2xvbmdfd29yZChjaHVua3MgOiBbc3RyaW5nXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJfbGluZSA6IFtzdHJpbmddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cl9sZW4gOiBpbnQsIHdpZHRoIDogaW50KQogICAgICAgIEhhbmRsZSBhIGNodW5rIG9mIHRleHQgKG1vc3QgbGlrZWx5IGEgd29yZCwgbm90IHdoaXRlc3BhY2UpIHRoYXQKICAgICAgICBpcyB0b28gbG9uZyB0byBmaXQgaW4gYW55IGxpbmUuCiAgICAgICAgIiIiCiAgICAgICAgIyBGaWd1cmUgb3V0IHdoZW4gaW5kZW50IGlzIGxhcmdlciB0aGFuIHRoZSBzcGVjaWZpZWQgd2lkdGgsIGFuZCBtYWtlCiAgICAgICAgIyBzdXJlIGF0IGxlYXN0IG9uZSBjaGFyYWN0ZXIgaXMgc3RyaXBwZWQgb2ZmIG9uIGV2ZXJ5IHBhc3MKICAgICAgICBpZiB3aWR0aCA8IDE6CiAgICAgICAgICAgIHNwYWNlX2xlZnQgPSAxCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc3BhY2VfbGVmdCA9IHdpZHRoIC0gY3VyX2xlbgoKICAgICAgICAjIElmIHdlJ3JlIGFsbG93ZWQgdG8gYnJlYWsgbG9uZyB3b3JkcywgdGhlbiBkbyBzbzogcHV0IGFzIG11Y2gKICAgICAgICAjIG9mIHRoZSBuZXh0IGNodW5rIG9udG8gdGhlIGN1cnJlbnQgbGluZSBhcyB3aWxsIGZpdC4KICAgICAgICBpZiBzZWxmLmJyZWFrX2xvbmdfd29yZHM6CiAgICAgICAgICAgICMgVGFidWxhdGUgQ3VzdG9tOiBCdWlsZCB0aGUgc3RyaW5nIHVwIHBpZWNlLWJ5LXBpZWNlIGluIG9yZGVyIHRvCiAgICAgICAgICAgICMgdGFrZSBlYWNoIGNoYXJjdGVyJ3Mgd2lkdGggaW50byBhY2NvdW50CiAgICAgICAgICAgIGNodW5rID0gcmV2ZXJzZWRfY2h1bmtzWy0xXQogICAgICAgICAgICBpID0gMQogICAgICAgICAgICB3aGlsZSBzZWxmLl9sZW4oY2h1bmtbOmldKSA8PSBzcGFjZV9sZWZ0OgogICAgICAgICAgICAgICAgaSA9IGkgKyAxCiAgICAgICAgICAgIGN1cl9saW5lLmFwcGVuZChjaHVua1s6IGkgLSAxXSkKICAgICAgICAgICAgcmV2ZXJzZWRfY2h1bmtzWy0xXSA9IGNodW5rW2kgLSAxIDpdCgogICAgICAgICMgT3RoZXJ3aXNlLCB3ZSBoYXZlIHRvIHByZXNlcnZlIHRoZSBsb25nIHdvcmQgaW50YWN0LiAgT25seSBhZGQKICAgICAgICAjIGl0IHRvIHRoZSBjdXJyZW50IGxpbmUgaWYgdGhlcmUncyBub3RoaW5nIGFscmVhZHkgdGhlcmUgLS0KICAgICAgICAjIHRoYXQgbWluaW1pemVzIGhvdyBtdWNoIHdlIHZpb2xhdGUgdGhlIHdpZHRoIGNvbnN0cmFpbnQuCiAgICAgICAgZWxpZiBub3QgY3VyX2xpbmU6CiAgICAgICAgICAgIGN1cl9saW5lLmFwcGVuZChyZXZlcnNlZF9jaHVua3MucG9wKCkpCgogICAgICAgICMgSWYgd2UncmUgbm90IGFsbG93ZWQgdG8gYnJlYWsgbG9uZyB3b3JkcywgYW5kIHRoZXJlJ3MgYWxyZWFkeQogICAgICAgICMgdGV4dCBvbiB0aGUgY3VycmVudCBsaW5lLCBkbyBub3RoaW5nLiAgTmV4dCB0aW1lIHRocm91Z2ggdGhlCiAgICAgICAgIyBtYWluIGxvb3Agb2YgX3dyYXBfY2h1bmtzKCksIHdlJ2xsIHdpbmQgdXAgaGVyZSBhZ2FpbiwgYnV0CiAgICAgICAgIyBjdXJfbGVuIHdpbGwgYmUgemVybywgc28gdGhlIG5leHQgbGluZSB3aWxsIGJlIGVudGlyZWx5CiAgICAgICAgIyBkZXZvdGVkIHRvIHRoZSBsb25nIHdvcmQgdGhhdCB3ZSBjYW4ndCBoYW5kbGUgcmlnaHQgbm93LgoKICAgIGRlZiBfd3JhcF9jaHVua3Moc2VsZiwgY2h1bmtzKToKICAgICAgICAiIiJfd3JhcF9jaHVua3MoY2h1bmtzIDogW3N0cmluZ10pIC0+IFtzdHJpbmddCiAgICAgICAgV3JhcCBhIHNlcXVlbmNlIG9mIHRleHQgY2h1bmtzIGFuZCByZXR1cm4gYSBsaXN0IG9mIGxpbmVzIG9mCiAgICAgICAgbGVuZ3RoICdzZWxmLndpZHRoJyBvciBsZXNzLiAgKElmICdicmVha19sb25nX3dvcmRzJyBpcyBmYWxzZSwKICAgICAgICBzb21lIGxpbmVzIG1heSBiZSBsb25nZXIgdGhhbiB0aGlzLikgIENodW5rcyBjb3JyZXNwb25kIHJvdWdobHkKICAgICAgICB0byB3b3JkcyBhbmQgdGhlIHdoaXRlc3BhY2UgYmV0d2VlbiB0aGVtOiBlYWNoIGNodW5rIGlzCiAgICAgICAgaW5kaXZpc2libGUgKG1vZHVsbyAnYnJlYWtfbG9uZ193b3JkcycpLCBidXQgYSBsaW5lIGJyZWFrIGNhbgogICAgICAgIGNvbWUgYmV0d2VlbiBhbnkgdHdvIGNodW5rcy4gIENodW5rcyBzaG91bGQgbm90IGhhdmUgaW50ZXJuYWwKICAgICAgICB3aGl0ZXNwYWNlOyBpZS4gYSBjaHVuayBpcyBlaXRoZXIgYWxsIHdoaXRlc3BhY2Ugb3IgYSAid29yZCIuCiAgICAgICAgV2hpdGVzcGFjZSBjaHVua3Mgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGJlZ2lubmluZyBhbmQgZW5kIG9mCiAgICAgICAgbGluZXMsIGJ1dCBhcGFydCBmcm9tIHRoYXQgd2hpdGVzcGFjZSBpcyBwcmVzZXJ2ZWQuCiAgICAgICAgIiIiCiAgICAgICAgbGluZXMgPSBbXQogICAgICAgIGlmIHNlbGYud2lkdGggPD0gMDoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiaW52YWxpZCB3aWR0aCAlciAobXVzdCBiZSA+IDApIiAlIHNlbGYud2lkdGgpCiAgICAgICAgaWYgc2VsZi5tYXhfbGluZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIHNlbGYubWF4X2xpbmVzID4gMToKICAgICAgICAgICAgICAgIGluZGVudCA9IHNlbGYuc3Vic2VxdWVudF9pbmRlbnQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGluZGVudCA9IHNlbGYuaW5pdGlhbF9pbmRlbnQKICAgICAgICAgICAgaWYgc2VsZi5fbGVuKGluZGVudCkgKyBzZWxmLl9sZW4oc2VsZi5wbGFjZWhvbGRlci5sc3RyaXAoKSkgPiBzZWxmLndpZHRoOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigicGxhY2Vob2xkZXIgdG9vIGxhcmdlIGZvciBtYXggd2lkdGgiKQoKICAgICAgICAjIEFycmFuZ2UgaW4gcmV2ZXJzZSBvcmRlciBzbyBpdGVtcyBjYW4gYmUgZWZmaWNpZW50bHkgcG9wcGVkCiAgICAgICAgIyBmcm9tIGEgc3RhY2sgb2YgY2h1Y2tzLgogICAgICAgIGNodW5rcy5yZXZlcnNlKCkKCiAgICAgICAgd2hpbGUgY2h1bmtzOgoKICAgICAgICAgICAgIyBTdGFydCB0aGUgbGlzdCBvZiBjaHVua3MgdGhhdCB3aWxsIG1ha2UgdXAgdGhlIGN1cnJlbnQgbGluZS4KICAgICAgICAgICAgIyBjdXJfbGVuIGlzIGp1c3QgdGhlIGxlbmd0aCBvZiBhbGwgdGhlIGNodW5rcyBpbiBjdXJfbGluZS4KICAgICAgICAgICAgY3VyX2xpbmUgPSBbXQogICAgICAgICAgICBjdXJfbGVuID0gMAoKICAgICAgICAgICAgIyBGaWd1cmUgb3V0IHdoaWNoIHN0YXRpYyBzdHJpbmcgd2lsbCBwcmVmaXggdGhpcyBsaW5lLgogICAgICAgICAgICBpZiBsaW5lczoKICAgICAgICAgICAgICAgIGluZGVudCA9IHNlbGYuc3Vic2VxdWVudF9pbmRlbnQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGluZGVudCA9IHNlbGYuaW5pdGlhbF9pbmRlbnQKCiAgICAgICAgICAgICMgTWF4aW11bSB3aWR0aCBmb3IgdGhpcyBsaW5lLgogICAgICAgICAgICB3aWR0aCA9IHNlbGYud2lkdGggLSBzZWxmLl9sZW4oaW5kZW50KQoKICAgICAgICAgICAgIyBGaXJzdCBjaHVuayBvbiBsaW5lIGlzIHdoaXRlc3BhY2UgLS0gZHJvcCBpdCwgdW5sZXNzIHRoaXMKICAgICAgICAgICAgIyBpcyB0aGUgdmVyeSBiZWdpbm5pbmcgb2YgdGhlIHRleHQgKGllLiBubyBsaW5lcyBzdGFydGVkIHlldCkuCiAgICAgICAgICAgIGlmIHNlbGYuZHJvcF93aGl0ZXNwYWNlIGFuZCBjaHVua3NbLTFdLnN0cmlwKCkgPT0gIiIgYW5kIGxpbmVzOgogICAgICAgICAgICAgICAgZGVsIGNodW5rc1stMV0KCiAgICAgICAgICAgIHdoaWxlIGNodW5rczoKICAgICAgICAgICAgICAgIGNodW5rX2xlbiA9IHNlbGYuX2xlbihjaHVua3NbLTFdKQoKICAgICAgICAgICAgICAgICMgQ2FuIGF0IGxlYXN0IHNxdWVlemUgdGhpcyBjaHVuayBvbnRvIHRoZSBjdXJyZW50IGxpbmUuCiAgICAgICAgICAgICAgICBpZiBjdXJfbGVuICsgY2h1bmtfbGVuIDw9IHdpZHRoOgogICAgICAgICAgICAgICAgICAgIGN1cl9saW5lLmFwcGVuZChjaHVua3MucG9wKCkpCiAgICAgICAgICAgICAgICAgICAgY3VyX2xlbiArPSBjaHVua19sZW4KCiAgICAgICAgICAgICAgICAjIE5vcGUsIHRoaXMgbGluZSBpcyBmdWxsLgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgIyBUaGUgY3VycmVudCBsaW5lIGlzIGZ1bGwsIGFuZCB0aGUgbmV4dCBjaHVuayBpcyB0b28gYmlnIHRvCiAgICAgICAgICAgICMgZml0IG9uICphbnkqIGxpbmUgKG5vdCBqdXN0IHRoaXMgb25lKS4KICAgICAgICAgICAgaWYgY2h1bmtzIGFuZCBzZWxmLl9sZW4oY2h1bmtzWy0xXSkgPiB3aWR0aDoKICAgICAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9sb25nX3dvcmQoY2h1bmtzLCBjdXJfbGluZSwgY3VyX2xlbiwgd2lkdGgpCiAgICAgICAgICAgICAgICBjdXJfbGVuID0gc3VtKG1hcChzZWxmLl9sZW4sIGN1cl9saW5lKSkKCiAgICAgICAgICAgICMgSWYgdGhlIGxhc3QgY2h1bmsgb24gdGhpcyBsaW5lIGlzIGFsbCB3aGl0ZXNwYWNlLCBkcm9wIGl0LgogICAgICAgICAgICBpZiBzZWxmLmRyb3Bfd2hpdGVzcGFjZSBhbmQgY3VyX2xpbmUgYW5kIGN1cl9saW5lWy0xXS5zdHJpcCgpID09ICIiOgogICAgICAgICAgICAgICAgY3VyX2xlbiAtPSBzZWxmLl9sZW4oY3VyX2xpbmVbLTFdKQogICAgICAgICAgICAgICAgZGVsIGN1cl9saW5lWy0xXQoKICAgICAgICAgICAgaWYgY3VyX2xpbmU6CiAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5tYXhfbGluZXMgaXMgTm9uZQogICAgICAgICAgICAgICAgICAgIG9yIGxlbihsaW5lcykgKyAxIDwgc2VsZi5tYXhfbGluZXMKICAgICAgICAgICAgICAgICAgICBvciAoCiAgICAgICAgICAgICAgICAgICAgICAgIG5vdCBjaHVua3MKICAgICAgICAgICAgICAgICAgICAgICAgb3Igc2VsZi5kcm9wX3doaXRlc3BhY2UKICAgICAgICAgICAgICAgICAgICAgICAgYW5kIGxlbihjaHVua3MpID09IDEKICAgICAgICAgICAgICAgICAgICAgICAgYW5kIG5vdCBjaHVua3NbMF0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBhbmQgY3VyX2xlbiA8PSB3aWR0aAogICAgICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgICAgICAjIENvbnZlcnQgY3VycmVudCBsaW5lIGJhY2sgdG8gYSBzdHJpbmcgYW5kIHN0b3JlIGl0IGluCiAgICAgICAgICAgICAgICAgICAgIyBsaXN0IG9mIGFsbCBsaW5lcyAocmV0dXJuIHZhbHVlKS4KICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfbGluZXMobGluZXMsIGluZGVudCArICIiLmpvaW4oY3VyX2xpbmUpKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB3aGlsZSBjdXJfbGluZToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VyX2xpbmVbLTFdLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBjdXJfbGVuICsgc2VsZi5fbGVuKHNlbGYucGxhY2Vob2xkZXIpIDw9IHdpZHRoCiAgICAgICAgICAgICAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJfbGluZS5hcHBlbmQoc2VsZi5wbGFjZWhvbGRlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9saW5lcyhsaW5lcywgaW5kZW50ICsgIiIuam9pbihjdXJfbGluZSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBjdXJfbGVuIC09IHNlbGYuX2xlbihjdXJfbGluZVstMV0pCiAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBjdXJfbGluZVstMV0KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBsaW5lczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZfbGluZSA9IGxpbmVzWy0xXS5yc3RyaXAoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2xlbihwcmV2X2xpbmUpICsgc2VsZi5fbGVuKHNlbGYucGxhY2Vob2xkZXIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPD0gc2VsZi53aWR0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lc1stMV0gPSBwcmV2X2xpbmUgKyBzZWxmLnBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2xpbmVzKGxpbmVzLCBpbmRlbnQgKyBzZWxmLnBsYWNlaG9sZGVyLmxzdHJpcCgpKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIHJldHVybiBsaW5lcwoKCmRlZiBfbWFpbigpOgogICAgIiIiXAogICAgVXNhZ2U6IHRhYnVsYXRlIFtvcHRpb25zXSBbRklMRSAuLi5dCgogICAgUHJldHR5LXByaW50IHRhYnVsYXIgZGF0YS4KICAgIFNlZSBhbHNvIGh0dHBzOi8vZ2l0aHViLmNvbS9hc3RhbmluL3B5dGhvbi10YWJ1bGF0ZQoKICAgIEZJTEUgICAgICAgICAgICAgICAgICAgICAgYSBmaWxlbmFtZSBvZiB0aGUgZmlsZSB3aXRoIHRhYnVsYXIgZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgIi0iIG9yIG1pc3NpbmcsIHJlYWQgZGF0YSBmcm9tIHN0ZGluLgoKICAgIE9wdGlvbnM6CgogICAgLWgsIC0taGVscCAgICAgICAgICAgICAgICBzaG93IHRoaXMgbWVzc2FnZQogICAgLTEsIC0taGVhZGVyICAgICAgICAgICAgICB1c2UgdGhlIGZpcnN0IHJvdyBvZiBkYXRhIGFzIGEgdGFibGUgaGVhZGVyCiAgICAtbyBGSUxFLCAtLW91dHB1dCBGSUxFICAgIHByaW50IHRhYmxlIHRvIEZJTEUgKGRlZmF1bHQ6IHN0ZG91dCkKICAgIC1zIFJFR0VYUCwgLS1zZXAgUkVHRVhQICAgdXNlIGEgY3VzdG9tIGNvbHVtbiBzZXBhcmF0b3IgKGRlZmF1bHQ6IHdoaXRlc3BhY2UpCiAgICAtRiBGUEZNVCwgLS1mbG9hdCBGUEZNVCAgIGZsb2F0aW5nIHBvaW50IG51bWJlciBmb3JtYXQgKGRlZmF1bHQ6IGcpCiAgICAtZiBGTVQsIC0tZm9ybWF0IEZNVCAgICAgIHNldCBvdXRwdXQgdGFibGUgZm9ybWF0OyBzdXBwb3J0ZWQgZm9ybWF0czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxhaW4sIHNpbXBsZSwgZ3JpZCwgZmFuY3lfZ3JpZCwgcGlwZSwgb3JndGJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByc3QsIG1lZGlhd2lraSwgaHRtbCwgbGF0ZXgsIGxhdGV4X3JhdywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGF0ZXhfYm9va3RhYnMsIGxhdGV4X2xvbmd0YWJsZSwgdHN2CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChkZWZhdWx0OiBzaW1wbGUpCiAgICAiIiIKICAgIGltcG9ydCBnZXRvcHQKICAgIGltcG9ydCBzeXMKICAgIGltcG9ydCB0ZXh0d3JhcAoKICAgIHVzYWdlID0gdGV4dHdyYXAuZGVkZW50KF9tYWluLl9fZG9jX18pCiAgICB0cnk6CiAgICAgICAgb3B0cywgYXJncyA9IGdldG9wdC5nZXRvcHQoCiAgICAgICAgICAgIHN5cy5hcmd2WzE6XSwKICAgICAgICAgICAgImgxbzpzOkY6QTpmOiIsCiAgICAgICAgICAgIFsiaGVscCIsICJoZWFkZXIiLCAib3V0cHV0IiwgInNlcD0iLCAiZmxvYXQ9IiwgImFsaWduPSIsICJmb3JtYXQ9Il0sCiAgICAgICAgKQogICAgZXhjZXB0IGdldG9wdC5HZXRvcHRFcnJvciBhcyBlOgogICAgICAgIHByaW50KGUpCiAgICAgICAgcHJpbnQodXNhZ2UpCiAgICAgICAgc3lzLmV4aXQoMikKICAgIGhlYWRlcnMgPSBbXQogICAgZmxvYXRmbXQgPSBfREVGQVVMVF9GTE9BVEZNVAogICAgY29sYWxpZ24gPSBOb25lCiAgICB0YWJsZWZtdCA9ICJzaW1wbGUiCiAgICBzZXAgPSByIlxzKyIKICAgIG91dGZpbGUgPSAiLSIKICAgIGZvciBvcHQsIHZhbHVlIGluIG9wdHM6CiAgICAgICAgaWYgb3B0IGluIFsiLTEiLCAiLS1oZWFkZXIiXToKICAgICAgICAgICAgaGVhZGVycyA9ICJmaXJzdHJvdyIKICAgICAgICBlbGlmIG9wdCBpbiBbIi1vIiwgIi0tb3V0cHV0Il06CiAgICAgICAgICAgIG91dGZpbGUgPSB2YWx1ZQogICAgICAgIGVsaWYgb3B0IGluIFsiLUYiLCAiLS1mbG9hdCJdOgogICAgICAgICAgICBmbG9hdGZtdCA9IHZhbHVlCiAgICAgICAgZWxpZiBvcHQgaW4gWyItQyIsICItLWNvbGFsaWduIl06CiAgICAgICAgICAgIGNvbGFsaWduID0gdmFsdWUuc3BsaXQoKQogICAgICAgIGVsaWYgb3B0IGluIFsiLWYiLCAiLS1mb3JtYXQiXToKICAgICAgICAgICAgaWYgdmFsdWUgbm90IGluIHRhYnVsYXRlX2Zvcm1hdHM6CiAgICAgICAgICAgICAgICBwcmludCgiJXMgaXMgbm90IGEgc3VwcG9ydGVkIHRhYmxlIGZvcm1hdCIgJSB2YWx1ZSkKICAgICAgICAgICAgICAgIHByaW50KHVzYWdlKQogICAgICAgICAgICAgICAgc3lzLmV4aXQoMykKICAgICAgICAgICAgdGFibGVmbXQgPSB2YWx1ZQogICAgICAgIGVsaWYgb3B0IGluIFsiLXMiLCAiLS1zZXAiXToKICAgICAgICAgICAgc2VwID0gdmFsdWUKICAgICAgICBlbGlmIG9wdCBpbiBbIi1oIiwgIi0taGVscCJdOgogICAgICAgICAgICBwcmludCh1c2FnZSkKICAgICAgICAgICAgc3lzLmV4aXQoMCkKICAgIGZpbGVzID0gW3N5cy5zdGRpbl0gaWYgbm90IGFyZ3MgZWxzZSBhcmdzCiAgICB3aXRoIChzeXMuc3Rkb3V0IGlmIG91dGZpbGUgPT0gIi0iIGVsc2Ugb3BlbihvdXRmaWxlLCAidyIpKSBhcyBvdXQ6CiAgICAgICAgZm9yIGYgaW4gZmlsZXM6CiAgICAgICAgICAgIGlmIGYgPT0gIi0iOgogICAgICAgICAgICAgICAgZiA9IHN5cy5zdGRpbgogICAgICAgICAgICBpZiBfaXNfZmlsZShmKToKICAgICAgICAgICAgICAgIF9wcHJpbnRfZmlsZSgKICAgICAgICAgICAgICAgICAgICBmLAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9aGVhZGVycywKICAgICAgICAgICAgICAgICAgICB0YWJsZWZtdD10YWJsZWZtdCwKICAgICAgICAgICAgICAgICAgICBzZXA9c2VwLAogICAgICAgICAgICAgICAgICAgIGZsb2F0Zm10PWZsb2F0Zm10LAogICAgICAgICAgICAgICAgICAgIGZpbGU9b3V0LAogICAgICAgICAgICAgICAgICAgIGNvbGFsaWduPWNvbGFsaWduLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGYpIGFzIGZvYmo6CiAgICAgICAgICAgICAgICAgICAgX3BwcmludF9maWxlKAogICAgICAgICAgICAgICAgICAgICAgICBmb2JqLAogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPWhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlZm10PXRhYmxlZm10LAogICAgICAgICAgICAgICAgICAgICAgICBzZXA9c2VwLAogICAgICAgICAgICAgICAgICAgICAgICBmbG9hdGZtdD1mbG9hdGZtdCwKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZT1vdXQsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGFsaWduPWNvbGFsaWduLAogICAgICAgICAgICAgICAgICAgICkKCgpkZWYgX3BwcmludF9maWxlKGZvYmplY3QsIGhlYWRlcnMsIHRhYmxlZm10LCBzZXAsIGZsb2F0Zm10LCBmaWxlLCBjb2xhbGlnbik6CiAgICByb3dzID0gZm9iamVjdC5yZWFkbGluZXMoKQogICAgdGFibGUgPSBbcmUuc3BsaXQoc2VwLCByLnJzdHJpcCgpKSBmb3IgciBpbiByb3dzIGlmIHIuc3RyaXAoKV0KICAgIHByaW50KAogICAgICAgIHRhYnVsYXRlKHRhYmxlLCBoZWFkZXJzLCB0YWJsZWZtdCwgZmxvYXRmbXQ9ZmxvYXRmbXQsIGNvbGFsaWduPWNvbGFsaWduKSwKICAgICAgICBmaWxlPWZpbGUsCiAgICApCgoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIF9tYWluKCkK')
tabulate = imp.new_module('tabulate')
exec( tabulate_s, tabulate.__dict__)

columns = [
            'count',
            't_sum',
            't_avg',
            'operation',
            'key'
            ]

backend = None

parser = argparse.ArgumentParser()
parser.add_argument("--hide", choices=['count', 't_sum','t_avg','key'], nargs='+', help="Hide specified column")
parser.add_argument("--log", choices=["http", "duration", "all"], default="all", help="Log to analayse")
parser.add_argument("--sort", choices=columns + ['D'+c for c in columns], default='count', help="Sort criteria.")
parser.add_argument("--groupby", choices=['bucket'], default='bucket', help="Goruping by criteria")
parser.add_argument("--min", type=float, default=0, help="Duration below this time will be omitted")
parser.add_argument("--operation", choices=['bind', 'add', 'modify', 'lookup', 'search', 'delete', 'delete_search', 'delete_tree'], default=['bind', 'add', 'modify', 'lookup', 'search', 'delete', 'delete_search', 'delete_tree'], nargs='+', help="Database operations to include")

parser.add_argument("--type", choices=["csv", "html", "text"], default="text", help="Output type")

parser.add_argument("dir", help="Path to log dir or file")

args = parser.parse_args()

if not args.dir:
    args.print_help()
    sys.exit()

def sort_result(result):

    descending = False
    order_by = args.sort

    if order_by[0] == 'D':
        order_by = order_by[1:]
        descending = True

    result.sort(key=lambda mydic: mydic[order_by])

    if descending:
        result.reverse()

def get_formatted_str(v):
    if type(v) == type(1):
        return str(v).rjust(8)
    elif type(v) == type(1.1):
        return '{:0.3f}'.format(v).rjust(8)
    else:
        return v

def is_hidden(c):
    if args.hide and c in args.hide:
        return True

def print_result(result, k, heading):

    columnsl = columns[:]
    #columnsl.remove('operation')
    if backend in ('sql', 'spanner'):
        columnsl.insert(-1, 'table')
    sort_result(result)

    display_columns = []
    for c in columnsl:
        if not is_hidden(c):
            display_columns.append(c)

    tbl_data = []
    for d in result:
        row = []
        for c in display_columns:
            row.append(d[c])
        tbl_data.append(row)

    tablefmt = 'html' if args.type == 'html' else None

    footer = {'count':0, 't_sum':0, 't_avg':0}

    for ln, row in enumerate(result):
        for c in columnsl:
            if c in footer and not is_hidden(c):
                footer[c] += row[c]

    footer['t_avg'] = footer['t_avg'] / len(result)
    tbl_data.append(['', footer['t_sum'], footer['t_avg'], 'GRANT TOTAL'])

    print(tabulate.tabulate(tbl_data, display_columns, tablefmt))



def http_log():

    if os.path.isdir(args.dir):
        fn = os.path.join(args.dir, 'http_request_response.log')
        if not os.path.exists(fn):
            print("File {0} does not exists".format(fn))
            return
    else:
        fn = args.dir
        if not os.path.isfile(args.dir):
            print("File {0} does not exists".format(fn))
            return

    if not 'http' in fn:
        return

    rdict = {}

    for l in open(fn):
        ls = l.strip().split(' - ')
        data = json.loads(ls[-1])
        if data.get('method') == 'GET':
            if data.get('duration'):
                d = float(data['duration'][2:-1])
                if d > args.min:
                    if data['path'] in rdict:
                        rdict[data['path']].append(d)
                    else:
                        rdict[data['path']] = [d]

    if not rdict:
        print("\n *** NO HTTP LOG ANALYSES IS AVAILABLE ***")
        return

    sn = 0
    st = 0

    result=[]

    for path in rdict:
        data = rdict[path]
        n = len(data)
        ssn = str(n).rjust(5)
        sn += n
        t = sum(data)
        st += t
        a= t/n

        result.append({'count': n, 't_sum': t, 't_avg': a, 'key': path})

    print_result(result, 'path', "HTTP REQUEST LOG ANALYSES")


def durations():
    global backend

    if os.path.isdir(args.dir):
        fn = os.path.join(args.dir, 'jans-auth_persistence_duration.log')
        if not os.path.exists(fn):
            print("File {0} does not exists".format(fn))
            return
    else:
        fn = args.dir
        if not os.path.isfile(args.dir):
            print("File {0} does not exists".format(fn))
            return

    rdict = {}
    operations = {}
    buckets = {}

    for i, l in enumerate(open(fn)):
        ndash = l.find(' - ')
        la = l[ndash+3:]
        nsp = la.find(' ')
        backend = la[:nsp].strip().lower()

        la = la[nsp:].strip()
        ls = la.split(',')

        cols = {}
        for _ in ls:
            tmp_ = _.strip().split(':')
            if len(tmp_) == 2:
                cols[tmp_[0].strip()] = tmp_[1].strip()


        if not 'operation' in cols:
            continue

        operation = cols['operation']

        if backend == 'couchbase':
            bucket = ls[3].strip()[8:]

            if not bucket in buckets:
                buckets[bucket] = []

        if not cols['operation'] in args.operation:
            continue

        #ds = ls[2].strip()[12:-1]
        ds = cols['duration'][2:-1]
        if 'M' in ds:
            m,s=ds.split('M')
            d= float(m)*60 + float(s)
        else:
            d = float(ds)

        if d > args.min:
            #ls = l.strip().split(',')
            if len(ls)>5:
                p = ls[4].strip()
            else:
                p = ls[3].strip()

            if p in rdict:
                rdict[p].append(d)
            else:
                rdict[p] = [d]

            operations[p] = operation

    if args.groupby == 'bucket':
        print("Grouped by", args.groupby)

    sn = 0
    st = 0

    result = []

    for path in rdict:

        data = rdict[path]
        n = len(data)
        sn += n
        t = sum(data)
        a = t/n
        result.append({'count': n, 't_sum': t, 't_avg': a, 'key': path, 'table': cols.get('table'), 'operation': operations[path]})

        st += t

    print_result(result, "expression", "DURATIONS LOG ANALYSES")


if args.type == 'html':
    print('<!DOCTYPE html>\n<html>\n<head>')
    print('<style>table, th, td {padding-right:10px; padding-left:10px; border: 1px solid black; border-collapse: collapse;} * {font-family: Arial, Helvetica, sans-serif;}</style>')
    print('</head>\n<body>\n')

if args.log in ('duration', 'all'):
    durations()

if args.log in ('http', 'all'):
    http_log()

if args.type == 'html':
    print('\n</body>\n</html>')
